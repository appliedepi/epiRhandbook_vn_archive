<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>23 Chuỗi thời gian và phát hiện ổ dịch | Cẩm nang dịch tễ học với R</title>
<meta name="author" content="the handbook team">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.6.4/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.16/datatables.js"></script><link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet">
<script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.0.0/tabwid.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.0.3/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.6.1/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.9.2.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script><link href="libs/vis-4.20.1/vis.css" rel="stylesheet">
<script src="libs/vis-4.20.1/vis.min.js"></script><script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-1.52.2/plotly-basic-1.52.2.min.js"></script><script src="libs/plotly-cartesian-1.52.2/plotly-cartesian-1.52.2.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-8.1.2/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-8.1.2/highcharts.js"></script><script src="libs/highcharts-8.1.2/highcharts-3d.js"></script><script src="libs/highcharts-8.1.2/highcharts-more.js"></script><script src="libs/highcharts-8.1.2/modules/stock.js"></script><script src="libs/highcharts-8.1.2/modules/map.js"></script><script src="libs/highcharts-8.1.2/modules/annotations.js"></script><script src="libs/highcharts-8.1.2/modules/data.js"></script><script src="libs/highcharts-8.1.2/modules/drilldown.js"></script><script src="libs/highcharts-8.1.2/modules/item-series.js"></script><script src="libs/highcharts-8.1.2/modules/offline-exporting.js"></script><script src="libs/highcharts-8.1.2/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-8.1.2/modules/exporting.js"></script><script src="libs/highcharts-8.1.2/modules/export-data.js"></script><script src="libs/highcharts-8.1.2/modules/funnel.js"></script><script src="libs/highcharts-8.1.2/modules/heatmap.js"></script><script src="libs/highcharts-8.1.2/modules/treemap.js"></script><script src="libs/highcharts-8.1.2/modules/sankey.js"></script><script src="libs/highcharts-8.1.2/modules/dependency-wheel.js"></script><script src="libs/highcharts-8.1.2/modules/organization.js"></script><script src="libs/highcharts-8.1.2/modules/solid-gauge.js"></script><script src="libs/highcharts-8.1.2/modules/streamgraph.js"></script><script src="libs/highcharts-8.1.2/modules/sunburst.js"></script><script src="libs/highcharts-8.1.2/modules/vector.js"></script><script src="libs/highcharts-8.1.2/modules/wordcloud.js"></script><script src="libs/highcharts-8.1.2/modules/xrange.js"></script><script src="libs/highcharts-8.1.2/modules/tilemap.js"></script><script src="libs/highcharts-8.1.2/modules/venn.js"></script><script src="libs/highcharts-8.1.2/modules/gantt.js"></script><script src="libs/highcharts-8.1.2/modules/timeline.js"></script><script src="libs/highcharts-8.1.2/modules/parallel-coordinates.js"></script><script src="libs/highcharts-8.1.2/modules/bullet.js"></script><script src="libs/highcharts-8.1.2/modules/coloraxis.js"></script><script src="libs/highcharts-8.1.2/modules/dumbbell.js"></script><script src="libs/highcharts-8.1.2/modules/lollipop.js"></script><script src="libs/highcharts-8.1.2/modules/series-label.js"></script><script src="libs/highcharts-8.1.2/plugins/motion.js"></script><script src="libs/highcharts-8.1.2/custom/reset.js"></script><script src="libs/highcharts-8.1.2/modules/boost.js"></script><script src="libs/highchart-binding-0.8.2/highchart.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS --><link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Cẩm nang dịch tễ học với R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">Về cuốn sách này</li>
<li><a class="" href="editorial-style.html"><span class="header-section-number">1</span> Biên tập và ghi chú kỹ thuật</a></li>
<li><a class="" href="data-used.html"><span class="header-section-number">2</span> Tải sách và dữ liệu</a></li>
<li class="book-part">Nhập môn về R</li>
<li><a class="" href="basics.html"><span class="header-section-number">3</span> R Cơ bản</a></li>
<li><a class="" href="transition-to-R.html"><span class="header-section-number">4</span> Chuyển đổi sang R</a></li>
<li><a class="" href="packages-suggested.html"><span class="header-section-number">5</span> Package đề xuất</a></li>
<li><a class="" href="r-projects.html"><span class="header-section-number">6</span> Dự án R</a></li>
<li><a class="" href="importing.html"><span class="header-section-number">7</span> Nhập xuất dữ liệu</a></li>
<li class="book-part">Quản lý dữ liệu</li>
<li><a class="" href="cleaning.html"><span class="header-section-number">8</span> Làm sạch số liệu và các hàm quan trọng</a></li>
<li><a class="" href="dates.html"><span class="header-section-number">9</span> Làm việc với ngày tháng</a></li>
<li><a class="" href="characters-strings.html"><span class="header-section-number">10</span> Ký tự và chuỗi</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> Factors</a></li>
<li><a class="" href="pivoting.html"><span class="header-section-number">12</span> Xoay trục dữ liệu</a></li>
<li><a class="" href="grouping.html"><span class="header-section-number">13</span> Nhóm dữ liệu</a></li>
<li><a class="" href="joining-matching.html"><span class="header-section-number">14</span> Nối dữ liệu</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> Loại bỏ trùng lặp</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> Lặp, vòng lặp, và danh sách</a></li>
<li class="book-part">Phân tích dữ liệu</li>
<li><a class="" href="tables-descriptive.html"><span class="header-section-number">17</span> Bảng mô tả</a></li>
<li><a class="" href="stat-tests.html"><span class="header-section-number">18</span> Các kiểm định thống kê cơ bản</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> Hồi quy đơn và đa biến</a></li>
<li><a class="" href="missing-data.html"><span class="header-section-number">20</span> Dữ liệu Missing</a></li>
<li><a class="" href="standardization.html"><span class="header-section-number">21</span> Tỷ suất chuẩn hóa</a></li>
<li><a class="" href="moving-average.html"><span class="header-section-number">22</span> Đường trung bình động</a></li>
<li><a class="active" href="time-series.html"><span class="header-section-number">23</span> Chuỗi thời gian và phát hiện ổ dịch</a></li>
<li><a class="" href="epidemic-models.html"><span class="header-section-number">24</span> Mô hình hóa dịch bệnh</a></li>
<li><a class="" href="contact-tracing.html"><span class="header-section-number">25</span> Truy vết tiếp xúc</a></li>
<li><a class="" href="survey-analysis.html"><span class="header-section-number">26</span> Phân tích khảo sát</a></li>
<li><a class="" href="survival-analysis.html"><span class="header-section-number">27</span> Phân tích sống còn</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS cơ bản</a></li>
<li class="book-part">Trực quan hóa dữ liệu</li>
<li><a class="" href="tables-presentation.html"><span class="header-section-number">29</span> Trình bày bảng</a></li>
<li><a class="" href="ggplot-basics.html"><span class="header-section-number">30</span> ggplot cơ bản</a></li>
<li><a class="" href="ggplot-tips.html"><span class="header-section-number">31</span> Các tips với ggplot</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> Đường cong dịch bệnh</a></li>
<li><a class="" href="age-pyramid.html"><span class="header-section-number">33</span> Tháp dân số và thang đo Likert</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> Biểu đồ nhiệt</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> Sơ đồ và biểu đồ</a></li>
<li><a class="" href="combination-analysis.html"><span class="header-section-number">36</span> Biểu đồ kết hợp</a></li>
<li><a class="" href="transmission-chains.html"><span class="header-section-number">37</span> Chuỗi lây nhiễm</a></li>
<li><a class="" href="phylogenetic-trees.html"><span class="header-section-number">38</span> Cây phả hệ</a></li>
<li><a class="" href="interactive-plots.html"><span class="header-section-number">39</span> Biểu đồ tương tác</a></li>
<li class="book-part">Báo cáo và dashboards</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> Báo cáo với R Markdown</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> Tổ chức báo cáo định kỳ</a></li>
<li><a class="" href="flexdashboard.html"><span class="header-section-number">42</span> Dashboards với R Markdown</a></li>
<li><a class="" href="shiny-basics.html"><span class="header-section-number">43</span> Dashboards với Shiny</a></li>
<li class="book-part">Tổng hợp</li>
<li><a class="" href="writing-functions.html"><span class="header-section-number">44</span> Viết hàm</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> Tương tác với thư mục làm việc</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Version control với Git và Github</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> Các lỗi thường gặp</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> Nhờ sự trợ giúp</a></li>
<li><a class="" href="network-drives.html"><span class="header-section-number">49</span> R trên ổ cứng mạng</a></li>
<li><a class="" href="data-table.html"><span class="header-section-number">50</span> Data Table</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="time-series" class="section level1" number="23">
<h1>
<span class="header-section-number">23</span> Chuỗi thời gian và phát hiện ổ dịch<a class="anchor" aria-label="anchor" href="#time-series"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="tổng-quan-2" class="section level2" number="23.1">
<h2>
<span class="header-section-number">23.1</span> Tổng quan<a class="anchor" aria-label="anchor" href="#t%E1%BB%95ng-quan-2"><i class="fas fa-link"></i></a>
</h2>
<p>Chương này minh họa cách sử dụng của một số packages cho phân tích chuỗi thời gian. Các packages chủ yếu đến từ hệ sinh thái <a href="https://tidyverts.org/"><strong>tidyverts</strong></a>, ngoài ra cũng sử dụng RECON <a href="https://github.com/reconhub/trending"><strong>trending</strong></a> package để fit các mô hình dịch tễ học bệnh truyền nhiễm.</p>
<p>VÍ dụ dưới đây chúng ta sẽ sử dụng bộ dữ liệu về Campylobacter ở Germanywe thuộc package <strong>surveillance</strong> (xem chương <a href="data-used.html#data-used">Tải sách và dữ liệu</a> để biết thêm chi tiết). Tuy nhiên, nếu bạn muốn thử chạy code này trên bộ dữ liệu lớn hơn (nhiều quốc gia hoặc tầng), bạn có thể tham khảo code mẫu tại <a href="https://github.com/R4EPI/epitsa">repo github của r4epis</a>.</p>
<p>Các chủ đề được đề cập bao gồm:</p>
<ol style="list-style-type: decimal">
<li>Dữ liệu chuỗi thời gian</li>
<li>Phân tích mô tả</li>
<li>Fitting đường hồi quy</li>
<li>Mối liên hệ của hai chuỗi thời gian</li>
<li>Phát hiện dịch bệnh</li>
<li>Chuỗi thời gian bị gián đoạn</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="chuẩn-bị-13" class="section level2" number="23.2">
<h2>
<span class="header-section-number">23.2</span> Chuẩn bị<a class="anchor" aria-label="anchor" href="#chu%E1%BA%A9n-b%E1%BB%8B-13"><i class="fas fa-link"></i></a>
</h2>
<div id="packages-1" class="section level3 unnumbered">
<h3>Packages<a class="anchor" aria-label="anchor" href="#packages-1"><i class="fas fa-link"></i></a>
</h3>
<p>Đoạn code này hiển thị việc gọi các package cần thiết cho các phân tích. Trong cuốn sách này, chúng tôi nhấn mạnh việc sử dụng hàm <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> từ package <strong>pacman</strong>, giúp cài đặt các package cần thiết <em>và</em> gọi chúng ra để sử dụng. Bạn cũng có thể gọi các packages đã cài đặt với hàm <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> của <strong>base</strong> R. Xem thêm chương <a href="basics.html#basics">R cơ bản</a> để có thêm thông tin về các packages trong R.</p>
<div class="sourceCode" id="cb1098"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>,          <span class="co"># File import</span>
               <span class="va">here</span>,         <span class="co"># File locator</span>
               <span class="va">tidyverse</span>,    <span class="co"># data management + ggplot2 graphics</span>
               <span class="va">tsibble</span>,      <span class="co"># handle time series datasets</span>
               <span class="va">slider</span>,       <span class="co"># for calculating moving averages</span>
               <span class="va">imputeTS</span>,     <span class="co"># for filling in missing values</span>
               <span class="va">feasts</span>,       <span class="co"># for time series decomposition and autocorrelation</span>
               <span class="va">forecast</span>,     <span class="co"># fit sin and cosin terms to data (note: must load after feasts)</span>
               <span class="va">trending</span>,     <span class="co"># fit and assess models </span>
               <span class="va">tmaptools</span>,    <span class="co"># for getting geocoordinates (lon/lat) based on place names</span>
               <span class="va">ecmwfr</span>,       <span class="co"># for interacting with copernicus sateliate CDS API</span>
               <span class="va">stars</span>,        <span class="co"># for reading in .nc (climate data) files</span>
               <span class="va">units</span>,        <span class="co"># for defining units of measurement (climate data)</span>
               <span class="va">yardstick</span>,    <span class="co"># for looking at model accuracy</span>
               <span class="va">surveillance</span>  <span class="co"># for aberration detection</span>
               <span class="op">)</span></code></pre></div>
</div>
<div id="nhập-dữ-liệu-12" class="section level3 unnumbered">
<h3>Nhập dữ liệu<a class="anchor" aria-label="anchor" href="#nh%E1%BA%ADp-d%E1%BB%AF-li%E1%BB%87u-12"><i class="fas fa-link"></i></a>
</h3>
<p>Bạn có thể tải xuống tất cả dữ liệu được sử dụng trong sổ tay này thông qua các hướng dẫn trong chương <a href="data-used.html#data-used">Tải sách và dữ liệu</a>.</p>
<p>Bộ dữ liệu minh họa được sử dụng trong phần này là số lượng các trường hợp campylobacter hàng tuần được báo cáo ở Đức từ năm 2001 đến 2011. <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/time_series/campylobacter_germany.xlsx" class="download-button">Bạn có thể bấm vào đây để tải xuống<span> bộ dữ liệu này (.xlsx).</span></a></p>
<p>Bộ dữ liệu này là một phiên bản rút gọn của bộ dữ liệu có sẵn trong package <a href="https://cran.r-project.org/web/packages/surveillance/"><strong>surveillance</strong></a>. (để biết chi tiết, hãy gọi surveillance package ra sau đó nhập <code>?campyDE</code>)</p>
<p>Nhập dữ liệu này với hàm <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> từ package <strong>rio</strong> (nó xử lý nhiều loại tệp như .xlsx, .csv, .rds - xem thêm chương <a href="importing.html#importing">Nhập xuất dữ liệu</a> để biết thêm chi tiết).</p>
<div class="sourceCode" id="cb1099"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># import the counts into R</span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"campylobacter_germany.xlsx"</span><span class="op">)</span></code></pre></div>
<p>10 hàng đầu tiên được hiển thị như bên dưới.</p>
<div id="htmlwidget-cc5e566cec231f562182" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-cc5e566cec231f562182">{"x":{"filter":"none","data":[["2001-12-31T00:00:00Z","2002-01-07T00:00:00Z","2002-01-14T00:00:00Z","2002-01-21T00:00:00Z","2002-01-28T00:00:00Z","2002-02-04T00:00:00Z","2002-02-11T00:00:00Z","2002-02-18T00:00:00Z","2002-02-25T00:00:00Z","2002-03-04T00:00:00Z"],[514,913,1023,887,815,792,803,807,692,705]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date<\/th>\n      <th>case<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="làm-sạch-dữ-liệu" class="section level3 unnumbered">
<h3>Làm sạch dữ liệu<a class="anchor" aria-label="anchor" href="#l%C3%A0m-s%E1%BA%A1ch-d%E1%BB%AF-li%E1%BB%87u"><i class="fas fa-link"></i></a>
</h3>
<p>Code dưới đây đảm bảo rằng cột ngày thág đã ở đúng định dạng. Trong chương này chúng ta sẽ sử dụng package <strong>tsibble</strong> và hàm <code>yearweek</code> sẽ được sử dụng để tạp biến lịch theo tuần. Có một số cách để thực hiện việc này (Xem chương <a href="dates.html#dates">Làm việc với ngày tháng</a> để biết thêm chi tiết), tuy nhiên đối với dữ liệu chuỗi thời gian thì tốt nhất nên sử dụng thống nhất một framework (<strong>tsibble</strong>).</p>
<div class="sourceCode" id="cb1100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## ensure the date column is in the appropriate format</span>
<span class="va">counts</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>

<span class="co">## create a calendar week variable </span>
<span class="co">## fitting ISO definitons of weeks starting on a monday</span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
     <span class="fu">mutate</span><span class="op">(</span>epiweek <span class="op">=</span> <span class="fu">yearweek</span><span class="op">(</span><span class="va">date</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="tải-xuống-dữ-liệu-khí-hậu" class="section level3 unnumbered">
<h3>Tải xuống dữ liệu khí hậu<a class="anchor" aria-label="anchor" href="#t%E1%BA%A3i-xu%E1%BB%91ng-d%E1%BB%AF-li%E1%BB%87u-kh%C3%AD-h%E1%BA%ADu"><i class="fas fa-link"></i></a>
</h3>
<p>Trong mục <em>mối tương quan của hai chuỗi thời gian</em> trong chương này, chúng ta sẽ so sánh số lượng trường hợp campylobacter với dữ liệu khí hậu.
Dữ liệu khí hậu tại bất kỳ đâu trên thế giới đều có thể được tải xuống từ EU’s Copernicus Satellite. Đây không phải là các phép đo chính xác, mà dựa trên một mô hình (tương tự như phép nội suy), tuy nhiên lợi ích là mức độ bao phủ toàn cầu hàng giờ cũng như các dự báo.</p>
<p>Bạn có thể tải xuống từng tệp dữ liệu khí hậu này từ chương <a href="data-used.html#data-used">Tải sách và dữ liệu</a>.</p>
<p>Với mục đích minh họa ở đây, chúng tôi sẽ trình bày code để sử dụng package <strong>ecmwfr</strong> để lấy những dữ liệu này từ kho dữ liệu khí hậu Copernicus. Bạn sẽ cần tạo một tài khoản miễn phí để thực hiện. Trang web của package có một <a href="https://github.com/bluegreen-labs/ecmwfr#use-copernicus-climate-data-store-cds">hướng dẫn</a> hữu ích về cách thực hiện việc này. Dưới đây là code minh họa về cách thực hiện việc này, khi bạn có các khóa API thích hợp. Bạn phải thay thế X bên dưới bằng ID tài khoản của mình. Bạn sẽ cần tải xuống một năm dữ liệu cùng một lúc nếu không máy chủ sẽ hết thời gian chờ.</p>
<p>Nếu bạn không chắc chắn về tọa độ cho vị trí mà bạn muốn tải dữ liệu xuống, bạn có thể sử dụng gói <strong>tmaptools</strong> để lấy tọa độ ra từ open street maps. Một cách khác là dùng package <a href="https://github.com/rCarto/photon"><strong>photon</strong></a>, tuy nhiên nó chưa được chính thức xuất bản lên trên CRAN; cái hay của <strong>photon</strong> là nó cung cấp nhiều dữ liệu ngữ cảnh hơn khi có một số kết quả phù hợp cho tìm kiếm của bạn.</p>
<div class="sourceCode" id="cb1101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## retrieve location coordinates</span>
<span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">geocode_OSM</span><span class="op">(</span><span class="st">"Germany"</span>, geometry <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span>

<span class="co">## pull together long/lats in format for ERA-5 querying (bounding box) </span>
<span class="co">## (as just want a single point can repeat coords)</span>
<span class="va">request_coords</span> <span class="op">&lt;-</span> <span class="fu">str_glue_data</span><span class="op">(</span><span class="va">coords</span><span class="op">$</span><span class="va">coords</span>, <span class="st">"{y}/{x}/{y}/{x}"</span><span class="op">)</span>


<span class="co">## Pulling data modelled from copernicus satellite (ERA-5 reanalysis)</span>
<span class="co">## https://cds.climate.copernicus.eu/cdsapp#!/software/app-era5-explorer?tab=app</span>
<span class="co">## https://github.com/bluegreen-labs/ecmwfr</span>

<span class="co">## set up key for weather data </span>
<span class="fu">wf_set_key</span><span class="op">(</span>user <span class="op">=</span> <span class="st">"XXXXX"</span>,
           key <span class="op">=</span> <span class="st">"XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX"</span>,
           service <span class="op">=</span> <span class="st">"cds"</span><span class="op">)</span> 

<span class="co">## run for each year of interest (otherwise server times out)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2002</span><span class="op">:</span><span class="fl">2011</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co">## pull together a query </span>
  <span class="co">## see here for how to do: https://bluegreen-labs.github.io/ecmwfr/articles/cds_vignette.html#the-request-syntax</span>
  <span class="co">## change request to a list using addin button above (python to list)</span>
  <span class="co">## Target is the name of the output file!!</span>
  <span class="va">request</span> <span class="op">&lt;-</span> <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    product_type <span class="op">=</span> <span class="st">"reanalysis"</span>,
    format <span class="op">=</span> <span class="st">"netcdf"</span>,
    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2m_temperature"</span>, <span class="st">"total_precipitation"</span><span class="op">)</span>,
    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,
    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span><span class="op">)</span>,
    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span>,
            <span class="st">"13"</span>, <span class="st">"14"</span>, <span class="st">"15"</span>, <span class="st">"16"</span>, <span class="st">"17"</span>, <span class="st">"18"</span>, <span class="st">"19"</span>, <span class="st">"20"</span>, <span class="st">"21"</span>, <span class="st">"22"</span>, <span class="st">"23"</span>, <span class="st">"24"</span>,
            <span class="st">"25"</span>, <span class="st">"26"</span>, <span class="st">"27"</span>, <span class="st">"28"</span>, <span class="st">"29"</span>, <span class="st">"30"</span>, <span class="st">"31"</span><span class="op">)</span>,
    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"00:00"</span>, <span class="st">"01:00"</span>, <span class="st">"02:00"</span>, <span class="st">"03:00"</span>, <span class="st">"04:00"</span>, <span class="st">"05:00"</span>, <span class="st">"06:00"</span>, <span class="st">"07:00"</span>,
             <span class="st">"08:00"</span>, <span class="st">"09:00"</span>, <span class="st">"10:00"</span>, <span class="st">"11:00"</span>, <span class="st">"12:00"</span>, <span class="st">"13:00"</span>, <span class="st">"14:00"</span>, <span class="st">"15:00"</span>,
             <span class="st">"16:00"</span>, <span class="st">"17:00"</span>, <span class="st">"18:00"</span>, <span class="st">"19:00"</span>, <span class="st">"20:00"</span>, <span class="st">"21:00"</span>, <span class="st">"22:00"</span>, <span class="st">"23:00"</span><span class="op">)</span>,
    area <span class="op">=</span> <span class="va">request_coords</span>,
    dataset_short_name <span class="op">=</span> <span class="st">"reanalysis-era5-single-levels"</span>,
    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"germany_weather"</span>, <span class="va">i</span>, <span class="st">".nc"</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="co">## download the file and store it in the current working directory</span>
  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">wf_request</span><span class="op">(</span>user     <span class="op">=</span> <span class="st">"XXXXX"</span>,  <span class="co"># user ID (for authentication)</span>
                     request  <span class="op">=</span> <span class="va">request</span>,  <span class="co"># the request</span>
                     transfer <span class="op">=</span> <span class="cn">TRUE</span>,     <span class="co"># download the file</span>
                     path     <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"Weather"</span><span class="op">)</span><span class="op">)</span> <span class="co">## path to save the data</span>
  <span class="op">}</span></code></pre></div>
</div>
<div id="nhập-dữ-liệu-khí-hậu" class="section level3 unnumbered">
<h3>Nhập dữ liệu khí hậu<a class="anchor" aria-label="anchor" href="#nh%E1%BA%ADp-d%E1%BB%AF-li%E1%BB%87u-kh%C3%AD-h%E1%BA%ADu"><i class="fas fa-link"></i></a>
</h3>
<p>Cho dù bạn đã tải xuống dữ liệu khí hậu thông qua sổ tay này hay sử dụng code ở trên, thì bạn cần phải các tệp dữ liệu khí hậu trong 10 năm có phần mở rộng là “.nc”, được lưu trữ trong cùng một thư mục trong máy tính của bạn.</p>
<p>Sử dụng mã bên dưới để nhập các tệp này vào R với package <strong>stars</strong>.</p>
<div class="sourceCode" id="cb1102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define path to weather folder </span>
<span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>
  <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"time_series"</span>, <span class="st">"weather"</span><span class="op">)</span>, <span class="co"># replace with your own file path </span>
  full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co">## only keep those with the current name of interest </span>
<span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="va">file_paths</span><span class="op">[</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">file_paths</span>, <span class="st">"germany"</span><span class="op">)</span><span class="op">]</span>

<span class="co">## read in all the files as a stars object </span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span></code></pre></div>
<pre><code>## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp,</code></pre>
<p>Khi các tệp này đã được nhập vào một đối tượng có tên <code>data</code>, chúng ta sẽ chuyển chúng thành một data frame.</p>
<div class="sourceCode" id="cb1104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## change to a data frame </span>
<span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## add in variables and correct units</span>
  <span class="fu">mutate</span><span class="op">(</span>
    <span class="co">## create an calendar week variable </span>
    epiweek <span class="op">=</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-week.html">yearweek</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, 
    <span class="co">## create a date variable (start of calendar week)</span>
    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span>,
    <span class="co">## change temperature from kelvin to celsius</span>
    t2m <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">t2m</span>, <span class="va">celsius</span><span class="op">)</span>, 
    <span class="co">## change precipitation from metres to millimetres </span>
    tp  <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">tp</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## group by week (keep the date too though)</span>
  <span class="fu">group_by</span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">date</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## get the average per week</span>
  <span class="fu">summarise</span><span class="op">(</span>t2m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">t2m</span><span class="op">)</span><span class="op">)</span>, 
            tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by 'epiweek'. You can override using the `.groups` argument.</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="dữ-liệu-chuỗi-thời-gian" class="section level2" number="23.3">
<h2>
<span class="header-section-number">23.3</span> Dữ liệu chuỗi thời gian<a class="anchor" aria-label="anchor" href="#d%E1%BB%AF-li%E1%BB%87u-chu%E1%BB%97i-th%E1%BB%9Di-gian"><i class="fas fa-link"></i></a>
</h2>
<p>Có một số package khác nhau để cấu trúc và xử lý dữ liệu chuỗi thời gian. Như đã nói, chúng ta sẽ tập trung vào họ các package thuộc <strong>tidyverts</strong> và sẽ sử dụng package <strong>tsibble</strong> để xác định đối tượng chuỗi thời gian. Việc có một tập dữ liệu được xác định là một đối tượng chuỗi thời gian có nghĩa là việc cấu trúc phân tích của chúng ta sẽ trở nên dễ dàng hơn nhiều.</p>
<p>Để thực hiện, chúng ta sử dụng hàm <code>tsibble()</code> và cụ thể “chỉ mục (index)”, vd: biến số cụ thể đơn vị thời gian quan tâm. Trong trường hợp của chúng ta, biến số này có tên <code>epiweek</code>.</p>
<p>Ví dụ: nếu chúng ta có một tập dữ liệu với số lượng hàng tuần theo tỉnh, chúng ta cũng có thể cụ thể biến nhóm bằng cách cụ sử dụng đối số <code>key =</code>. Điều này sẽ cho phép chúng ta thực hiện phân tích cho từng nhóm.</p>
<div class="sourceCode" id="cb1106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define time series object </span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></code></pre></div>
<p>Nhìn vào <code><a href="https://rdrr.io/r/base/class.html">class(counts)</a></code>, ta thấy ngoài việc là một data frame gọn gàng (“tbl_df”, “tbl”, “data.frame”), nó có các thuộc tính bổ sung của một khung dữ liệu chuỗi thời gian (“tbl_ts”).</p>
<p>Bạn có thể xem nhanh dữ liệu của mình bằng cách sử dụng <strong>ggplot2</strong>. Từ biểu đồ ta thấy có một xu hướng theo mùa, và không có bất kỳ giá trị bị thiếu nào. Tuy nhiên, dường như có vấn đề với việc báo cáo vào đầu mỗi năm; số ca mắc bệnh giảm vào tuần cuối cùng của năm và sau đó tăng vào tuần đầu tiên của năm tiếp theo.</p>
<div class="sourceCode" id="cb1107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## plot a line graph of cases by week</span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">counts</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
     <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot-1.png" width="672"></div>
<p><span style="color: red;"><strong><em>NGUY HIỂM:</em></strong> Không giống như ví dụ này, phần lớn các bộ dữ liệu sẽ chưa được làm sạch. Bạn sẽ cần phải kiểm tra các bản ghi trùng lặp và bản ghi bị thiếu như bên dưới.</span></p>
<!-- ======================================================= -->
<div id="trùng-lặp" class="section level3 unnumbered">
<h3>Trùng lặp<a class="anchor" aria-label="anchor" href="#tr%C3%B9ng-l%E1%BA%B7p"><i class="fas fa-link"></i></a>
</h3>
<p><strong>tsibble</strong> không cho phép các quan sát trùng lặp. Vì vậy, mỗi hàng sẽ cần phải là duy nhất, hoặc duy nhất trong nhóm (biến <code>key</code>). Package này có một số hàm để xác định các bản ghi trùng lặp. Chúng bao gồm các hàm: <code>are_duplicated()</code> trả về một vectơ có giá trị TRUE/FALSE vector, truy vấn xem hàng có là duy nhất không; và hàm <code>duplicates()</code> sẽ cung cấp cho bạn một data frame chứa các hàng trùng lặp.</p>
<p>Xem chương <a href="deduplication.html#lo%E1%BA%A1i-b%E1%BB%8F-tr%C3%B9ng-l%E1%BA%B7p-1">Loại bỏ trùng lặp</a> để biết thêm chi tiết về cách lựa chọn các hàng bạn muốn.</p>
<div class="sourceCode" id="cb1108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## get a vector of TRUE/FALSE whether rows are duplicates</span>
<span class="fu">are_duplicated</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> 

<span class="co">## get a data frame of any duplicated rows </span>
<span class="fu">duplicates</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </code></pre></div>
<!-- ======================================================= -->
</div>
<div id="bản-ghi-bị-thiếu" class="section level3 unnumbered">
<h3>Bản ghi bị thiếu<a class="anchor" aria-label="anchor" href="#b%E1%BA%A3n-ghi-b%E1%BB%8B-thi%E1%BA%BFu"><i class="fas fa-link"></i></a>
</h3>
<p>Chúng ta đã thấy từ cuộc khảo sát tóm tắt bên trên, không có bất kỳ giá trị missing nào được phát hiện, nhưng chúng ta cũng đã thấy rằng dường như có vấn đề với việc báo cáo chậm trễ vào khoảng năm mới. Một cách để giải quyết vấn đề này có thể là đặt các giá trị này thành missing và sau đó impute các giá trị. Dạng đơn giản nhất của khi impute chuỗi thời gian là vẽ một đường thẳng giữa giá trị không bị thiếu cuối cùng và giá trị không bị thiếu tiếp theo. Để làm điều này, chúng ta sẽ sử dụng hàm <code>na_interpolation()</code> từ package <strong>imputeTS</strong> .</p>
<p>Xem chương <a href="missing-data.html#missing-data">Dữ liệu Missing</a> để biết các tùy chọn khác của imputation.</p>
<p>Một giải pháp thay thế khác sẽ là tính toán đường trung bình động, để thử và giải quyết các vấn đề báo cáo rõ ràng này (xem phần tiếp theo và chương <a href="epicurves.html#%C4%91%C6%B0%E1%BB%9Dng-trung-b%C3%ACnh-%C4%91%E1%BB%99ng">Đường trung bình động</a>.</p>
<div class="sourceCode" id="cb1109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create a variable with missings instead of weeks with reporting issues</span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
     <span class="fu">mutate</span><span class="op">(</span>case_miss <span class="op">=</span> <span class="fu">if_else</span><span class="op">(</span>
          <span class="co">## if epiweek contains 52, 53, 1 or 2</span>
          <span class="fu">str_detect</span><span class="op">(</span><span class="va">epiweek</span>, <span class="st">"W51|W52|W53|W01|W02"</span><span class="op">)</span>, 
          <span class="co">## then set to missing </span>
          <span class="cn">NA_real_</span>, 
          <span class="co">## otherwise keep the value in case</span>
          <span class="va">case</span>
     <span class="op">)</span><span class="op">)</span>

<span class="co">## alternatively interpolate missings by linear trend </span>
<span class="co">## between two nearest adjacent points</span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>case_int <span class="op">=</span> <span class="fu">imputeTS</span><span class="fu">::</span><span class="fu"><a href="https://SteffenMoritz.github.io/imputeTS/reference/na_interpolation.html">na_interpolation</a></span><span class="op">(</span><span class="va">case_miss</span><span class="op">)</span>
         <span class="op">)</span>

<span class="co">## to check what values have been imputed compared to the original</span>
<span class="fu">ggplot_na_imputations</span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_miss</span>, <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make a traditional plot (with black axes and white background)</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/missings-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="phân-tích-mô-tả" class="section level2" number="23.4">
<h2>
<span class="header-section-number">23.4</span> Phân tích mô tả<a class="anchor" aria-label="anchor" href="#ph%C3%A2n-t%C3%ADch-m%C3%B4-t%E1%BA%A3"><i class="fas fa-link"></i></a>
</h2>
<!-- ======================================================= -->
<div id="timeseries_moving" class="section level3 unnumbered">
<h3>Đường trung bình động<a class="anchor" aria-label="anchor" href="#timeseries_moving"><i class="fas fa-link"></i></a>
</h3>
<p>Nếu dữ liệu rất nhiễu (dao động lên và xuống), việc tính toán đường trung bình động có thể sẽ hữu ích. Trong ví dụ dưới đây, với mỗi tuần chúng ta sẽ tính toán số trường hợp trung bình từ bốn tuần trước đó. Việc này sẽ giúp dữ liệu dễ diễn giải hơn. Trong trường hợp của chúng ta, điều này không thực sự bổ sung nhiều, vì vậy chúng ta sẽ bám vào dữ liệu nội suy để phân tích thêm. Xem chương <a href="epicurves.html#%C4%91%C6%B0%E1%BB%9Dng-trung-b%C3%ACnh-%C4%91%E1%BB%99ng">Đường trung bình động</a> để biết thêm chi tiết.</p>
<div class="sourceCode" id="cb1110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create a moving average variable (deals with missings)</span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
     <span class="co">## create the ma_4w variable </span>
     <span class="co">## slide over each row of the case variable</span>
     <span class="fu">mutate</span><span class="op">(</span>ma_4wk <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/slider/man/slide.html">slide_dbl</a></span><span class="op">(</span><span class="va">case</span>, 
                               <span class="co">## for each row calculate the name</span>
                               <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
                               <span class="co">## use the four previous weeks</span>
                               .before <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span>

<span class="co">## make a quick visualisation of the difference </span>
<span class="fu">ggplot</span><span class="op">(</span><span class="va">counts</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
     <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
     <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">ma_4wk</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/moving_averages-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="tính-chu-kỳ" class="section level3 unnumbered">
<h3>Tính chu kỳ<a class="anchor" aria-label="anchor" href="#t%C3%ADnh-chu-k%E1%BB%B3"><i class="fas fa-link"></i></a>
</h3>
<p>Sau đây chúng ta sẽ định nghĩa một hàm để tạo một biểu đồ chu kỳ. Xem chương <a href="writing-functions.html#writing-functions">Viết hàm</a> để biết cách tạo một hàm trong R.</p>
<p>Đầu tiên, hàm được định nghĩa. Các đối số của nó bao gồm một bộ dữ liệu với cột <code>counts</code>, <code>start_week =</code> là tuần đầu tiên của bộ dữ liệu, một con số để cho biết có bao nhiêu chu kỳ mỗi năm (ví dụ: 52, 12), và cuối cùng là kiểu đầu ra (xem chi tiết trong đoạn mã bên dưới).</p>
<div class="sourceCode" id="cb1111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Function arguments</span>
<span class="co">#####################</span>
<span class="co">## x is a dataset</span>
<span class="co">## counts is variable with count data or rates within x </span>
<span class="co">## start_week is the first week in your dataset</span>
<span class="co">## period is how many units in a year </span>
<span class="co">## output is whether you want return spectral periodogram or the peak weeks</span>
  <span class="co">## "periodogram" or "weeks"</span>

<span class="co"># Define function</span>
<span class="va">periodogram</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, 
                        <span class="va">counts</span>, 
                        <span class="va">start_week</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, 
                        <span class="va">period</span> <span class="op">=</span> <span class="fl">52</span>, 
                        <span class="va">output</span> <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span>
  

    <span class="co">## make sure is not a tsibble, filter to project and only keep columns of interest</span>
    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
    
    <span class="co"># prepare_data &lt;- prepare_data[prepare_data[[strata]] == j, ]</span>
    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prepare_data</span>, <span class="op">{</span><span class="op">{</span><span class="va">counts</span><span class="op">}</span><span class="op">}</span><span class="op">)</span>
    
    <span class="co">## create an intermediate "zoo" time series to be able to use with spec.pgram</span>
    <span class="va">zoo_cases</span> <span class="op">&lt;-</span> <span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/zooreg.html">zooreg</a></span><span class="op">(</span><span class="va">prepare_data</span>, 
                             start <span class="op">=</span> <span class="va">start_week</span>, frequency <span class="op">=</span> <span class="va">period</span><span class="op">)</span>
    
    <span class="co">## get a spectral periodogram not using fast fourier transform </span>
    <span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/spec.pgram.html">spec.pgram</a></span><span class="op">(</span><span class="va">zoo_cases</span>, fast <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
    
    <span class="co">## return the peak weeks </span>
    <span class="va">periodo_weeks</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">periodo</span><span class="op">$</span><span class="va">freq</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">period</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">output</span> <span class="op">==</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">periodo_weeks</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="va">periodo</span>
    <span class="op">}</span>
    
<span class="op">}</span>

<span class="co">## get spectral periodogram for extracting weeks with the highest frequencies </span>
<span class="co">## (checking of seasonality) </span>
<span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, 
                       <span class="va">case_int</span>, 
                       start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>,
                       output <span class="op">=</span> <span class="st">"periodogram"</span><span class="op">)</span>

<span class="co">## pull spectrum and frequence in to a dataframe for plotting</span>
<span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">periodo</span><span class="op">$</span><span class="va">freq</span>, <span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span>

<span class="co">## plot a periodogram showing the most frequently occuring periodicity </span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">periodo</span>, 
                <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">periodo.freq</span><span class="op">/</span><span class="fl">52</span><span class="op">)</span>,  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">periodo.spec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Period (Weeks)"</span>, y <span class="op">=</span> <span class="st">"Log(density)"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/periodogram-1.png" width="672"></div>
<div class="sourceCode" id="cb1112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## get a vector weeks in ascending order </span>
<span class="va">peak_weeks</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, 
                          <span class="va">case_int</span>, 
                          start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, 
                          output <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span></code></pre></div>
<p><span style="color: black;"><strong><em>LƯU Ý:</em></strong> Có thể sử dụng các tuần ở trên để thêm chúng vào các chu kỳ sin và cosin, tuy nhiên chúng ta sẽ sử dụng một hàm để tạo ra các chu kỳ này (xem phần hồi quy bên dưới) </span></p>
<!-- ======================================================= -->
</div>
<div id="tách-nhỏ-chuỗi-thời-gian" class="section level3 unnumbered">
<h3>Tách nhỏ chuỗi thời gian<a class="anchor" aria-label="anchor" href="#t%C3%A1ch-nh%E1%BB%8F-chu%E1%BB%97i-th%E1%BB%9Di-gian"><i class="fas fa-link"></i></a>
</h3>
<p>Phân tách cổ điển được sử dụng để chia nhỏ một chuỗi thời gian thành một số phần, khi kết hợp lại với nhau sẽ tạo nên xu hướng mà bạn nhìn thấy. Các phần khác nhau này là:</p>
<ul>
<li>Chu kỳ xu hướng (hướng dài hạn của dữ liệu)<br>
</li>
<li>Theo mùa (lặp lại xu hướng)<br>
</li>
<li>Sự ngẫu nhiên (những gì còn lại sau khi loại bỏ xu hướng và theo mùa)</li>
</ul>
<div class="sourceCode" id="cb1113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## decompose the counts dataset </span>
<span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="co"># using an additive classical decomposition model</span>
  <span class="fu">model</span><span class="op">(</span><span class="fu">classical_decomposition</span><span class="op">(</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## extract the important information from the model</span>
  <span class="fu">components</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## generate a plot </span>
  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/decomposition-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="tự-tương-quan" class="section level3 unnumbered">
<h3>Tự tương quan<a class="anchor" aria-label="anchor" href="#t%E1%BB%B1-t%C6%B0%C6%A1ng-quan"><i class="fas fa-link"></i></a>
</h3>
<p>Tự tương quan cho bạn biết về mối quan hệ giữa số lượng của mỗi tuần và các tuần trước đó (được gọi là trễ).</p>
<p>Sử dụng hàm <code>ACF()</code>, chúng ta có thể tạo ra một biểu đồ cho chúng ta thấy số lượng đường có mối quan hệ ở các độ trễ khác nhau. Khi độ trễ bằng 0 (x = 0), đường này sẽ luôn là 1 vì nó cho thấy mối quan hệ giữa một quan sát và chính nó (không được hiển thị). Đường đầu tiên hiển thị ở đây (x = 1) cho thấy mối quan hệ giữa mỗi quan sát và quan sát trước nó (độ trễ bằng 1), đường thứ hai cho thấy mối quan hệ giữa mỗi quan sát và quan sát trước quan sát cuối cùng (độ trễ là 2) và cứ như thế cho đến khi độ trễ là 52, cho thấy mối quan hệ giữa mỗi quan sát và quan sát từ 1 năm (52 tuần trước đó).</p>
<p>Sử dụng hàm <code>ACF()</code> (cho tự tương quan một phần) hiển thị cùng một loại quan hệ nhưng được hiệu chỉnh cho tất cả các tuần khác nằm giữa. Nó sẽ ít thông tin hơn để xác định tính chu kỳ.</p>
<div class="sourceCode" id="cb1114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## using the counts dataset</span>
<span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="co">## calculate autocorrelation using a full years worth of lags</span>
  <span class="fu">ACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## show a plot</span>
  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-1.png" width="672"></div>
<div class="sourceCode" id="cb1115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## using the counts data set </span>
<span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="co">## calculate the partial autocorrelation using a full years worth of lags</span>
  <span class="fu">PACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## show a plot</span>
  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-2.png" width="672"></div>
<p>Bạn có thể kiểm định giả thuyết không về tính độc lập trong một chuỗi thời gian (vd: không tự tương quan) sử dụng kiểm định Ljung-Box (trong package <strong>stats</strong>). Giá trị p có ý nghĩa cho thấy rằng có sự tự tương quan trong dữ liệu.</p>
<div class="sourceCode" id="cb1116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## test for independance </span>
<span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  counts$case_int
## X-squared = 462.65, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="fit-mô-hình-hồi-quy" class="section level2" number="23.5">
<h2>
<span class="header-section-number">23.5</span> Fit mô hình hồi quy<a class="anchor" aria-label="anchor" href="#fit-m%C3%B4-h%C3%ACnh-h%E1%BB%93i-quy"><i class="fas fa-link"></i></a>
</h2>
<p>Có thể fit một số lượng lớn các hồi quy khác nhau vào một chuỗi thời gian, tuy nhiên ở đây chúng tôi sẽ trình bày cách để fit một hồi quy nhị thức âm - vì nó thường phù hợp nhất cho dữ liệu về trường hợp bệnh trong các bệnh truyền nhiễm.</p>
<!-- ======================================================= -->
<div id="chu-kỳ-fourier" class="section level3 unnumbered">
<h3>Chu kỳ Fourier<a class="anchor" aria-label="anchor" href="#chu-k%E1%BB%B3-fourier"><i class="fas fa-link"></i></a>
</h3>
<p>Chu kỳ Fourier tương đương với các đường cong sin và cosin. Sự khác biệt là chúng được dựa trên việc tìm ra sự kết hợp thích hợp nhất của các đường cong để giải thích dữ liệu của bạn.</p>
<p>If only fitting một chu kỳ Fourier, điều này sẽ tương đương với việc fitting một đường sin và cosin cho độ trễ xảy ra thường xuyên nhất được thấy trong biểu đồ chu kỳ của bạn (trong trường hợp của chúng ta là 52 tuần). Chúng ta sử dụng hàm <code>fourier()</code> từ package <strong>forecast</strong>.</p>
<p>Trong code dưới đây, chúng ta gán bằng cách sử dụng <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>, vì hàm <code>fourier()</code> trả về hai cột (một cho sin và một cho cosin) và vì vậy chúng được thêm vào tập dữ liệu dưới dạng danh sách, được gọi là “fourier” - nhưng danh sách này sau đó có thể được sử dụng như một biến bình thường trong hồi quy.</p>
<div class="sourceCode" id="cb1118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## add in fourier terms using the epiweek and case_int variabless</span>
<span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="hồi-quy-nhị-thức-âm" class="section level3 unnumbered">
<h3>Hồi quy nhị thức âm<a class="anchor" aria-label="anchor" href="#h%E1%BB%93i-quy-nh%E1%BB%8B-th%E1%BB%A9c-%C3%A2m"><i class="fas fa-link"></i></a>
</h3>
<p>Bạn có thể fit các mô hình hồi quy sử dụng các hàm từ package <strong>stats</strong> hoặc <strong>MASS</strong> trong base R (vd: <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>, <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> và <code>glm.nb()</code>). Tuy nhiên, chúng ta sẽ sử dụng các hàm từ package <strong>trending</strong>, vì nó cho phép tính khoảng tin cậy và khoảng tiên lượng phù hợp (các hàm khác không có sẵn). Cú pháp vẫn như vậy, bạn cụ thể biến đầu ra và theo sau bởi dấu ngã (~), sau đó thêm các biến giải thích vào, phân cách nhau bởi dấu cộng (+).</p>
<p>Sự khác biệt là đầu tiên chúng ta phải xác định model trước, và sau đó <code>fit()</code> nó vào dữ liệu. Điều này rất hữu ích vì nó cho phép so sánh nhiều mô hình khác nhau với cùng một cú pháp..</p>
<p><span style="color: darkgreen;"><strong><em>MẸO:</em></strong> Nếu bạn muốn sử dụng tỷ suất hơn là số lượng, bạn có thể bao gồm biến dân số dưới dạng thuật ngữ bù logarit, bằng cách thêm <code>offset(log(population)</code>. Sau đó, bạn sẽ cần đặt dân số là 1, trước khi sử dụng hàm <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> để tạo ra tỷ suất. </span></p>
<p><span style="color: darkgreen;"><strong><em>MẸO:</em></strong> Để fit những mô hình phức tạp hơn chẳng hạn như ARIMA hoặc prophet, hãy tham khảo package <a href="https://fable.tidyverts.org/index.html"><strong>fable</strong></a>.</span></p>
<div class="sourceCode" id="cb1119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define the model you want to fit (negative binomial) </span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span>
  <span class="co">## set number of cases as outcome of interest</span>
  <span class="va">case_int</span> <span class="op">~</span>
    <span class="co">## use epiweek to account for the trend</span>
    <span class="va">epiweek</span> <span class="op">+</span>
    <span class="co">## use the fourier terms to account for seasonality</span>
    <span class="va">fourier</span><span class="op">)</span>

<span class="co">## fit your model using the counts dataset</span>
<span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">counts</span><span class="op">)</span>

<span class="co">## calculate confidence intervals and prediction intervals </span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## plot your regression </span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a line for the model estimate</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,
            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a band for the prediction intervals </span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, 
                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, 
              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a line for your observed case counts</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, 
            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make a traditional plot (with black axes and white background)</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/nb_reg-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="phần-dư" class="section level3 unnumbered">
<h3>Phần dư<a class="anchor" aria-label="anchor" href="#ph%E1%BA%A7n-d%C6%B0"><i class="fas fa-link"></i></a>
</h3>
<p>Để xem mô hình của chúng ta phù hợp với dữ liệu quan sát như thế nào, chúng ta cần xem xét phần dư. Phần dư là sự khác biệt giữa số lượng được quan sát và số lượng được ước tính từ mô hình. Chúng ta có thể tính toán nó một cách đơn giản bằng cách dùng hàm <code>case_int - estimate</code>, nhưng hàm <code><a href="https://rdrr.io/r/stats/residuals.html">residuals()</a></code> trích xuất nó trực tiếp từ mô hình hồi quy cho chúng ta.</p>
<p>Những gì chúng ta thấy dưới đây là chúng ta không giải thích tất cả các sự dao động mà chúng ta có thể có với mô hình. Có thể chúng ta cần fit nhiều chu kỳ fourier hơn, và gủau quyết biên độ. Tuy nhiên đối với ví dụ này, chúng ta sẽ để nguyên như vậy. Các biểu đồ cho thấy mô hình của chúng ta hoạt động kém hơn ở các đỉnh và đáy (khi số lượng ở mức cao nhất và thấp nhất) và có nhiều khả năng ước tính không đầy đủ các số lượng quan sát được.</p>
<div class="sourceCode" id="cb1120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## calculate the residuals </span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">observed</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>resid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span><span class="op">(</span><span class="va">fitted_model</span><span class="op">$</span><span class="va">fitted_model</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span>

<span class="co">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span>
<span class="va">observed</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-1.png" width="672"></div>
<div class="sourceCode" id="cb1121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## is there autocorelation in the residuals (is there a pattern to the error?)  </span>
<span class="va">observed</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-2.png" width="672"></div>
<div class="sourceCode" id="cb1122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## are residuals normally distributed (are under or over estimating?)  </span>
<span class="va">observed</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_rug</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-3.png" width="672"></div>
<div class="sourceCode" id="cb1123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## compare observed counts to their residuals </span>
  <span class="co">## should also be no pattern </span>
<span class="va">observed</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-854-4.png" width="672"></div>
<div class="sourceCode" id="cb1124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## formally test autocorrelation of the residuals</span>
<span class="co">## H0 is that residuals are from a white-noise series (i.e. random)</span>
<span class="co">## test for independence </span>
<span class="co">## if p value significant then non-random</span>
<span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  observed$resid
## X-squared = 346.64, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="mối-quan-hệ-của-hai-chuỗi-thời-gian" class="section level2" number="23.6">
<h2>
<span class="header-section-number">23.6</span> Mối quan hệ của hai chuỗi thời gian<a class="anchor" aria-label="anchor" href="#m%E1%BB%91i-quan-h%E1%BB%87-c%E1%BB%A7a-hai-chu%E1%BB%97i-th%E1%BB%9Di-gian"><i class="fas fa-link"></i></a>
</h2>
<p>Ở đây chúng ta xem xét việc sử dụng dữ liệu thời tiết (đặc biệt là nhiệt độ) để giải thích số lượng trường hợp campylobacter.</p>
<!-- ======================================================= -->
<div id="nối-hai-bộ-dữ-liệu" class="section level3 unnumbered">
<h3>Nối hai bộ dữ liệu<a class="anchor" aria-label="anchor" href="#n%E1%BB%91i-hai-b%E1%BB%99-d%E1%BB%AF-li%E1%BB%87u"><i class="fas fa-link"></i></a>
</h3>
<p>Bạn có thể nối các tập dữ liệu của mình sử dụng biến tuần. Để biết thêm về nối dữ liệu, xem chương <a href="joining-matching.html#joining-matching">Nối dữ liệu</a>.</p>
<div class="sourceCode" id="cb1126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## left join so that we only have the rows already existing in counts</span>
<span class="co">## drop the date variable from temp_data (otherwise is duplicated)</span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">counts</span>, 
                    <span class="fu">select</span><span class="op">(</span><span class="va">temp_data</span>, <span class="op">-</span><span class="va">date</span><span class="op">)</span>,
                    by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="phân-tích-mô-tả-1" class="section level3 unnumbered">
<h3>Phân tích mô tả<a class="anchor" aria-label="anchor" href="#ph%C3%A2n-t%C3%ADch-m%C3%B4-t%E1%BA%A3-1"><i class="fas fa-link"></i></a>
</h3>
<p>Đầu tiên hãy trực quan hóa dữ liệu của bạn để kiểm tra xem có bất kỳ mối tương quan rõ ràng nào không. Biểu đồ dưới đây cho thấy một mối quan hệ rõ ràng về tính mùa vụ của các biến, và nhiệt độ có thể đạt đỉnh vài tuần trước khi các trường hợp xảy ra. Để biết thêm về xoay trục dữ liệu, xem chương <a href="pivoting.html#pivoting">Xoay trục dữ liệu</a>.</p>
<div class="sourceCode" id="cb1127"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="co">## keep the variables we are interested </span>
  <span class="fu">select</span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span>, <span class="va">t2m</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## change your data in to long format</span>
  <span class="fu">pivot_longer</span><span class="op">(</span>
    <span class="co">## use epiweek as your key</span>
    <span class="op">!</span><span class="va">epiweek</span>,
    <span class="co">## move column names to the new "measure" column</span>
    names_to <span class="op">=</span> <span class="st">"measure"</span>, 
    <span class="co">## move cell values to the new "values" column</span>
    values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## create a plot with the dataset above</span>
  <span class="co">## plot epiweek on the x axis and values (counts/celsius) on the y </span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="co">## create a separate plot for temperate and case counts </span>
    <span class="co">## let them set their own y-axes</span>
    <span class="fu">facet_grid</span><span class="op">(</span><span class="va">measure</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
    <span class="co">## plot both as a line</span>
    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot_bivar-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="lags-và-tương-quan-chéo" class="section level3 unnumbered">
<h3>Lags và tương quan chéo<a class="anchor" aria-label="anchor" href="#lags-v%C3%A0-t%C6%B0%C6%A1ng-quan-ch%C3%A9o"><i class="fas fa-link"></i></a>
</h3>
<p>Để kiểm định xem những tuần nào có tương quan nhiều nhất tới các trường hợp và nhiệt độ, bạn có thể sử dụng hàm tương quan chéo (<code>CCF()</code>) từ package <strong>feasts</strong>. Bạn cũng có thể trực quan hóa (hơn là sử dụng <code>arrange</code>) sử dụng hàm <code>autoplot()</code>.</p>
<div class="sourceCode" id="cb1128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="co">## calculate cross-correlation between interpolated counts and temperature</span>
  <span class="fu">CCF</span><span class="op">(</span><span class="va">case_int</span>, <span class="va">t2m</span>,
      <span class="co">## set the maximum lag to be 52 weeks</span>
      lag_max <span class="op">=</span> <span class="fl">52</span>, 
      <span class="co">## return the correlation coefficient </span>
      type <span class="op">=</span> <span class="st">"correlation"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## arange in decending order of the correlation coefficient </span>
  <span class="co">## show the most associated lags</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="op">-</span><span class="va">ccf</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## only show the top ten </span>
  <span class="fu">slice_head</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tsibble: 10 x 2 [1W]
##      lag   ccf
##    &lt;lag&gt; &lt;dbl&gt;
##  1    4W 0.749
##  2    5W 0.745
##  3    3W 0.735
##  4    6W 0.729
##  5    2W 0.727
##  6    7W 0.704
##  7    1W 0.695
##  8    8W 0.671
##  9    0W 0.649
## 10  -47W 0.638</code></pre>
<p>Chúng ta thấy rằng độ trễ 4 tuần có mối tương quan cao nhất, vì vậy chúng ta tạo một biến nhiệt độ trễ để đưa vào mô hình hồi quy.</p>
<p><span style="color: red;"><strong><em>NGUY HIỂM:</em></strong> Lưu ý rằng bốn tuần đầu tiên dữ liệu của chúng ta trong biến nhiệt độ trễ bị thiếu (<code>NA</code>) - bởi vì không có bốn tuần trước đó để lấy dữ liệu. Để sử dụng bộ dữ liệu này với hàm <strong>trending</strong> <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>, chúng ta cần phải sử dụng đối số <code>simulate_pi = FALSE</code> bên trong hàm <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Nếu chúng ta muốn sử dụng tùy chọn mô phỏng, thì chúng ta phải loại bỏ các giá trị missings và lưu thành một bộ dữ liệu mới bằng cách thêm hàm <code>drop_na(t2m_lag4)</code> vào đoạn code dưới đây.</span></p>
<div class="sourceCode" id="cb1130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="co">## create a new variable for temperature lagged by four weeks</span>
  <span class="fu">mutate</span><span class="op">(</span>t2m_lag4 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">t2m</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="hồi-quy-nhị-thức-âm-với-hai-biến-số" class="section level3 unnumbered">
<h3>Hồi quy nhị thức âm với hai biến số<a class="anchor" aria-label="anchor" href="#h%E1%BB%93i-quy-nh%E1%BB%8B-th%E1%BB%A9c-%C3%A2m-v%E1%BB%9Bi-hai-bi%E1%BA%BFn-s%E1%BB%91"><i class="fas fa-link"></i></a>
</h3>
<p>Chúng ta sẽ fit một mô hình hồi quy nhị thức âm như đã thực hiện trước đó. Lần này chúng ta thêm biến nhiệt độ có độ trễ là bốn tuần.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1131"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define the model you want to fit (negative binomial) </span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span>
  <span class="co">## set number of cases as outcome of interest</span>
  <span class="va">case_int</span> <span class="op">~</span>
    <span class="co">## use epiweek to account for the trend</span>
    <span class="va">epiweek</span> <span class="op">+</span>
    <span class="co">## use the fourier terms to account for seasonality</span>
    <span class="va">fourier</span> <span class="op">+</span> 
    <span class="co">## use the temperature lagged by four weeks </span>
    <span class="va">t2m_lag4</span>
    <span class="op">)</span>

<span class="co">## fit your model using the counts dataset</span>
<span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">counts</span><span class="op">)</span>

<span class="co">## calculate confidence intervals and prediction intervals </span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Để khảo sát các chu kỳ đơn lẻ, chúng ta có thể lấy mô hình hồi quy nhị thức âm gốc ra khỏi định dạng <strong>trending</strong> bằng cách sử dụng hàm <code>get_model()</code> và chuyển nó tới hàm <code>tidy()</code> của package <strong>broom</strong> để truy xuất các ước tính được lũy thừa hóa và các khoảng tin cậy.</p>
<p>Điều này cho chúng ta thấy là nhiệt độ trễ, sau khi kiểm soát xu hướng và tính theo mùa, tương tự như số lượng trường hợp (ước tính ~ 1) và sự liên quan có ý nghĩa. Điều này cho thấy rằng nó có thể là một biến số tốt để sử dụng trong việc dự báo các ca bệnh trong tương lai (các dữ liệu dự báo khí hậu luôn có sẵn).</p>
<div class="sourceCode" id="cb1132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fitted_model</span> <span class="op">%&gt;%</span> 
  <span class="co">## extract original negative binomial regression</span>
  <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## get a tidy dataframe of results</span>
  <span class="fu">tidy</span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, 
       conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 7
##   term           estimate  std.error statistic  p.value   conf.low  conf.high
##   &lt;chr&gt;             &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
## 1 (Intercept)   5.83      0.108          53.8  0         5.61       6.04     
## 2 epiweek       0.0000846 0.00000774     10.9  8.13e-28  0.0000695  0.0000998
## 3 fourierS1-52 -0.285     0.0214        -13.3  1.84e-40 -0.327     -0.243    
## 4 fourierC1-52 -0.195     0.0200         -9.78 1.35e-22 -0.234     -0.157    
## 5 t2m_lag4      0.00667   0.00269         2.48 1.30e- 2  0.00139    0.0119</code></pre>
<p>Đánh giá nhanh mô hình cho thấy nó có thể thực hiện tốt hơn công việc ước tính số ca bệnh quan sát được.</p>
<div class="sourceCode" id="cb1134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## plot your regression </span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a line for the model estimate</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,
            col <span class="op">=</span> <span class="st">"Red"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a band for the prediction intervals </span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, 
                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, 
              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a line for your observed case counts</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, 
            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make a traditional plot (with black axes and white background)</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_nb_reg_bivar-1.png" width="672"></div>
<div id="phần-dư-1" class="section level4 unnumbered">
<h4>Phần dư<a class="anchor" aria-label="anchor" href="#ph%E1%BA%A7n-d%C6%B0-1"><i class="fas fa-link"></i></a>
</h4>
<p>Chúng ta một lần nữa lại khảo sát phần dư để xem mô hình của chúng ta phù hợp với dữ liệu quan sát như thế nào. Các kết quả và phiên giải ở đây tương tự như kết quả của hồi quy trước đó, vì vậy sẽ khả thi hơn khi chọn mô hình đơn giản hơn mà không có nhiệt độ.</p>
<div class="sourceCode" id="cb1135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## calculate the residuals </span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">observed</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>resid <span class="op">=</span> <span class="va">case_int</span> <span class="op">-</span> <span class="va">estimate</span><span class="op">)</span>

<span class="co">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span>
<span class="va">observed</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 4 row(s) containing missing values (geom_path).</code></pre>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_point).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-1.png" width="672"></div>
<div class="sourceCode" id="cb1138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## is there autocorelation in the residuals (is there a pattern to the error?)  </span>
<span class="va">observed</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">autoplot</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-2.png" width="672"></div>
<div class="sourceCode" id="cb1139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## are residuals normally distributed (are under or over estimating?)  </span>
<span class="va">observed</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_rug</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </code></pre></div>
<pre><code>## Warning: Removed 4 rows containing non-finite values (stat_bin).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-3.png" width="672"></div>
<div class="sourceCode" id="cb1141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## compare observed counts to their residuals </span>
  <span class="co">## should also be no pattern </span>
<span class="va">observed</span> <span class="op">%&gt;%</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_point).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-855-4.png" width="672"></div>
<div class="sourceCode" id="cb1143"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## formally test autocorrelation of the residuals</span>
<span class="co">## H0 is that residuals are from a white-noise series (i.e. random)</span>
<span class="co">## test for independence </span>
<span class="co">## if p value significant then non-random</span>
<span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  observed$resid
## X-squared = 339.52, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="phát-hiện-ổ-dịch" class="section level2" number="23.7">
<h2>
<span class="header-section-number">23.7</span> Phát hiện ổ dịch<a class="anchor" aria-label="anchor" href="#ph%C3%A1t-hi%E1%BB%87n-%E1%BB%95-d%E1%BB%8Bch"><i class="fas fa-link"></i></a>
</h2>
<p>Chúng tôi sẽ trình bày hai phương pháp (tương tự) để phát hiện các ổ dịch ở đây. Cách đầu tiên được xây dựng dựa vào phần bên trên. Chúng ta sử dụng package <strong>trending</strong> để fit các mô hình hồi quy cho các năm trước đó, sau đó dự báo cho các năm tiếp theo. Nếu số lượng quan sát được cao hơn những gì chúng tôi dự báo, thì khả năng là đã có một đợt bùng phát. Phương pháp thứ hai dựa trên nguyên tắc tương tự nhưng sử dụng package <strong>surveillance</strong>, cung cấp nhiều thuật toán khác nhau để phát hiện các thay đổi bất thường.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Thông thường, bạn quan tâm đến năm hiện tại (do bạn chỉ biết số ca bệnh đến tuần hiện tại). Vì vậy, trong ví dụ này, chúng tôi đang giả định là tuần 39 của năm 2011.</span></p>
<!-- ======================================================= -->
<div id="package-trending" class="section level3 unnumbered">
<h3>Package <strong>trending</strong><a class="anchor" aria-label="anchor" href="#package-trending"><i class="fas fa-link"></i></a>
</h3>
<p>Đối với phương pháp này, chúng ta xác định một mốc (baseline) (thường là khoảng 5 năm dữ liệu). Chúng ta fit một mô hình hồi quy tới dữ liệu baseline, và sau đó sử dụng nó để ước tính cho năm sau.</p>
<!-- ======================================================= -->
<div id="điểm-cắt-ngày" class="section level4 unnumbered">
<h4>Điểm cắt ngày<a class="anchor" aria-label="anchor" href="#%C4%91i%E1%BB%83m-c%E1%BA%AFt-ng%C3%A0y"><i class="fas fa-link"></i></a>
</h4>
<p>Sẽ dễ dàng hơn khi xác định ngày của bạn ở một nơi và sau đó sử dụng những ngày này trong suốt phần còn lại trong của bạn.</p>
<p>Ở đây chúng ta xác định ngày bắt đầu (khi các quan sát của chúng ta bắt đầu) và ngày làm điểm cắt (cut-off date) (kết thúc giai đoạn baseline - và giai đoạn chúng ta muốn dự đoán cho sự bắt đầu). ~Chúng ta cũng xác định có bao nhiêu tuần trong năm mà chúng tôi sẽ dự đoán)~. Chúng ta cũng xác định có bao nhiêu tuần mà chúng ta đang muốn dự báo nằm giữa điểm cắt baseline và ngày kết thúc.</p>
<p><span style="color: black;"><strong><em>LƯU Ý:</em></strong> Trong ví dụ này, chúng tôi giả sử hiện đang ở cuối tháng 9 năm 2011 (“2011 W39”).</span></p>
<div class="sourceCode" id="cb1145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define start date (when observations began)</span>
<span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span>

<span class="co">## define a cut-off week (end of baseline, start of prediction period)</span>
<span class="va">cut_off</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2010-12-31"</span><span class="op">)</span>

<span class="co">## define the last date interested in (i.e. end of prediction)</span>
<span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2011-12-31"</span><span class="op">)</span>

<span class="co">## find how many weeks in period (year) of interest</span>
<span class="va">num_weeks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_date</span> <span class="op">-</span> <span class="va">cut_off</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="thêm-hàng-1" class="section level4 unnumbered">
<h4>Thêm hàng<a class="anchor" aria-label="anchor" href="#th%C3%AAm-h%C3%A0ng-1"><i class="fas fa-link"></i></a>
</h4>
<p>Để có thể dự báo ở định dạng tidyverse, chúng ta cần có số hàng phù hợp trong tập dữ liệu của mình, tức là một hàng cho mỗi tuần cho tới ngày kết thúc <code>end_date</code> đã được xác định bên trên. Đoạn mã bên dưới cho phép bạn thêm các hàng này theo một biến nhóm - ví dụ: nếu chúng ta có nhiều quốc gia trong một tập dữ liệu, chúng ta có thể nhóm theo quốc gia và sau đó thêm các hàng một cách thích hợp cho từng quốc gia. Hàm <code>group_by_key()</code> trong package <strong>tsibble</strong> cho phép chúng ta thực hiện điều này và sau đó chuyển dữ liệu đã nhóm tới các hàm <strong>dplyr</strong> như <code>group_modify()</code> và <code>add_row()</code>. Sau đó, chúng ta cụ thể trình tự các tuần giữa một tuần sau tuần tối đa hiện có trong dữ liệu và tuần kết thúc.</p>
<div class="sourceCode" id="cb1146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## add in missing weeks till end of year </span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span>
  <span class="co">## group by the region</span>
  <span class="fu">group_by_key</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="co">## for each group add rows from the highest epiweek to the end of year</span>
  <span class="fu">group_modify</span><span class="op">(</span><span class="op">~</span><span class="fu">add_row</span><span class="op">(</span><span class="va">.</span>,
                        epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, 
                                      <span class="va">end_date</span>,
                                      by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="chu-kỳ-fourier-1" class="section level4 unnumbered">
<h4>Chu kỳ Fourier<a class="anchor" aria-label="anchor" href="#chu-k%E1%BB%B3-fourier-1"><i class="fas fa-link"></i></a>
</h4>
<p>Chúng ta phải định nghĩa lại chu kỳ Fourier - bởi vì chúng ta chỉ muốn fit chúng tới ngày baseline và sau đó dự báo (ngoại suy) các chu kỳ này cho năm sau. Để làm điều này, chúng ta cần kết hợp hai danh sách đầu ra từ hàm <code>fourier()</code> lại với nhau; cái đầu tiên dành cho dữ liệu baseline, và cái thứ hai dự đoán cho năm quan tâm (bằng cách xác định đối số <code>h</code>).</p>
<p><em>Lưu ý</em> để nối dòng chúng ta phải sử dụng hàm <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> (thay vì hàm tidyverse <code>bind_rows</code>) bởi vì các cột fourier ở định dạng danh sách (vì vậy không được đặt tên riêng lẻ).</p>
<div class="sourceCode" id="cb1147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define fourier terms (sincos) </span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>
    <span class="co">## combine fourier terms for weeks prior to  and after 2010 cut-off date</span>
    <span class="co">## (nb. 2011 fourier terms are predicted)</span>
    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>
      <span class="co">## get fourier terms for previous years</span>
      <span class="fu">fourier</span><span class="op">(</span>
        <span class="co">## only keep the rows before 2011</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, 
               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>, 
        <span class="co">## include one set of sin cos terms </span>
        K <span class="op">=</span> <span class="fl">1</span>
        <span class="op">)</span>, 
      <span class="co">## predict the fourier terms for 2011 (using baseline data)</span>
      <span class="fu">fourier</span><span class="op">(</span>
        <span class="co">## only keep the rows before 2011</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, 
               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>,
        <span class="co">## include one set of sin cos terms </span>
        K <span class="op">=</span> <span class="fl">1</span>, 
        <span class="co">## predict 52 weeks ahead</span>
        h <span class="op">=</span> <span class="va">num_weeks</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="chia-dữ-liệu-và-fit-mô-hình-hồi-quy" class="section level4 unnumbered">
<h4>Chia dữ liệu và fit mô hình hồi quy<a class="anchor" aria-label="anchor" href="#chia-d%E1%BB%AF-li%E1%BB%87u-v%C3%A0-fit-m%C3%B4-h%C3%ACnh-h%E1%BB%93i-quy"><i class="fas fa-link"></i></a>
</h4>
<p>Chúng ta bây giờ cần phải chia dữ liệu của mình thành 2 giai đoạn: giai đoạn baseline và giai đoạn dự báo. Nó có thể thực hiện được với hàm <strong>dplyr</strong> <code>group_split()</code> sau khi nhóm bởi <code>group_by()</code>, và sẽ tạo ra một danh sách gồm hai data frame, một trước thời điểm cut-off và một cái ở thời điểm sau cut-off.</p>
<p>Chúng ta sau đó sử dụng hàm <code>pluck()</code> từ package <strong>purrr</strong> để kéo tập dữ liệu ra khỏi danh sách (tương đương với việc sử dụng ngoặc vuông, vd: <code>dat[[1]]</code>), và sau đó có thể fit mô hình của chúng ta tới dữ liệu nền,và sau đó sử dụng hàm <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> cho dữ liệu mà chúng ta quan tâm sau cut-off.</p>
<p>Xem chương <a href="iteration.html#iteration">Lặp, vòng lặp, và danh sách</a> để biết thêm về <strong>purrr</strong>.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># split data for fitting and prediction</span>
<span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="fu">group_by</span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">group_split</span><span class="op">(</span><span class="op">)</span>

<span class="co">## define the model you want to fit (negative binomial) </span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span>
  <span class="co">## set number of cases as outcome of interest</span>
  <span class="va">case_int</span> <span class="op">~</span>
    <span class="co">## use epiweek to account for the trend</span>
    <span class="va">epiweek</span> <span class="op">+</span>
    <span class="co">## use the furier terms to account for seasonality</span>
    <span class="va">fourier</span>
<span class="op">)</span>

<span class="co"># define which data to use for fitting and which for predicting</span>
<span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu">pluck</span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span>
<span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu">pluck</span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">case_int</span>, <span class="va">epiweek</span>, <span class="va">fourier</span><span class="op">)</span>

<span class="co"># fit model </span>
<span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">fitting_data</span><span class="op">)</span>

<span class="co"># get confint and estimates for fitted data</span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># forecast with data want to predict with </span>
<span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">pred_data</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## combine baseline and predicted datasets</span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">observed</span>, <span class="va">forecasts</span><span class="op">)</span></code></pre></div>
<p>Như bên trên, chúng ta có thể trực quan hóa mô hình với <strong>ggplot</strong>. Chúng ta đánh dấu các cảnh báo bằng các chấm màu đỏ cho các trường hợp quan sát được phía trên 95% khoảng dự đoán. Lần này, chúng ta cũng thêm một đường dọc để dán nhãn khi dự báo bắt đầu.</p>
<div class="sourceCode" id="cb1149"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## plot your regression </span>
<span class="fu">ggplot</span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a line for the model estimate</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,
            col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a band for the prediction intervals </span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, 
                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, 
              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a line for your observed case counts</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, 
            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## plot in points for the observed counts above expected</span>
  <span class="fu">geom_point</span><span class="op">(</span>
    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">case_int</span> <span class="op">&gt;</span> <span class="va">upper_pi</span><span class="op">)</span>, 
    <span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, 
    colour <span class="op">=</span> <span class="st">"red"</span>, 
    size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add vertical line and label to show where forecasting started</span>
  <span class="fu">geom_vline</span><span class="op">(</span>
           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">cut_off</span><span class="op">)</span>, 
           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, 
           label <span class="op">=</span> <span class="st">"Forecast"</span>, 
           x <span class="op">=</span> <span class="va">cut_off</span>, 
           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span> <span class="op">-</span> <span class="fl">250</span>, 
           angle <span class="op">=</span> <span class="fl">90</span>, 
           vjust <span class="op">=</span> <span class="fl">1</span>
           <span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make a traditional plot (with black axes and white background)</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 13 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/forecast_plot-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="đánh-giá-dự-báo" class="section level4 unnumbered">
<h4>Đánh giá dự báo<a class="anchor" aria-label="anchor" href="#%C4%91%C3%A1nh-gi%C3%A1-d%E1%BB%B1-b%C3%A1o"><i class="fas fa-link"></i></a>
</h4>
<p>Ngoài việc kiểm tra các phần dư, cũng quan trọng khi đánh giá xem mô hình của bạn tốt như thế nào trong việc dự đoán các trường hợp trong tương lai. Điều này cung cấp cho bạn ý tưởng về mức độ đáng tin cậy của các ngưỡng cảnh báo của bạn.</p>
<p>Cách kiểm định truyền thống là xem bạn có thể dự đoán năm gần nhất trước năm hiện tại tốt như thế nào (bởi vì bạn chưa biết số lượng cho “năm hiện tại”). Ví dụ: trong tập dữ liệu của chúng ta, chúng ta sẽ sử dụng dữ liệu từ năm 2002 đến năm 2009 để dự đoán năm 2010 và sau đó xem mức độ chính xác của những dự đoán đó. Sau đó, fit lại mô hình có bao gồm dữ liệu năm 2010 và sử dụng dữ liệu đó để dự đoán cho năm 2011.</p>
<p>Bạn có thể xem ảnh minh họa bên dưới bởi <em>Hyndman và cộng sự</em> trong cuốn <a href="https://otexts.com/fpp3/">“Các nguyên tắc dự báo và thực hành”</a>.</p>
<p><img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png"><em>hình sử dụng lại với sự cho phép của các tác giả</em></p>
<p>Nhược điểm của cách này là bạn không sử dụng tất cả dữ liệu có sẵn và nó không phải là mô hình cuối cùng mà bạn đang sử dụng để dự đoán.</p>
<p>Một giải pháp thay thế là sử dụng một phương pháp được gọi là xác thực chéo (cross-validation). Trong trường hợp này, bạn cuộn qua tất cả dữ liệu có sẵn để fit nhiều mô hình để dự đoán một năm tới. Bạn sẽ sử dụng nhiều dữ liệu hơn trong các mô hình, như được trình bày dưới đây từ cùng <a href="https://otexts.com/fpp3/"><em>cuốn sách của Hyndman và cộng sự</em></a>. Ví dụ, mô hình đầu tiên sử dụng 2002 để dự đoán năm 2003, mô hình thứ hai sử dụng 2002 và 2003 để dự đoán năm 2004, v.v.</p>
<p><img src="https://otexts.com/fpp2/fpp_files/figure-html/cv1-1.png"><em>hình sử dụng lại với sự cho phép của các tác giả</em></p>
<p>Dưới đây chúng ta sử dụng hàm <code>map()</code> từ package <strong>purrr</strong> để chạy vòng lặp trên từng tập dữ liệu. Sau đó, chúng ta đặt các ước tính vào một tập dữ liệu và hợp nhất với số lượng trường hợp ban đầu để sử dụng package <strong>yardstick</strong> để tính toán các đo lường về độ chính xác. Chúng ta sẽ tính toán bốn giá trị bao gồm: Root mean squared error (RMSE), Mean absolute error (MAE), Mean absolute scaled error (MASE), Mean absolute percent error (MAPE).</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1151"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Cross validation: predicting week(s) ahead based on sliding window</span>

<span class="co">## expand your data by rolling over in 52 week windows (before + after) </span>
<span class="co">## to predict 52 week ahead</span>
<span class="co">## (creates longer and longer chains of observations - keeps older data)</span>

<span class="co">## define window want to roll over</span>
<span class="va">roll_window</span> <span class="op">&lt;-</span> <span class="fl">52</span>

<span class="co">## define weeks ahead want to predict </span>
<span class="va">weeks_ahead</span> <span class="op">&lt;-</span> <span class="fl">52</span>

<span class="co">## create a data set of repeating, increasingly long data</span>
<span class="co">## label each data set with a unique id</span>
<span class="co">## only use cases before year of interest (i.e. 2011)</span>
<span class="va">case_roll</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## only keep the week and case counts variables</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## drop the last x observations </span>
    <span class="co">## depending on how many weeks ahead forecasting </span>
    <span class="co">## (otherwise will be an actual forecast to "unknown")</span>
    <span class="fu">slice</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">weeks_ahead</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## roll over each week in x after windows to create grouping ID </span>
    <span class="co">## depending on what rolling window specify</span>
    <span class="fu">stretch_tsibble</span><span class="op">(</span>.init <span class="op">=</span> <span class="va">roll_window</span>, .step <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## drop the first couple - as have no "before" cases</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">.id</span> <span class="op">&gt;</span> <span class="va">roll_window</span><span class="op">)</span>


<span class="co">## for each of the unique data sets run the code below</span>
<span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">case_roll</span><span class="op">$</span><span class="va">.id</span><span class="op">)</span>, 
                        <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co">## only keep the current fold being fit </span>
  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">case_roll</span>, <span class="va">.id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span>
  
  <span class="co">## create an empty data set for forecasting on </span>
  <span class="va">forecast_data</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>
    epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,
                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="va">weeks_ahead</span>,
                  by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,
    case_int <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">weeks_ahead</span><span class="op">)</span>,
    .id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">weeks_ahead</span><span class="op">)</span>
  <span class="op">)</span>
  
  <span class="co">## add the forecast data to the original </span>
  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">mini_data</span>, <span class="va">forecast_data</span><span class="op">)</span>
  
  <span class="co">## define the cut off based on latest non missing count data </span>
  <span class="va">cv_cut_off</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op">%&gt;%</span> 
    <span class="co">## only keep non-missing rows</span>
    <span class="fu">drop_na</span><span class="op">(</span><span class="va">case_int</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## get the latest week</span>
    <span class="fu">summarise</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## extract so is not in a dataframe</span>
    <span class="fu">pull</span><span class="op">(</span><span class="op">)</span>
  
  <span class="co">## make mini_data back in to a tsibble</span>
  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">mini_data</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span>
  
  <span class="co">## define fourier terms (sincos) </span>
  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span><span class="op">(</span>
    <span class="co">## combine fourier terms for weeks prior to  and after cut-off date</span>
    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>
      <span class="co">## get fourier terms for previous years</span>
      <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/fourier.html">fourier</a></span><span class="op">(</span>
        <span class="co">## only keep the rows before cut-off</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, 
               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>, 
        <span class="co">## include one set of sin cos terms </span>
        K <span class="op">=</span> <span class="fl">1</span>
        <span class="op">)</span>, 
      <span class="co">## predict the fourier terms for following year (using baseline data)</span>
      <span class="fu">fourier</span><span class="op">(</span>
        <span class="co">## only keep the rows before cut-off</span>
        <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, 
               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>,
        <span class="co">## include one set of sin cos terms </span>
        K <span class="op">=</span> <span class="fl">1</span>, 
        <span class="co">## predict 52 weeks ahead</span>
        h <span class="op">=</span> <span class="va">weeks_ahead</span>
        <span class="op">)</span>
      <span class="op">)</span>
    <span class="op">)</span>
  
  
  <span class="co"># split data for fitting and prediction</span>
  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op">%&gt;%</span> 
    <span class="fu">group_by</span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">group_split</span><span class="op">(</span><span class="op">)</span>

  <span class="co">## define the model you want to fit (negative binomial) </span>
  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span>
    <span class="co">## set number of cases as outcome of interest</span>
    <span class="va">case_int</span> <span class="op">~</span>
      <span class="co">## use epiweek to account for the trend</span>
      <span class="va">epiweek</span> <span class="op">+</span>
      <span class="co">## use the furier terms to account for seasonality</span>
      <span class="va">fourier</span>
  <span class="op">)</span>

  <span class="co"># define which data to use for fitting and which for predicting</span>
  <span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu">pluck</span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span>
  <span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu">pluck</span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span>
  
  <span class="co"># fit model </span>
  <span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">fitting_data</span><span class="op">)</span>
  
  <span class="co"># forecast with data want to predict with </span>
  <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">pred_data</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co">## only keep the week and the forecast estimate</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">estimate</span><span class="op">)</span>
    
  <span class="op">}</span>
  <span class="op">)</span>

<span class="co">## make the list in to a data frame with all the forecasts</span>
<span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">forecasts</span><span class="op">)</span>

<span class="co">## join the forecasts with the observed</span>
<span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span><span class="va">forecasts</span>, 
                       <span class="fu">select</span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span>,
                       by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span>

<span class="co">## using {yardstick} compute metrics</span>
  <span class="co">## RMSE: Root mean squared error</span>
  <span class="co">## MAE:  Mean absolute error  </span>
  <span class="co">## MASE: Mean absolute scaled error</span>
  <span class="co">## MAPE: Mean absolute percent error</span>
<span class="va">model_metrics</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span>
  <span class="co">## in your forcasted dataset compare the observed to the predicted</span>
  <span class="fu">rmse</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>, 
  <span class="fu">mae</span><span class="op">(</span> <span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,
  <span class="fu">mase</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,
  <span class="fu">mape</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## only keep the metric type and its output</span>
  <span class="fu">select</span><span class="op">(</span>Metric  <span class="op">=</span> <span class="va">.metric</span>, 
         Measure <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## make in to wide format so can bind rows after</span>
  <span class="fu">pivot_wider</span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Metric</span>, values_from <span class="op">=</span> <span class="va">Measure</span><span class="op">)</span>

<span class="co">## return model metrics </span>
<span class="va">model_metrics</span></code></pre></div>
<pre><code>## # A tibble: 1 x 4
##    rmse   mae  mase  mape
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  252.  199.  1.96  17.3</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="package-surveillance" class="section level3 unnumbered">
<h3>package <strong>surveillance</strong><a class="anchor" aria-label="anchor" href="#package-surveillance"><i class="fas fa-link"></i></a>
</h3>
<p>Trong phần này chúng ta sẽ sử dụng package <strong>surveillance</strong> để tạo các ngưỡng cảnh báo dựa trên thuật toán phát hiện ổ dịch. Có một số phương pháp khác có sẵn trong package, tuy nhiên chúng ta sẽ tập trung vào hai tùy chọn ở đây. Để biết chi tiết, xem các bài báo sau về <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/monitoringCounts.pdf">sự ứng dụng</a> và <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">lý thuyết</a> về các thuật toán được sử dụng.</p>
<p>Lựa chọn đầu tiên là sử dụng phương pháp Farrington cải tiến. Nó fit một mô hình nhị thức âm tổng quát (bao gồm xu hướng) và down-weights các đợt bùng phát trong quá khứ (giá trị ngoại lai) để tạo một mức ngưỡng.</p>
<p>Lựa chọn thứ hai là dùng phương pháp glrnb. Nó cũng fit một mô hình nhị thức âm tổng quát nhưng bao gồm cả xu hướng và chu kỳ fourier (vì vậy được ưu ái ở đây). Mô hình hồi quy được sử dụng để tính toán “control mean” (~fitted values) - nó sau đó sử dụng một phép thống kê tính toán likelihood ratio statistic tổng quát hóa để đánh giá nếu có sự thay đổi trung bình cho mỗi tuần. Lưu ý rằng ngưỡng cho mỗi tuần sẽ tính đến các tuần trước, vì vậy nếu có sự thay đổi liên tục, một cảnh báo sẽ được kích hoạt. (Cũng lưu ý rằng sau mỗi lần cảnh báo, thuật toán sẽ được đặt lại)</p>
<p>Để làm việc được với package <strong>surveillance</strong>, trước tiên chúng ta cần xác định đối tượng “chuỗi thời gian giám sát” (sử dụng hàm <code>sts()</code>) để fit vào bên trong framework.</p>
<div class="sourceCode" id="cb1153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define surveillance time series object</span>
<span class="co">## nb. you can include a denominator with the population object (see ?sts)</span>
<span class="va">counts_sts</span> <span class="op">&lt;-</span> <span class="fu">sts</span><span class="op">(</span>observed <span class="op">=</span> <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">]</span>,
                  start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
                    <span class="co">## subset to only keep the year from start_date </span>
                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">str_sub</span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, 
                    <span class="co">## subset to only keep the week from start_date</span>
                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu">str_sub</span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, 
                  <span class="co">## define the type of data (in this case weekly)</span>
                  freq <span class="op">=</span> <span class="fl">52</span><span class="op">)</span>

<span class="co">## define the week range that you want to include (ie. prediction period)</span>
<span class="co">## nb. the sts object only counts observations without assigning a week or </span>
<span class="co">## year identifier to them - so we use our data to define the appropriate observations</span>
<span class="va">weekrange</span> <span class="op">&lt;-</span> <span class="va">cut_off</span> <span class="op">-</span> <span class="va">start_date</span></code></pre></div>
<!-- ======================================================= -->
<div id="phương-pháp-farrington" class="section level4 unnumbered">
<h4>Phương pháp Farrington<a class="anchor" aria-label="anchor" href="#ph%C6%B0%C6%A1ng-ph%C3%A1p-farrington"><i class="fas fa-link"></i></a>
</h4>
<p>Sau đó chúng ta xác định từng tham số cho phương pháp Farrington trong một danh sách <code>list</code>. Sau đó, chúng ta chạy thuật toán bằng cách sử dụng hàm <code>farringtonFlexible()</code> và sau đó chúng ta có thể trích xuất ngưỡng cảnh báo bằng hàm <code>farringtonmethod@upperbound</code> để thêm vào tệp dữ liệu của chúng ta. Bạn cũng có thể trích xuất giá trị TRUE/FALSE cho từng tuần nếu nó kích hoạt một cảnh báo (cao hơn ngưỡng) bằng cách sử dụng <code>farringtonmethod@alarm</code>.</p>
<div class="sourceCode" id="cb1154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define control</span>
<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="co">## define what time period that want threshold for (i.e. 2011)</span>
  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,
  b <span class="op">=</span> <span class="fl">9</span>, <span class="co">## how many years backwards for baseline</span>
  w <span class="op">=</span> <span class="fl">2</span>, <span class="co">## rolling window size in weeks</span>
  weightsThreshold <span class="op">=</span> <span class="fl">2.58</span>, <span class="co">## reweighting past outbreaks (improved noufaily method - original suggests 1)</span>
  <span class="co">## pastWeeksNotIncluded = 3, ## use all weeks available (noufaily suggests drop 26)</span>
  trend <span class="op">=</span> <span class="cn">TRUE</span>,
  pThresholdTrend <span class="op">=</span> <span class="fl">1</span>, <span class="co">## 0.05 normally, however 1 is advised in the improved method (i.e. always keep)</span>
  thresholdMethod <span class="op">=</span> <span class="st">"nbPlugin"</span>,
  populationOffset <span class="op">=</span> <span class="cn">TRUE</span>
  <span class="op">)</span>

<span class="co">## apply farrington flexible method</span>
<span class="va">farringtonmethod</span> <span class="op">&lt;-</span> <span class="fu">farringtonFlexible</span><span class="op">(</span><span class="va">counts_sts</span>, <span class="va">ctrl</span><span class="op">)</span>

<span class="co">## create a new variable in the original dataset called threshold</span>
<span class="co">## containing the upper bound from farrington </span>
<span class="co">## nb. this is only for the weeks in 2011 (so need to subset rows)</span>
<span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> 
               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,
              <span class="st">"threshold"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">farringtonmethod</span><span class="op">@</span><span class="va">upperbound</span></code></pre></div>
<p>Sau đó, chúng ta có thể trực quan hóa kết quả với ggplot như đã thực hiện ở trên.</p>
<div class="sourceCode" id="cb1155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">counts</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in observed case counts as a line</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in upper bound of aberration algorithm</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, 
            linetype <span class="op">=</span> <span class="st">"dashed"</span>, 
            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## define colours</span>
  <span class="fu">scale_colour_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, 
                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make a traditional plot (with black axes and white background)</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## remove title of legend </span>
  <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_farrington-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="phương-pháp-glrnb" class="section level4 unnumbered">
<h4>Phương pháp GLRNB<a class="anchor" aria-label="anchor" href="#ph%C6%B0%C6%A1ng-ph%C3%A1p-glrnb"><i class="fas fa-link"></i></a>
</h4>
<p>Tương tự với phương pháp GLRNB, chúng ta xác định từng tham số vào một danh sách <code>list</code>, sau đó fit thuật toán và trích xuất các giới hạn trên.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Phương pháp này sử dụng “brute force” (tương tự như bootstrapping) để tính toán các ngưỡng, vì vậy có thể mất nhiều thời gian!</span></p>
<p>Xem <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">GLRNB vignette</a> để biết thêm chi tiết.</p>
<div class="sourceCode" id="cb1156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define control options</span>
<span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  <span class="co">## define what time period that want threshold for (i.e. 2011)</span>
  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,
  mu0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">1</span>,    <span class="co">## number of fourier terms (harmonics) to include</span>
  trend <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co">## whether to include trend or not</span>
  refit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="co">## whether to refit model after each alarm</span>
  <span class="co">## cARL = threshold for GLR statistic (arbitrary)</span>
     <span class="co">## 3 ~ middle ground for minimising false positives</span>
     <span class="co">## 1 fits to the 99%PI of glm.nb - with changes after peaks (threshold lowered for alert)</span>
   c.ARL <span class="op">=</span> <span class="fl">2</span>,
   <span class="co"># theta = log(1.5), ## equates to a 50% increase in cases in an outbreak</span>
   ret <span class="op">=</span> <span class="st">"cases"</span>     <span class="co">## return threshold upperbound as case counts</span>
  <span class="op">)</span>

<span class="co">## apply the glrnb method</span>
<span class="va">glrnbmethod</span> <span class="op">&lt;-</span> <span class="fu">glrnb</span><span class="op">(</span><span class="va">counts_sts</span>, control <span class="op">=</span> <span class="va">ctrl</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co">## create a new variable in the original dataset called threshold</span>
<span class="co">## containing the upper bound from glrnb </span>
<span class="co">## nb. this is only for the weeks in 2011 (so need to subset rows)</span>
<span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> 
               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,
              <span class="st">"threshold_glrnb"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">glrnbmethod</span><span class="op">@</span><span class="va">upperbound</span></code></pre></div>
<p>Trực quan hóa kết quả đầu ra như bên trên.</p>
<div class="sourceCode" id="cb1157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">counts</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in observed case counts as a line</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in upper bound of aberration algorithm</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold_glrnb</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, 
            linetype <span class="op">=</span> <span class="st">"dashed"</span>, 
            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span>
  <span class="co">## define colours</span>
  <span class="fu">scale_colour_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, 
                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make a traditional plot (with black axes and white background)</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## remove title of legend </span>
  <span class="fu">theme</span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu">element_blank</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_glrnb-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="chuỗi-thời-gian-bị-gián-đoạn" class="section level2" number="23.8">
<h2>
<span class="header-section-number">23.8</span> Chuỗi thời gian bị gián đoạn<a class="anchor" aria-label="anchor" href="#chu%E1%BB%97i-th%E1%BB%9Di-gian-b%E1%BB%8B-gi%C3%A1n-%C4%91o%E1%BA%A1n"><i class="fas fa-link"></i></a>
</h2>
<p>Chuỗi thời gian bị gián đoạn (còn được gọi là hồi quy phân đoạn hoặc phân tích can thiệp), thường được sử dụng để đánh giá tác động của vắc-xin đối với tỷ lệ mắc mới của bệnh. Nhưng nó có thể được sử dụng để đánh giá tác động của một loạt các can thiệp hoặc sự giới thiệu. Ví dụ như những thay đổi trong quy trình của bệnh viện hoặc sự xuất hiện của chủng bệnh mới vào quần thể. Trong ví dụ này, chúng ta sẽ giả định rằng một chủng mới của Campylobacter đã xuất hiện ở Đức vào cuối năm 2008, và xem liệu điều đó có ảnh hưởng đến số lượng trường hợp. Chúng ta sẽ sử dụng hồi quy nhị thức âm một lần nữa. Sự hồi quy lần này sẽ được chia thành hai phần, một phần trước khi can thiệp (hoặc sự xuất hiện của chủng mới) và một phần sau (trước và sau giai đoạn). Điều này cho phép chúng ta tính toán tỷ số tỷ lệ mới mắc giữa hai khoảng thời gian. Giải thích phương trình có thể làm cho điều này rõ ràng hơn (nếu không thì chỉ cần bỏ qua!).</p>
<p>Hồi quy nhị thức âm có thể được định nghĩa như sau:</p>
<p><span class="math display">\[\log(Y_t)= β_0 + β_1 \times t+ β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+ + log(pop_t) + e_t\]</span></p>
<p>Trong đó:</p>
<p><span class="math inline">\(Y_t\)</span> là số trường hợp quan sát được tại thời điểm <span class="math inline">\(t\)</span></p>
<p><span class="math inline">\(pop_t\)</span> nếu kích thước quần thể trong 100,000s tại thời điểm <span class="math inline">\(t\)</span> (không sử dụng tại đây)</p>
<p><span class="math inline">\(t_0\)</span> là năm cuối cùng của giai đoạn trước (bao gồm cả thời gian chuyển tiếp nếu có)</p>
<p><span class="math inline">\(δ(x\)</span> là hàm chỉ báo (nó là 0 nếu x ≤ 0 và 1 nếu x &gt; 0)</p>
<p><span class="math inline">\((x)^+\)</span> là toán tử cut off (nó là x nếu x &gt; 0 và ngược lại sẽ bằng 0)</p>
<p><span class="math inline">\(e_t\)</span> biểu thị phần dư</p>
<p>Các chu kỳ bổ sung có xu hướng hoặc theo mùa có thể được thêm vào nếu cần thiết.</p>
<p><span class="math inline">\(β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+\)</span> là một phần của mô hình tuyến tỉnh tổng quát hóa của giai đoạn sau và bằng không ở giai đoạn trước. Điều này có nghĩa là <span class="math inline">\(β_2\)</span> và <span class="math inline">\(β_3\)</span> ước tính các hiệu quả của can thiệp.</p>
<p>Chúng ta cần tính toán lại chu kỳ Fourier mà không có dự báo ở đây, vì chúng ta sẽ sử dụng tất cả dữ liệu có sẵn (vd: hồi cứu). Ngoài ra, chúng ta cần tính toán các điều khoản bổ sung cần thiết cho hồi quy. thực tế là chúng ta cần tính chu kỳ mở rộng (extra terms) cho đường hồi quy.</p>
<div class="sourceCode" id="cb1158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## add in fourier terms using the epiweek and case_int variabless</span>
<span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>

<span class="co">## define intervention week </span>
<span class="va">intervention_week</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2008-12-31"</span><span class="op">)</span>

<span class="co">## define variables for regression </span>
<span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>
    <span class="co">## corresponds to t in the formula</span>
      <span class="co">## count of weeks (could probably also just use straight epiweeks var)</span>
    <span class="co"># linear = row_number(epiweek), </span>
    <span class="co">## corresponds to delta(t-t0) in the formula</span>
      <span class="co">## pre or post intervention period</span>
    intervention <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">intervention_week</span><span class="op">)</span>, 
    <span class="co">## corresponds to (t-t0)^+ in the formula</span>
      <span class="co">## count of weeks post intervention</span>
      <span class="co">## (choose the larger number between 0 and whatever comes from calculation)</span>
    time_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">epiweek</span> <span class="op">-</span> <span class="va">intervention_week</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Chúng ta sau đó sử dụng các chi kỳ này để fit một mô hình hồi quy nhị thức âm, và tạo một bảng với phần trăm thay đổi. Những gì ví dụ này cho thấy là không có thay đổi đáng kể.</p>
<p><span style="color: orange;"><strong><em>CẨN TRỌNG:</em></strong> Lưu ý cách sử dụng của đối số <code>simulate_pi = FALSE</code> bên trong hàm <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Điều này là bởi hành vi mặc định của <strong>trending</strong> là sử dụng package <strong>ciTools</strong> để ước tính khoảng tiên lượng. Nó sẽ không hoạt động nếu có giá trị <code>NA</code>, cũng như tạo ra nhiều khoảng chi tiết hơn. Xem <code><a href="https://rdrr.io/pkg/trending/man/trending_model_fit-prediction.html">?trending::predict.trending_model_fit</a></code> để biết thêm chi tiết. </span></p>
<div class="sourceCode" id="cb1159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## define the model you want to fit (negative binomial) </span>
<span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span>
  <span class="co">## set number of cases as outcome of interest</span>
  <span class="va">case_int</span> <span class="op">~</span>
    <span class="co">## use epiweek to account for the trend</span>
    <span class="va">epiweek</span> <span class="op">+</span>
    <span class="co">## use the furier terms to account for seasonality</span>
    <span class="va">fourier</span> <span class="op">+</span> 
    <span class="co">## add in whether in the pre- or post-period </span>
    <span class="va">intervention</span> <span class="op">+</span> 
    <span class="co">## add in the time post intervention </span>
    <span class="va">time_post</span>
    <span class="op">)</span>

<span class="co">## fit your model using the counts dataset</span>
<span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">counts</span><span class="op">)</span>

<span class="co">## calculate confidence intervals and prediction intervals </span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>



<span class="co">## show estimates and percentage change in a table</span>
<span class="va">fitted_model</span> <span class="op">%&gt;%</span> 
  <span class="co">## extract original negative binomial regression</span>
  <span class="fu">get_model</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## get a tidy dataframe of results</span>
  <span class="fu">tidy</span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, 
       conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## only keep the intervention value </span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"intervention"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## change the IRR to percentage change for estimate and CIs </span>
  <span class="fu">mutate</span><span class="op">(</span>
    <span class="co">## for each of the columns of interest - create a new column</span>
    <span class="fu">across</span><span class="op">(</span>
      <span class="fu">all_of</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span><span class="op">)</span><span class="op">)</span>, 
      <span class="co">## apply the formula to calculate percentage change</span>
            .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, 
      <span class="co">## add a suffix to new column names with "_perc"</span>
      .names <span class="op">=</span> <span class="st">"{.col}_perc"</span><span class="op">)</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="co">## only keep (and rename) certain columns </span>
  <span class="fu">select</span><span class="op">(</span><span class="st">"IRR"</span> <span class="op">=</span> <span class="va">estimate</span>, 
         <span class="st">"95%CI low"</span> <span class="op">=</span> <span class="va">conf.low</span>, 
         <span class="st">"95%CI high"</span> <span class="op">=</span> <span class="va">conf.high</span>,
         <span class="st">"Percentage change"</span> <span class="op">=</span> <span class="va">estimate_perc</span>, 
         <span class="st">"95%CI low (perc)"</span> <span class="op">=</span> <span class="va">conf.low_perc</span>, 
         <span class="st">"95%CI high (perc)"</span> <span class="op">=</span> <span class="va">conf.high_perc</span>,
         <span class="st">"p-value"</span> <span class="op">=</span> <span class="va">p.value</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 7
##       IRR `95%CI low` `95%CI high` `Percentage change` `95%CI low (perc)` `95%CI high (perc)` `p-value`
##     &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt;               &lt;dbl&gt;     &lt;dbl&gt;
## 1 -0.0661      -0.135      0.00305               -107.              -113.               -99.7    0.0645</code></pre>
<p>Như bên trên, chúng ta có thể trực quan hóa các đầu ra của mô hình hồi quy.</p>
<div class="sourceCode" id="cb1161"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">ggplot</span><span class="op">(</span><span class="va">observed</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in observed case counts as a line</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a line for the model estimate</span>
  <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span>, col <span class="op">=</span> <span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add in a band for the prediction intervals </span>
  <span class="fu">geom_ribbon</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, 
                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, 
              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## add vertical line and label to show where forecasting started</span>
  <span class="fu">geom_vline</span><span class="op">(</span>
           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">intervention_week</span><span class="op">)</span>, 
           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">annotate</span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, 
           label <span class="op">=</span> <span class="st">"Intervention"</span>, 
           x <span class="op">=</span> <span class="va">intervention_week</span>, 
           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span>, 
           angle <span class="op">=</span> <span class="fl">90</span>, 
           vjust <span class="op">=</span> <span class="fl">1</span>
           <span class="op">)</span> <span class="op">+</span> 
  <span class="co">## define colours</span>
  <span class="fu">scale_colour_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, 
                                 <span class="st">"Estimate"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="co">## make a traditional plot (with black axes and white background)</span>
  <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 13 row(s) containing missing values (geom_path).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/plot_interrupted-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="nguồn-tham-khảo-1" class="section level2" number="23.9">
<h2>
<span class="header-section-number">23.9</span> Nguồn tham khảo<a class="anchor" aria-label="anchor" href="#ngu%E1%BB%93n-tham-kh%E1%BA%A3o-1"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://otexts.com/fpp3/">forecasting: principles and practice textbook</a><br><a href="https://github.com/EPIET/TimeSeriesAnalysis">EPIET timeseries analysis case studies</a><br><a href="https://online.stat.psu.edu/stat510/lesson/1">Penn State course</a>
<a href="https://www.jstatsoft.org/article/view/v070i10">Surveillance package manuscript</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="moving-average.html"><span class="header-section-number">22</span> Đường trung bình động</a></div>
<div class="next"><a href="epidemic-models.html"><span class="header-section-number">24</span> Mô hình hóa dịch bệnh</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#time-series"><span class="header-section-number">23</span> Chuỗi thời gian và phát hiện ổ dịch</a></li>
<li><a class="nav-link" href="#t%E1%BB%95ng-quan-2"><span class="header-section-number">23.1</span> Tổng quan</a></li>
<li>
<a class="nav-link" href="#chu%E1%BA%A9n-b%E1%BB%8B-13"><span class="header-section-number">23.2</span> Chuẩn bị</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#packages-1">Packages</a></li>
<li><a class="nav-link" href="#nh%E1%BA%ADp-d%E1%BB%AF-li%E1%BB%87u-12">Nhập dữ liệu</a></li>
<li><a class="nav-link" href="#l%C3%A0m-s%E1%BA%A1ch-d%E1%BB%AF-li%E1%BB%87u">Làm sạch dữ liệu</a></li>
<li><a class="nav-link" href="#t%E1%BA%A3i-xu%E1%BB%91ng-d%E1%BB%AF-li%E1%BB%87u-kh%C3%AD-h%E1%BA%ADu">Tải xuống dữ liệu khí hậu</a></li>
<li><a class="nav-link" href="#nh%E1%BA%ADp-d%E1%BB%AF-li%E1%BB%87u-kh%C3%AD-h%E1%BA%ADu">Nhập dữ liệu khí hậu</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#d%E1%BB%AF-li%E1%BB%87u-chu%E1%BB%97i-th%E1%BB%9Di-gian"><span class="header-section-number">23.3</span> Dữ liệu chuỗi thời gian</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#tr%C3%B9ng-l%E1%BA%B7p">Trùng lặp</a></li>
<li><a class="nav-link" href="#b%E1%BA%A3n-ghi-b%E1%BB%8B-thi%E1%BA%BFu">Bản ghi bị thiếu</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ph%C3%A2n-t%C3%ADch-m%C3%B4-t%E1%BA%A3"><span class="header-section-number">23.4</span> Phân tích mô tả</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#timeseries_moving">Đường trung bình động</a></li>
<li><a class="nav-link" href="#t%C3%ADnh-chu-k%E1%BB%B3">Tính chu kỳ</a></li>
<li><a class="nav-link" href="#t%C3%A1ch-nh%E1%BB%8F-chu%E1%BB%97i-th%E1%BB%9Di-gian">Tách nhỏ chuỗi thời gian</a></li>
<li><a class="nav-link" href="#t%E1%BB%B1-t%C6%B0%C6%A1ng-quan">Tự tương quan</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#fit-m%C3%B4-h%C3%ACnh-h%E1%BB%93i-quy"><span class="header-section-number">23.5</span> Fit mô hình hồi quy</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#chu-k%E1%BB%B3-fourier">Chu kỳ Fourier</a></li>
<li><a class="nav-link" href="#h%E1%BB%93i-quy-nh%E1%BB%8B-th%E1%BB%A9c-%C3%A2m">Hồi quy nhị thức âm</a></li>
<li><a class="nav-link" href="#ph%E1%BA%A7n-d%C6%B0">Phần dư</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#m%E1%BB%91i-quan-h%E1%BB%87-c%E1%BB%A7a-hai-chu%E1%BB%97i-th%E1%BB%9Di-gian"><span class="header-section-number">23.6</span> Mối quan hệ của hai chuỗi thời gian</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#n%E1%BB%91i-hai-b%E1%BB%99-d%E1%BB%AF-li%E1%BB%87u">Nối hai bộ dữ liệu</a></li>
<li><a class="nav-link" href="#ph%C3%A2n-t%C3%ADch-m%C3%B4-t%E1%BA%A3-1">Phân tích mô tả</a></li>
<li><a class="nav-link" href="#lags-v%C3%A0-t%C6%B0%C6%A1ng-quan-ch%C3%A9o">Lags và tương quan chéo</a></li>
<li><a class="nav-link" href="#h%E1%BB%93i-quy-nh%E1%BB%8B-th%E1%BB%A9c-%C3%A2m-v%E1%BB%9Bi-hai-bi%E1%BA%BFn-s%E1%BB%91">Hồi quy nhị thức âm với hai biến số</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ph%C3%A1t-hi%E1%BB%87n-%E1%BB%95-d%E1%BB%8Bch"><span class="header-section-number">23.7</span> Phát hiện ổ dịch</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#package-trending">Package trending</a></li>
<li><a class="nav-link" href="#package-surveillance">package surveillance</a></li>
</ul>
</li>
<li><a class="nav-link" href="#chu%E1%BB%97i-th%E1%BB%9Di-gian-b%E1%BB%8B-gi%C3%A1n-%C4%91o%E1%BA%A1n"><span class="header-section-number">23.8</span> Chuỗi thời gian bị gián đoạn</a></li>
<li><a class="nav-link" href="#ngu%E1%BB%93n-tham-kh%E1%BA%A3o-1"><span class="header-section-number">23.9</span> Nguồn tham khảo</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Cẩm nang dịch tễ học với R</strong>" was written by the handbook team. It was last built on 2021-09-19.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
