<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>23 Chuỗi thời gian và phát hiện ổ dịch | Sổ tay dịch tễ học với R</title>

    <meta name="author" content="the handbook team" />
  
  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script>
  <script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script>
    <script src="libs/header-attrs-2.6.4/header-attrs.js"></script>
    <script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet" />
    <script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script>
    <script src="libs/bs3compat-0.2.5.1/tabs.js"></script>
    <script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script>
    <link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet" />
    <script src="libs/bs4_book-1.0.0/bs4_book.js"></script>
    <script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
    <link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
    <script src="libs/datatables-binding-0.16/datatables.js"></script>
    <link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
    <link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
    <script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
    <link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
    <script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
    <link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
    <script src="libs/selectize-0.12.0/selectize.min.js"></script>
    <link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>
    <script src="libs/kePrint-0.0.1/kePrint.js"></script>
    <link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
    <link href="libs/tabwid-1.0.0/tabwid.css" rel="stylesheet" />
    <script src="libs/tabwid-1.0.0/tabwid.js"></script>
    <link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-1.3.1/leaflet.js"></script>
    <link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
    <script src="libs/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
    <script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
    <link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-binding-2.0.3/leaflet.js"></script>
    <script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
    <script src="libs/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>
    <script src="libs/viz-1.8.2/viz.js"></script>
    <link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet" />
    <script src="libs/grViz-binding-1.0.6.1/grViz.js"></script>
    <script src="libs/d3-4.5.0/d3.min.js"></script>
    <script src="libs/sankey-1/sankey.js"></script>
    <script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>
    <script src="libs/plotly-binding-4.9.2.1/plotly.js"></script>
    <script src="libs/typedarray-0.1/typedarray.min.js"></script>
    <link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
    <script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>
    <link href="libs/vis-4.20.1/vis.css" rel="stylesheet" />
    <script src="libs/vis-4.20.1/vis.min.js"></script>
    <script src="libs/visNetwork-binding-2.0.9/visNetwork.js"></script>
    <link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script src="libs/plotly-basic-1.52.2/plotly-basic-1.52.2.min.js"></script>
    <script src="libs/plotly-cartesian-1.52.2/plotly-cartesian-1.52.2.min.js"></script>
    <script src="libs/proj4js-2.3.15/proj4.js"></script>
    <link href="libs/highcharts-8.1.2/css/motion.css" rel="stylesheet" />
    <script src="libs/highcharts-8.1.2/highcharts.js"></script>
    <script src="libs/highcharts-8.1.2/highcharts-3d.js"></script>
    <script src="libs/highcharts-8.1.2/highcharts-more.js"></script>
    <script src="libs/highcharts-8.1.2/modules/stock.js"></script>
    <script src="libs/highcharts-8.1.2/modules/map.js"></script>
    <script src="libs/highcharts-8.1.2/modules/annotations.js"></script>
    <script src="libs/highcharts-8.1.2/modules/data.js"></script>
    <script src="libs/highcharts-8.1.2/modules/drilldown.js"></script>
    <script src="libs/highcharts-8.1.2/modules/item-series.js"></script>
    <script src="libs/highcharts-8.1.2/modules/offline-exporting.js"></script>
    <script src="libs/highcharts-8.1.2/modules/overlapping-datalabels.js"></script>
    <script src="libs/highcharts-8.1.2/modules/exporting.js"></script>
    <script src="libs/highcharts-8.1.2/modules/export-data.js"></script>
    <script src="libs/highcharts-8.1.2/modules/funnel.js"></script>
    <script src="libs/highcharts-8.1.2/modules/heatmap.js"></script>
    <script src="libs/highcharts-8.1.2/modules/treemap.js"></script>
    <script src="libs/highcharts-8.1.2/modules/sankey.js"></script>
    <script src="libs/highcharts-8.1.2/modules/dependency-wheel.js"></script>
    <script src="libs/highcharts-8.1.2/modules/organization.js"></script>
    <script src="libs/highcharts-8.1.2/modules/solid-gauge.js"></script>
    <script src="libs/highcharts-8.1.2/modules/streamgraph.js"></script>
    <script src="libs/highcharts-8.1.2/modules/sunburst.js"></script>
    <script src="libs/highcharts-8.1.2/modules/vector.js"></script>
    <script src="libs/highcharts-8.1.2/modules/wordcloud.js"></script>
    <script src="libs/highcharts-8.1.2/modules/xrange.js"></script>
    <script src="libs/highcharts-8.1.2/modules/tilemap.js"></script>
    <script src="libs/highcharts-8.1.2/modules/venn.js"></script>
    <script src="libs/highcharts-8.1.2/modules/gantt.js"></script>
    <script src="libs/highcharts-8.1.2/modules/timeline.js"></script>
    <script src="libs/highcharts-8.1.2/modules/parallel-coordinates.js"></script>
    <script src="libs/highcharts-8.1.2/modules/bullet.js"></script>
    <script src="libs/highcharts-8.1.2/modules/coloraxis.js"></script>
    <script src="libs/highcharts-8.1.2/modules/dumbbell.js"></script>
    <script src="libs/highcharts-8.1.2/modules/lollipop.js"></script>
    <script src="libs/highcharts-8.1.2/modules/series-label.js"></script>
    <script src="libs/highcharts-8.1.2/plugins/motion.js"></script>
    <script src="libs/highcharts-8.1.2/custom/reset.js"></script>
    <script src="libs/highcharts-8.1.2/modules/boost.js"></script>
    <script src="libs/highchart-binding-0.8.2/highchart.js"></script>
    <script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>

  <!-- CSS -->
    <link rel="stylesheet" href="style_bs4.css" />
    
</head>

<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book">
    <a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Sổ tay dịch tễ học với R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
      </form>

      <nav aria-label="Table of contents">
        <h2>Table of contents</h2>
        <div id="book-toc"></div>

        <div class="book-extra">
          <p><a id="book-repo" href="#">View book source <i class="fab fa-github"></i></a></li></p>
        </div>
      </nav>
    </div>
  </header>

  <main class="col-sm-12 col-md-9 col-lg-7" id="content">
<div id="time-series" class="section level1" number="23">
<h1><span class="header-section-number">23</span> Chuỗi thời gian và phát hiện ổ dịch</h1>
<!-- ======================================================= -->
<div id="overview-2" class="section level2" number="23.1">
<h2><span class="header-section-number">23.1</span> Overview</h2>
<p>This tab demonstrates the use of several packages for time series analysis.
It primarily relies on packages from the <a href="https://tidyverts.org/"><strong>tidyverts</strong></a>
family, but will also use the RECON <a href="https://github.com/reconhub/trending"><strong>trending</strong></a>
package to fit models that are more appropriate for infectious disease epidemiology.</p>
<p>Note in the below example we use a dataset from the <strong>surveillance</strong> package
on Campylobacter in Germany (see the <a href="https://epirhandbook.com/download-handbook-and-data.html">data chapter</a>,
of the handbook for details). However, if you wanted to run the same code on a dataset
with multiple countries or other strata, then there is an example code template for this in the
<a href="https://github.com/R4EPI/epitsa">r4epis github repo</a>.</p>
<p>Topics covered include:</p>
<ol style="list-style-type: decimal">
<li>Time series data</li>
<li>Descriptive analysis</li>
<li>Fitting regressions</li>
<li>Relation of two time series</li>
<li>Outbreak detection</li>
<li>Interrupted time series</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="preparation-13" class="section level2" number="23.2">
<h2><span class="header-section-number">23.2</span> Preparation</h2>
<div id="packages-2" class="section level3 unnumbered">
<h3>Packages</h3>
<p>This code chunk shows the loading of packages required for the analyses. In this handbook we emphasize <code>p_load()</code> from <strong>pacman</strong>, which installs the package if necessary <em>and</em> loads it for use. You can also load packages with <code>library()</code> from <strong>base</strong> R. See the page on <a href="https://epirhandbook.com/r-basics.html">R basics</a> for more information on R packages.</p>
<div class="sourceCode" id="cb1097"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1097-1"><a href="time-series.html#cb1097-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(rio,          <span class="co"># File import</span></span>
<span id="cb1097-2"><a href="time-series.html#cb1097-2" aria-hidden="true" tabindex="-1"></a>               here,         <span class="co"># File locator</span></span>
<span id="cb1097-3"><a href="time-series.html#cb1097-3" aria-hidden="true" tabindex="-1"></a>               tidyverse,    <span class="co"># data management + ggplot2 graphics</span></span>
<span id="cb1097-4"><a href="time-series.html#cb1097-4" aria-hidden="true" tabindex="-1"></a>               tsibble,      <span class="co"># handle time series datasets</span></span>
<span id="cb1097-5"><a href="time-series.html#cb1097-5" aria-hidden="true" tabindex="-1"></a>               slider,       <span class="co"># for calculating moving averages</span></span>
<span id="cb1097-6"><a href="time-series.html#cb1097-6" aria-hidden="true" tabindex="-1"></a>               imputeTS,     <span class="co"># for filling in missing values</span></span>
<span id="cb1097-7"><a href="time-series.html#cb1097-7" aria-hidden="true" tabindex="-1"></a>               feasts,       <span class="co"># for time series decomposition and autocorrelation</span></span>
<span id="cb1097-8"><a href="time-series.html#cb1097-8" aria-hidden="true" tabindex="-1"></a>               forecast,     <span class="co"># fit sin and cosin terms to data (note: must load after feasts)</span></span>
<span id="cb1097-9"><a href="time-series.html#cb1097-9" aria-hidden="true" tabindex="-1"></a>               trending,     <span class="co"># fit and assess models </span></span>
<span id="cb1097-10"><a href="time-series.html#cb1097-10" aria-hidden="true" tabindex="-1"></a>               tmaptools,    <span class="co"># for getting geocoordinates (lon/lat) based on place names</span></span>
<span id="cb1097-11"><a href="time-series.html#cb1097-11" aria-hidden="true" tabindex="-1"></a>               ecmwfr,       <span class="co"># for interacting with copernicus sateliate CDS API</span></span>
<span id="cb1097-12"><a href="time-series.html#cb1097-12" aria-hidden="true" tabindex="-1"></a>               stars,        <span class="co"># for reading in .nc (climate data) files</span></span>
<span id="cb1097-13"><a href="time-series.html#cb1097-13" aria-hidden="true" tabindex="-1"></a>               units,        <span class="co"># for defining units of measurement (climate data)</span></span>
<span id="cb1097-14"><a href="time-series.html#cb1097-14" aria-hidden="true" tabindex="-1"></a>               yardstick,    <span class="co"># for looking at model accuracy</span></span>
<span id="cb1097-15"><a href="time-series.html#cb1097-15" aria-hidden="true" tabindex="-1"></a>               surveillance  <span class="co"># for aberration detection</span></span>
<span id="cb1097-16"><a href="time-series.html#cb1097-16" aria-hidden="true" tabindex="-1"></a>               )</span></code></pre></div>
</div>
<div id="load-data" class="section level3 unnumbered">
<h3>Load data</h3>
<p>You can download all the data used in this handbook via the instructions in the [Download handbook and data] page.</p>
<p>The example dataset used in this section is weekly counts of campylobacter cases reported in Germany between 2001 and 2011. <a href='https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/time_series/campylobacter_germany.xlsx' class='download-button'>
You can click here to download<span> this data file (.xlsx).</span></a></p>
<p>This dataset is a reduced version of the dataset available in the <a href="https://cran.r-project.org/web/packages/surveillance/"><strong>surveillance</strong></a> package.
(for details load the surveillance package and see <code>?campyDE</code>)</p>
<p>Import these data with the <code>import()</code> function from the <strong>rio</strong> package (it handles many file types like .xlsx, .csv, .rds - see the [Import and export] page for details).</p>
<div class="sourceCode" id="cb1098"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1098-1"><a href="time-series.html#cb1098-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import the counts into R</span></span>
<span id="cb1098-2"><a href="time-series.html#cb1098-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> rio<span class="sc">::</span><span class="fu">import</span>(<span class="st">&quot;campylobacter_germany.xlsx&quot;</span>)</span></code></pre></div>
<p>The first 10 rows of the counts are displayed below.</p>
<div id="htmlwidget-0e9e6eedf79583958668" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-0e9e6eedf79583958668">{"x":{"filter":"none","data":[["2001-12-31T00:00:00Z","2002-01-07T00:00:00Z","2002-01-14T00:00:00Z","2002-01-21T00:00:00Z","2002-01-28T00:00:00Z","2002-02-04T00:00:00Z","2002-02-11T00:00:00Z","2002-02-18T00:00:00Z","2002-02-25T00:00:00Z","2002-03-04T00:00:00Z"],[514,913,1023,887,815,792,803,807,692,705]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date<\/th>\n      <th>case<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="clean-data-1" class="section level3 unnumbered">
<h3>Clean data</h3>
<p>The code below makes sure that the date column is in the appropriate format.
For this tab we will be using the <strong>tsibble</strong> package and so the <code>yearweek</code>
function will be used to create a calendar week variable. There are several other
ways of doing this (see the <a href="https://epirhandbook.com/working-with-dates.html">Working with dates</a>
page for details), however for time series its best to keep within one framework (<strong>tsibble</strong>).</p>
<div class="sourceCode" id="cb1099"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1099-1"><a href="time-series.html#cb1099-1" aria-hidden="true" tabindex="-1"></a><span class="do">## ensure the date column is in the appropriate format</span></span>
<span id="cb1099-2"><a href="time-series.html#cb1099-2" aria-hidden="true" tabindex="-1"></a>counts<span class="sc">$</span>date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(counts<span class="sc">$</span>date)</span>
<span id="cb1099-3"><a href="time-series.html#cb1099-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1099-4"><a href="time-series.html#cb1099-4" aria-hidden="true" tabindex="-1"></a><span class="do">## create a calendar week variable </span></span>
<span id="cb1099-5"><a href="time-series.html#cb1099-5" aria-hidden="true" tabindex="-1"></a><span class="do">## fitting ISO definitons of weeks starting on a monday</span></span>
<span id="cb1099-6"><a href="time-series.html#cb1099-6" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1099-7"><a href="time-series.html#cb1099-7" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">epiweek =</span> <span class="fu">yearweek</span>(date, <span class="at">week_start =</span> <span class="dv">1</span>))</span></code></pre></div>
</div>
<div id="download-climate-data" class="section level3 unnumbered">
<h3>Download climate data</h3>
<p>In the <em>relation of two time series</em> section of this page, we will be comparing
campylobacter case counts to climate data.</p>
<p>Climate data for anywhere in the world can be downloaded from the EU’s Copernicus
Satellite. These are not exact measurements, but based on a model (similar to
interpolation), however the benefit is global hourly coverage as well as forecasts.</p>
<p>You can download each of these climate data files from the [Download handbook and data] page.</p>
<p>For purposes of demonstration here, we will show R code to use the <strong>ecmwfr</strong> package to pull these data from the Copernicus
climate data store. You will need to create a free account in order for this to
work. The package website has a useful <a href="https://github.com/bluegreen-labs/ecmwfr#use-copernicus-climate-data-store-cds">walkthrough</a>
of how to do this. Below is example code of how to go about doing this, once you
have the appropriate API keys. You have to replace the X’s below with your account
IDs. You will need to download one year of data at a time otherwise the server times-out.</p>
<p>If you are not sure of the coordinates for a location you want to download data
for, you can use the <strong>tmaptools</strong> package to pull the coordinates off open street
maps. An alternative option is the <a href="https://github.com/rCarto/photon"><strong>photon</strong></a>
package, however this has not been released on to CRAN yet; the nice thing about
<strong>photon</strong> is that it provides more contextual data for when there are several
matches for your search.</p>
<div class="sourceCode" id="cb1100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1100-1"><a href="time-series.html#cb1100-1" aria-hidden="true" tabindex="-1"></a><span class="do">## retrieve location coordinates</span></span>
<span id="cb1100-2"><a href="time-series.html#cb1100-2" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">geocode_OSM</span>(<span class="st">&quot;Germany&quot;</span>, <span class="at">geometry =</span> <span class="st">&quot;point&quot;</span>)</span>
<span id="cb1100-3"><a href="time-series.html#cb1100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1100-4"><a href="time-series.html#cb1100-4" aria-hidden="true" tabindex="-1"></a><span class="do">## pull together long/lats in format for ERA-5 querying (bounding box) </span></span>
<span id="cb1100-5"><a href="time-series.html#cb1100-5" aria-hidden="true" tabindex="-1"></a><span class="do">## (as just want a single point can repeat coords)</span></span>
<span id="cb1100-6"><a href="time-series.html#cb1100-6" aria-hidden="true" tabindex="-1"></a>request_coords <span class="ot">&lt;-</span> <span class="fu">str_glue_data</span>(coords<span class="sc">$</span>coords, <span class="st">&quot;{y}/{x}/{y}/{x}&quot;</span>)</span>
<span id="cb1100-7"><a href="time-series.html#cb1100-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1100-8"><a href="time-series.html#cb1100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1100-9"><a href="time-series.html#cb1100-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Pulling data modelled from copernicus satellite (ERA-5 reanalysis)</span></span>
<span id="cb1100-10"><a href="time-series.html#cb1100-10" aria-hidden="true" tabindex="-1"></a><span class="do">## https://cds.climate.copernicus.eu/cdsapp#!/software/app-era5-explorer?tab=app</span></span>
<span id="cb1100-11"><a href="time-series.html#cb1100-11" aria-hidden="true" tabindex="-1"></a><span class="do">## https://github.com/bluegreen-labs/ecmwfr</span></span>
<span id="cb1100-12"><a href="time-series.html#cb1100-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1100-13"><a href="time-series.html#cb1100-13" aria-hidden="true" tabindex="-1"></a><span class="do">## set up key for weather data </span></span>
<span id="cb1100-14"><a href="time-series.html#cb1100-14" aria-hidden="true" tabindex="-1"></a><span class="fu">wf_set_key</span>(<span class="at">user =</span> <span class="st">&quot;XXXXX&quot;</span>,</span>
<span id="cb1100-15"><a href="time-series.html#cb1100-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">key =</span> <span class="st">&quot;XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXX&quot;</span>,</span>
<span id="cb1100-16"><a href="time-series.html#cb1100-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">service =</span> <span class="st">&quot;cds&quot;</span>) </span>
<span id="cb1100-17"><a href="time-series.html#cb1100-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1100-18"><a href="time-series.html#cb1100-18" aria-hidden="true" tabindex="-1"></a><span class="do">## run for each year of interest (otherwise server times out)</span></span>
<span id="cb1100-19"><a href="time-series.html#cb1100-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2002</span><span class="sc">:</span><span class="dv">2011</span>) {</span>
<span id="cb1100-20"><a href="time-series.html#cb1100-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1100-21"><a href="time-series.html#cb1100-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## pull together a query </span></span>
<span id="cb1100-22"><a href="time-series.html#cb1100-22" aria-hidden="true" tabindex="-1"></a>  <span class="do">## see here for how to do: https://bluegreen-labs.github.io/ecmwfr/articles/cds_vignette.html#the-request-syntax</span></span>
<span id="cb1100-23"><a href="time-series.html#cb1100-23" aria-hidden="true" tabindex="-1"></a>  <span class="do">## change request to a list using addin button above (python to list)</span></span>
<span id="cb1100-24"><a href="time-series.html#cb1100-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Target is the name of the output file!!</span></span>
<span id="cb1100-25"><a href="time-series.html#cb1100-25" aria-hidden="true" tabindex="-1"></a>  request <span class="ot">&lt;-</span> request <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1100-26"><a href="time-series.html#cb1100-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">product_type =</span> <span class="st">&quot;reanalysis&quot;</span>,</span>
<span id="cb1100-27"><a href="time-series.html#cb1100-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">format =</span> <span class="st">&quot;netcdf&quot;</span>,</span>
<span id="cb1100-28"><a href="time-series.html#cb1100-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">&quot;2m_temperature&quot;</span>, <span class="st">&quot;total_precipitation&quot;</span>),</span>
<span id="cb1100-29"><a href="time-series.html#cb1100-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">c</span>(i),</span>
<span id="cb1100-30"><a href="time-series.html#cb1100-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">month =</span> <span class="fu">c</span>(<span class="st">&quot;01&quot;</span>, <span class="st">&quot;02&quot;</span>, <span class="st">&quot;03&quot;</span>, <span class="st">&quot;04&quot;</span>, <span class="st">&quot;05&quot;</span>, <span class="st">&quot;06&quot;</span>, <span class="st">&quot;07&quot;</span>, <span class="st">&quot;08&quot;</span>, <span class="st">&quot;09&quot;</span>, <span class="st">&quot;10&quot;</span>, <span class="st">&quot;11&quot;</span>, <span class="st">&quot;12&quot;</span>),</span>
<span id="cb1100-31"><a href="time-series.html#cb1100-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">day =</span> <span class="fu">c</span>(<span class="st">&quot;01&quot;</span>, <span class="st">&quot;02&quot;</span>, <span class="st">&quot;03&quot;</span>, <span class="st">&quot;04&quot;</span>, <span class="st">&quot;05&quot;</span>, <span class="st">&quot;06&quot;</span>, <span class="st">&quot;07&quot;</span>, <span class="st">&quot;08&quot;</span>, <span class="st">&quot;09&quot;</span>, <span class="st">&quot;10&quot;</span>, <span class="st">&quot;11&quot;</span>, <span class="st">&quot;12&quot;</span>,</span>
<span id="cb1100-32"><a href="time-series.html#cb1100-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;13&quot;</span>, <span class="st">&quot;14&quot;</span>, <span class="st">&quot;15&quot;</span>, <span class="st">&quot;16&quot;</span>, <span class="st">&quot;17&quot;</span>, <span class="st">&quot;18&quot;</span>, <span class="st">&quot;19&quot;</span>, <span class="st">&quot;20&quot;</span>, <span class="st">&quot;21&quot;</span>, <span class="st">&quot;22&quot;</span>, <span class="st">&quot;23&quot;</span>, <span class="st">&quot;24&quot;</span>,</span>
<span id="cb1100-33"><a href="time-series.html#cb1100-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;25&quot;</span>, <span class="st">&quot;26&quot;</span>, <span class="st">&quot;27&quot;</span>, <span class="st">&quot;28&quot;</span>, <span class="st">&quot;29&quot;</span>, <span class="st">&quot;30&quot;</span>, <span class="st">&quot;31&quot;</span>),</span>
<span id="cb1100-34"><a href="time-series.html#cb1100-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">time =</span> <span class="fu">c</span>(<span class="st">&quot;00:00&quot;</span>, <span class="st">&quot;01:00&quot;</span>, <span class="st">&quot;02:00&quot;</span>, <span class="st">&quot;03:00&quot;</span>, <span class="st">&quot;04:00&quot;</span>, <span class="st">&quot;05:00&quot;</span>, <span class="st">&quot;06:00&quot;</span>, <span class="st">&quot;07:00&quot;</span>,</span>
<span id="cb1100-35"><a href="time-series.html#cb1100-35" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;08:00&quot;</span>, <span class="st">&quot;09:00&quot;</span>, <span class="st">&quot;10:00&quot;</span>, <span class="st">&quot;11:00&quot;</span>, <span class="st">&quot;12:00&quot;</span>, <span class="st">&quot;13:00&quot;</span>, <span class="st">&quot;14:00&quot;</span>, <span class="st">&quot;15:00&quot;</span>,</span>
<span id="cb1100-36"><a href="time-series.html#cb1100-36" aria-hidden="true" tabindex="-1"></a>             <span class="st">&quot;16:00&quot;</span>, <span class="st">&quot;17:00&quot;</span>, <span class="st">&quot;18:00&quot;</span>, <span class="st">&quot;19:00&quot;</span>, <span class="st">&quot;20:00&quot;</span>, <span class="st">&quot;21:00&quot;</span>, <span class="st">&quot;22:00&quot;</span>, <span class="st">&quot;23:00&quot;</span>),</span>
<span id="cb1100-37"><a href="time-series.html#cb1100-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">area =</span> request_coords,</span>
<span id="cb1100-38"><a href="time-series.html#cb1100-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">dataset_short_name =</span> <span class="st">&quot;reanalysis-era5-single-levels&quot;</span>,</span>
<span id="cb1100-39"><a href="time-series.html#cb1100-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">target =</span> <span class="fu">paste0</span>(<span class="st">&quot;germany_weather&quot;</span>, i, <span class="st">&quot;.nc&quot;</span>)</span>
<span id="cb1100-40"><a href="time-series.html#cb1100-40" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1100-41"><a href="time-series.html#cb1100-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1100-42"><a href="time-series.html#cb1100-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">## download the file and store it in the current working directory</span></span>
<span id="cb1100-43"><a href="time-series.html#cb1100-43" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> <span class="fu">wf_request</span>(<span class="at">user     =</span> <span class="st">&quot;XXXXX&quot;</span>,  <span class="co"># user ID (for authentication)</span></span>
<span id="cb1100-44"><a href="time-series.html#cb1100-44" aria-hidden="true" tabindex="-1"></a>                     <span class="at">request  =</span> request,  <span class="co"># the request</span></span>
<span id="cb1100-45"><a href="time-series.html#cb1100-45" aria-hidden="true" tabindex="-1"></a>                     <span class="at">transfer =</span> <span class="cn">TRUE</span>,     <span class="co"># download the file</span></span>
<span id="cb1100-46"><a href="time-series.html#cb1100-46" aria-hidden="true" tabindex="-1"></a>                     <span class="at">path     =</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;Weather&quot;</span>)) <span class="do">## path to save the data</span></span>
<span id="cb1100-47"><a href="time-series.html#cb1100-47" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
</div>
<div id="load-climate-data" class="section level3 unnumbered">
<h3>Load climate data</h3>
<p>Whether you downloaded the climate data via our handbook, or used the code above, you now should have 10 years of “.nc” climate data files stored in the same folder on your computer.</p>
<p>Use the code below to import these files into R with the <strong>stars</strong> package.</p>
<div class="sourceCode" id="cb1101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1101-1"><a href="time-series.html#cb1101-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define path to weather folder </span></span>
<span id="cb1101-2"><a href="time-series.html#cb1101-2" aria-hidden="true" tabindex="-1"></a>file_paths <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb1101-3"><a href="time-series.html#cb1101-3" aria-hidden="true" tabindex="-1"></a>  here<span class="sc">::</span><span class="fu">here</span>(<span class="st">&quot;data&quot;</span>, <span class="st">&quot;time_series&quot;</span>, <span class="st">&quot;weather&quot;</span>), <span class="co"># replace with your own file path </span></span>
<span id="cb1101-4"><a href="time-series.html#cb1101-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1101-5"><a href="time-series.html#cb1101-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1101-6"><a href="time-series.html#cb1101-6" aria-hidden="true" tabindex="-1"></a><span class="do">## only keep those with the current name of interest </span></span>
<span id="cb1101-7"><a href="time-series.html#cb1101-7" aria-hidden="true" tabindex="-1"></a>file_paths <span class="ot">&lt;-</span> file_paths[<span class="fu">str_detect</span>(file_paths, <span class="st">&quot;germany&quot;</span>)]</span>
<span id="cb1101-8"><a href="time-series.html#cb1101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1101-9"><a href="time-series.html#cb1101-9" aria-hidden="true" tabindex="-1"></a><span class="do">## read in all the files as a stars object </span></span>
<span id="cb1101-10"><a href="time-series.html#cb1101-10" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> stars<span class="sc">::</span><span class="fu">read_stars</span>(file_paths)</span></code></pre></div>
<pre><code>## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp,</code></pre>
<p>Once these files have been imported as the object <code>data</code>, we will convert them to a data frame.</p>
<div class="sourceCode" id="cb1103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1103-1"><a href="time-series.html#cb1103-1" aria-hidden="true" tabindex="-1"></a><span class="do">## change to a data frame </span></span>
<span id="cb1103-2"><a href="time-series.html#cb1103-2" aria-hidden="true" tabindex="-1"></a>temp_data <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(data) <span class="sc">%&gt;%</span> </span>
<span id="cb1103-3"><a href="time-series.html#cb1103-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in variables and correct units</span></span>
<span id="cb1103-4"><a href="time-series.html#cb1103-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1103-5"><a href="time-series.html#cb1103-5" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create an calendar week variable </span></span>
<span id="cb1103-6"><a href="time-series.html#cb1103-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">epiweek =</span> tsibble<span class="sc">::</span><span class="fu">yearweek</span>(time), </span>
<span id="cb1103-7"><a href="time-series.html#cb1103-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create a date variable (start of calendar week)</span></span>
<span id="cb1103-8"><a href="time-series.html#cb1103-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">as.Date</span>(epiweek),</span>
<span id="cb1103-9"><a href="time-series.html#cb1103-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## change temperature from kelvin to celsius</span></span>
<span id="cb1103-10"><a href="time-series.html#cb1103-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">t2m =</span> <span class="fu">set_units</span>(t2m, celsius), </span>
<span id="cb1103-11"><a href="time-series.html#cb1103-11" aria-hidden="true" tabindex="-1"></a>    <span class="do">## change precipitation from metres to millimetres </span></span>
<span id="cb1103-12"><a href="time-series.html#cb1103-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">tp  =</span> <span class="fu">set_units</span>(tp, mm)) <span class="sc">%&gt;%</span> </span>
<span id="cb1103-13"><a href="time-series.html#cb1103-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## group by week (keep the date too though)</span></span>
<span id="cb1103-14"><a href="time-series.html#cb1103-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(epiweek, date) <span class="sc">%&gt;%</span> </span>
<span id="cb1103-15"><a href="time-series.html#cb1103-15" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get the average per week</span></span>
<span id="cb1103-16"><a href="time-series.html#cb1103-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">t2m =</span> <span class="fu">as.numeric</span>(<span class="fu">mean</span>(t2m)), </span>
<span id="cb1103-17"><a href="time-series.html#cb1103-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">tp =</span> <span class="fu">as.numeric</span>(<span class="fu">mean</span>(tp)))</span></code></pre></div>
<pre><code>## `summarise()` has grouped output by &#39;epiweek&#39;. You can override using the `.groups` argument.</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="time-series-data" class="section level2" number="23.3">
<h2><span class="header-section-number">23.3</span> Time series data</h2>
<p>There are a number of different packages for structuring and handling time series
data. As said, we will focus on the <strong>tidyverts</strong> family of packages and so will
use the <strong>tsibble</strong> package to define our time series object. Having a data set
defined as a time series object means it is much easier to structure our analysis.</p>
<p>To do this we use the <code>tsibble()</code> function and specify the “index”, i.e. the variable
specifying the time unit of interest. In our case this is the <code>epiweek</code> variable.</p>
<p>If we had a data set with weekly counts by province, for example, we would also
be able to specify the grouping variable using the <code>key =</code> argument.
This would allow us to do analysis for each group.</p>
<div class="sourceCode" id="cb1105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1105-1"><a href="time-series.html#cb1105-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define time series object </span></span>
<span id="cb1105-2"><a href="time-series.html#cb1105-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">tsibble</span>(counts, <span class="at">index =</span> epiweek)</span></code></pre></div>
<p>Looking at <code>class(counts)</code> tells you that on top of being a tidy data frame
(“tbl_df”, “tbl”, “data.frame”), it has the additional properties of a time series
data frame (“tbl_ts”).</p>
<p>You can take a quick look at your data by using <strong>ggplot2</strong>. We see from the plot that
there is a clear seasonal pattern, and that there are no missings. However, there
seems to be an issue with reporting at the beginning of each year; cases drop
in the last week of the year and then increase for the first week of the next year.</p>
<div class="sourceCode" id="cb1106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1106-1"><a href="time-series.html#cb1106-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot a line graph of cases by week</span></span>
<span id="cb1106-2"><a href="time-series.html#cb1106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> case)) <span class="sc">+</span> </span>
<span id="cb1106-3"><a href="time-series.html#cb1106-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/basic_plot-1.png" width="672" /></p>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> Most datasets aren’t as clean as this example.
You will need to check for duplicates and missings as below. </span></p>
<!-- ======================================================= -->
<div id="duplicates" class="section level3 unnumbered">
<h3>Duplicates</h3>
<p><strong>tsibble</strong> does not allow duplicate observations. So each row will need to be
unique, or unique within the group (<code>key</code> variable).
The package has a few functions that help to identify duplicates. These include
<code>are_duplicated()</code> which gives you a TRUE/FALSE vector of whether the row is a
duplicate, and <code>duplicates()</code> which gives you a data frame of the duplicated rows.</p>
<p>See the page on <a href="https://epirhandbook.com/de-duplication.html">De-duplication</a>
for more details on how to select rows you want.</p>
<div class="sourceCode" id="cb1107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1107-1"><a href="time-series.html#cb1107-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get a vector of TRUE/FALSE whether rows are duplicates</span></span>
<span id="cb1107-2"><a href="time-series.html#cb1107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">are_duplicated</span>(counts, <span class="at">index =</span> epiweek) </span>
<span id="cb1107-3"><a href="time-series.html#cb1107-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1107-4"><a href="time-series.html#cb1107-4" aria-hidden="true" tabindex="-1"></a><span class="do">## get a data frame of any duplicated rows </span></span>
<span id="cb1107-5"><a href="time-series.html#cb1107-5" aria-hidden="true" tabindex="-1"></a><span class="fu">duplicates</span>(counts, <span class="at">index =</span> epiweek) </span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="missings" class="section level3 unnumbered">
<h3>Missings</h3>
<p>We saw from our brief inspection above that there are no missings, but we also
saw there seems to be a problem with reporting delay around new year.
One way to address this problem could be to set these values to missing and then
to impute values. The simplest form of time series imputation is to draw
a straight line between the last non-missing and the next non-missing value.
To do this we will use the <strong>imputeTS</strong> package function <code>na_interpolation()</code>.</p>
<p>See the <a href="https://epirhandbook.com/missing-data.html">Missing data</a> page for other options for imputation.</p>
<p>Another alternative would be to calculate a moving average, to try and smooth
over these apparent reporting issues (see next section, and the page on <a href="https://epirhandbook.com/moving-averages.html">Moving averages</a>).</p>
<div class="sourceCode" id="cb1108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1108-1"><a href="time-series.html#cb1108-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create a variable with missings instead of weeks with reporting issues</span></span>
<span id="cb1108-2"><a href="time-series.html#cb1108-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1108-3"><a href="time-series.html#cb1108-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">case_miss =</span> <span class="fu">if_else</span>(</span>
<span id="cb1108-4"><a href="time-series.html#cb1108-4" aria-hidden="true" tabindex="-1"></a>          <span class="do">## if epiweek contains 52, 53, 1 or 2</span></span>
<span id="cb1108-5"><a href="time-series.html#cb1108-5" aria-hidden="true" tabindex="-1"></a>          <span class="fu">str_detect</span>(epiweek, <span class="st">&quot;W51|W52|W53|W01|W02&quot;</span>), </span>
<span id="cb1108-6"><a href="time-series.html#cb1108-6" aria-hidden="true" tabindex="-1"></a>          <span class="do">## then set to missing </span></span>
<span id="cb1108-7"><a href="time-series.html#cb1108-7" aria-hidden="true" tabindex="-1"></a>          <span class="cn">NA_real_</span>, </span>
<span id="cb1108-8"><a href="time-series.html#cb1108-8" aria-hidden="true" tabindex="-1"></a>          <span class="do">## otherwise keep the value in case</span></span>
<span id="cb1108-9"><a href="time-series.html#cb1108-9" aria-hidden="true" tabindex="-1"></a>          case</span>
<span id="cb1108-10"><a href="time-series.html#cb1108-10" aria-hidden="true" tabindex="-1"></a>     ))</span>
<span id="cb1108-11"><a href="time-series.html#cb1108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1108-12"><a href="time-series.html#cb1108-12" aria-hidden="true" tabindex="-1"></a><span class="do">## alternatively interpolate missings by linear trend </span></span>
<span id="cb1108-13"><a href="time-series.html#cb1108-13" aria-hidden="true" tabindex="-1"></a><span class="do">## between two nearest adjacent points</span></span>
<span id="cb1108-14"><a href="time-series.html#cb1108-14" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1108-15"><a href="time-series.html#cb1108-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">case_int =</span> imputeTS<span class="sc">::</span><span class="fu">na_interpolation</span>(case_miss)</span>
<span id="cb1108-16"><a href="time-series.html#cb1108-16" aria-hidden="true" tabindex="-1"></a>         )</span>
<span id="cb1108-17"><a href="time-series.html#cb1108-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1108-18"><a href="time-series.html#cb1108-18" aria-hidden="true" tabindex="-1"></a><span class="do">## to check what values have been imputed compared to the original</span></span>
<span id="cb1108-19"><a href="time-series.html#cb1108-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot_na_imputations</span>(counts<span class="sc">$</span>case_miss, counts<span class="sc">$</span>case_int) <span class="sc">+</span> </span>
<span id="cb1108-20"><a href="time-series.html#cb1108-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1108-21"><a href="time-series.html#cb1108-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/missings-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
</div>
<div id="descriptive-analysis" class="section level2" number="23.4">
<h2><span class="header-section-number">23.4</span> Descriptive analysis</h2>
<!-- ======================================================= -->
<div id="timeseries_moving" class="section level3 unnumbered">
<h3>Moving averages</h3>
<p>If data is very noisy (counts jumping up and down) then it can be helpful to
calculate a moving average. In the example below, for each week we calculate the
average number of cases from the four previous weeks. This smooths the data, to
make it more interpretable. In our case this does not really add much, so we will
stick to the interpolated data for further analysis.
See the <a href="https://epirhandbook.com/moving-averages.html">Moving averages</a> page for more detail.</p>
<div class="sourceCode" id="cb1109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1109-1"><a href="time-series.html#cb1109-1" aria-hidden="true" tabindex="-1"></a><span class="do">## create a moving average variable (deals with missings)</span></span>
<span id="cb1109-2"><a href="time-series.html#cb1109-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1109-3"><a href="time-series.html#cb1109-3" aria-hidden="true" tabindex="-1"></a>     <span class="do">## create the ma_4w variable </span></span>
<span id="cb1109-4"><a href="time-series.html#cb1109-4" aria-hidden="true" tabindex="-1"></a>     <span class="do">## slide over each row of the case variable</span></span>
<span id="cb1109-5"><a href="time-series.html#cb1109-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">mutate</span>(<span class="at">ma_4wk =</span> slider<span class="sc">::</span><span class="fu">slide_dbl</span>(case, </span>
<span id="cb1109-6"><a href="time-series.html#cb1109-6" aria-hidden="true" tabindex="-1"></a>                               <span class="do">## for each row calculate the name</span></span>
<span id="cb1109-7"><a href="time-series.html#cb1109-7" aria-hidden="true" tabindex="-1"></a>                               <span class="sc">~</span> <span class="fu">mean</span>(.x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1109-8"><a href="time-series.html#cb1109-8" aria-hidden="true" tabindex="-1"></a>                               <span class="do">## use the four previous weeks</span></span>
<span id="cb1109-9"><a href="time-series.html#cb1109-9" aria-hidden="true" tabindex="-1"></a>                               <span class="at">.before =</span> <span class="dv">4</span>))</span>
<span id="cb1109-10"><a href="time-series.html#cb1109-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1109-11"><a href="time-series.html#cb1109-11" aria-hidden="true" tabindex="-1"></a><span class="do">## make a quick visualisation of the difference </span></span>
<span id="cb1109-12"><a href="time-series.html#cb1109-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1109-13"><a href="time-series.html#cb1109-13" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case)) <span class="sc">+</span> </span>
<span id="cb1109-14"><a href="time-series.html#cb1109-14" aria-hidden="true" tabindex="-1"></a>     <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ma_4wk), <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/moving_averages-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="periodicity" class="section level3 unnumbered">
<h3>Periodicity</h3>
<p>Below we define a custom function to create a periodogram. See the <a href="basics.html#writing-functions">Writing functions</a> page for information about how to write functions in R.</p>
<p>First, the function is defined. Its arguments include a dataset with a column <code>counts</code>, <code>start_week =</code> which is the first week of the dataset, a number to indicate how many periods per year (e.g. 52, 12), and lastly the output style (see details in the code below).</p>
<div class="sourceCode" id="cb1110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1110-1"><a href="time-series.html#cb1110-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Function arguments</span></span>
<span id="cb1110-2"><a href="time-series.html#cb1110-2" aria-hidden="true" tabindex="-1"></a><span class="do">#####################</span></span>
<span id="cb1110-3"><a href="time-series.html#cb1110-3" aria-hidden="true" tabindex="-1"></a><span class="do">## x is a dataset</span></span>
<span id="cb1110-4"><a href="time-series.html#cb1110-4" aria-hidden="true" tabindex="-1"></a><span class="do">## counts is variable with count data or rates within x </span></span>
<span id="cb1110-5"><a href="time-series.html#cb1110-5" aria-hidden="true" tabindex="-1"></a><span class="do">## start_week is the first week in your dataset</span></span>
<span id="cb1110-6"><a href="time-series.html#cb1110-6" aria-hidden="true" tabindex="-1"></a><span class="do">## period is how many units in a year </span></span>
<span id="cb1110-7"><a href="time-series.html#cb1110-7" aria-hidden="true" tabindex="-1"></a><span class="do">## output is whether you want return spectral periodogram or the peak weeks</span></span>
<span id="cb1110-8"><a href="time-series.html#cb1110-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## &quot;periodogram&quot; or &quot;weeks&quot;</span></span>
<span id="cb1110-9"><a href="time-series.html#cb1110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1110-10"><a href="time-series.html#cb1110-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define function</span></span>
<span id="cb1110-11"><a href="time-series.html#cb1110-11" aria-hidden="true" tabindex="-1"></a>periodogram <span class="ot">&lt;-</span> <span class="cf">function</span>(x, </span>
<span id="cb1110-12"><a href="time-series.html#cb1110-12" aria-hidden="true" tabindex="-1"></a>                        counts, </span>
<span id="cb1110-13"><a href="time-series.html#cb1110-13" aria-hidden="true" tabindex="-1"></a>                        <span class="at">start_week =</span> <span class="fu">c</span>(<span class="dv">2002</span>, <span class="dv">1</span>), </span>
<span id="cb1110-14"><a href="time-series.html#cb1110-14" aria-hidden="true" tabindex="-1"></a>                        <span class="at">period =</span> <span class="dv">52</span>, </span>
<span id="cb1110-15"><a href="time-series.html#cb1110-15" aria-hidden="true" tabindex="-1"></a>                        <span class="at">output =</span> <span class="st">&quot;weeks&quot;</span>) {</span>
<span id="cb1110-16"><a href="time-series.html#cb1110-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1110-17"><a href="time-series.html#cb1110-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1110-18"><a href="time-series.html#cb1110-18" aria-hidden="true" tabindex="-1"></a>    <span class="do">## make sure is not a tsibble, filter to project and only keep columns of interest</span></span>
<span id="cb1110-19"><a href="time-series.html#cb1110-19" aria-hidden="true" tabindex="-1"></a>    prepare_data <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">as_tibble</span>(x)</span>
<span id="cb1110-20"><a href="time-series.html#cb1110-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1110-21"><a href="time-series.html#cb1110-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># prepare_data &lt;- prepare_data[prepare_data[[strata]] == j, ]</span></span>
<span id="cb1110-22"><a href="time-series.html#cb1110-22" aria-hidden="true" tabindex="-1"></a>    prepare_data <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">select</span>(prepare_data, {{counts}})</span>
<span id="cb1110-23"><a href="time-series.html#cb1110-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1110-24"><a href="time-series.html#cb1110-24" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create an intermediate &quot;zoo&quot; time series to be able to use with spec.pgram</span></span>
<span id="cb1110-25"><a href="time-series.html#cb1110-25" aria-hidden="true" tabindex="-1"></a>    zoo_cases <span class="ot">&lt;-</span> zoo<span class="sc">::</span><span class="fu">zooreg</span>(prepare_data, </span>
<span id="cb1110-26"><a href="time-series.html#cb1110-26" aria-hidden="true" tabindex="-1"></a>                             <span class="at">start =</span> start_week, <span class="at">frequency =</span> period)</span>
<span id="cb1110-27"><a href="time-series.html#cb1110-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1110-28"><a href="time-series.html#cb1110-28" aria-hidden="true" tabindex="-1"></a>    <span class="do">## get a spectral periodogram not using fast fourier transform </span></span>
<span id="cb1110-29"><a href="time-series.html#cb1110-29" aria-hidden="true" tabindex="-1"></a>    periodo <span class="ot">&lt;-</span> <span class="fu">spec.pgram</span>(zoo_cases, <span class="at">fast =</span> <span class="cn">FALSE</span>, <span class="at">plot =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1110-30"><a href="time-series.html#cb1110-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1110-31"><a href="time-series.html#cb1110-31" aria-hidden="true" tabindex="-1"></a>    <span class="do">## return the peak weeks </span></span>
<span id="cb1110-32"><a href="time-series.html#cb1110-32" aria-hidden="true" tabindex="-1"></a>    periodo_weeks <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> periodo<span class="sc">$</span>freq[<span class="fu">order</span>(<span class="sc">-</span>periodo<span class="sc">$</span>spec)] <span class="sc">*</span> period</span>
<span id="cb1110-33"><a href="time-series.html#cb1110-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1110-34"><a href="time-series.html#cb1110-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (output <span class="sc">==</span> <span class="st">&quot;weeks&quot;</span>) {</span>
<span id="cb1110-35"><a href="time-series.html#cb1110-35" aria-hidden="true" tabindex="-1"></a>      periodo_weeks</span>
<span id="cb1110-36"><a href="time-series.html#cb1110-36" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1110-37"><a href="time-series.html#cb1110-37" aria-hidden="true" tabindex="-1"></a>      periodo</span>
<span id="cb1110-38"><a href="time-series.html#cb1110-38" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1110-39"><a href="time-series.html#cb1110-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1110-40"><a href="time-series.html#cb1110-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1110-41"><a href="time-series.html#cb1110-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1110-42"><a href="time-series.html#cb1110-42" aria-hidden="true" tabindex="-1"></a><span class="do">## get spectral periodogram for extracting weeks with the highest frequencies </span></span>
<span id="cb1110-43"><a href="time-series.html#cb1110-43" aria-hidden="true" tabindex="-1"></a><span class="do">## (checking of seasonality) </span></span>
<span id="cb1110-44"><a href="time-series.html#cb1110-44" aria-hidden="true" tabindex="-1"></a>periodo <span class="ot">&lt;-</span> <span class="fu">periodogram</span>(counts, </span>
<span id="cb1110-45"><a href="time-series.html#cb1110-45" aria-hidden="true" tabindex="-1"></a>                       case_int, </span>
<span id="cb1110-46"><a href="time-series.html#cb1110-46" aria-hidden="true" tabindex="-1"></a>                       <span class="at">start_week =</span> <span class="fu">c</span>(<span class="dv">2002</span>, <span class="dv">1</span>),</span>
<span id="cb1110-47"><a href="time-series.html#cb1110-47" aria-hidden="true" tabindex="-1"></a>                       <span class="at">output =</span> <span class="st">&quot;periodogram&quot;</span>)</span>
<span id="cb1110-48"><a href="time-series.html#cb1110-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1110-49"><a href="time-series.html#cb1110-49" aria-hidden="true" tabindex="-1"></a><span class="do">## pull spectrum and frequence in to a dataframe for plotting</span></span>
<span id="cb1110-50"><a href="time-series.html#cb1110-50" aria-hidden="true" tabindex="-1"></a>periodo <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(periodo<span class="sc">$</span>freq, periodo<span class="sc">$</span>spec)</span>
<span id="cb1110-51"><a href="time-series.html#cb1110-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1110-52"><a href="time-series.html#cb1110-52" aria-hidden="true" tabindex="-1"></a><span class="do">## plot a periodogram showing the most frequently occuring periodicity </span></span>
<span id="cb1110-53"><a href="time-series.html#cb1110-53" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> periodo, </span>
<span id="cb1110-54"><a href="time-series.html#cb1110-54" aria-hidden="true" tabindex="-1"></a>                <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">/</span>(periodo.freq<span class="sc">/</span><span class="dv">52</span>),  <span class="at">y =</span> <span class="fu">log</span>(periodo.spec))) <span class="sc">+</span> </span>
<span id="cb1110-55"><a href="time-series.html#cb1110-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb1110-56"><a href="time-series.html#cb1110-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Period (Weeks)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Log(density)&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/periodogram-1.png" width="672" /></p>
<div class="sourceCode" id="cb1111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1111-1"><a href="time-series.html#cb1111-1" aria-hidden="true" tabindex="-1"></a><span class="do">## get a vector weeks in ascending order </span></span>
<span id="cb1111-2"><a href="time-series.html#cb1111-2" aria-hidden="true" tabindex="-1"></a>peak_weeks <span class="ot">&lt;-</span> <span class="fu">periodogram</span>(counts, </span>
<span id="cb1111-3"><a href="time-series.html#cb1111-3" aria-hidden="true" tabindex="-1"></a>                          case_int, </span>
<span id="cb1111-4"><a href="time-series.html#cb1111-4" aria-hidden="true" tabindex="-1"></a>                          <span class="at">start_week =</span> <span class="fu">c</span>(<span class="dv">2002</span>, <span class="dv">1</span>), </span>
<span id="cb1111-5"><a href="time-series.html#cb1111-5" aria-hidden="true" tabindex="-1"></a>                          <span class="at">output =</span> <span class="st">&quot;weeks&quot;</span>)</span></code></pre></div>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> It is possible to use the above weeks to add them to sin and cosine terms, however we will use a function to generate these terms (see regression section below) </span></p>
<!-- ======================================================= -->
</div>
<div id="decomposition" class="section level3 unnumbered">
<h3>Decomposition</h3>
<p>Classical decomposition is used to break a time series down several parts, which
when taken together make up for the pattern you see.
These different parts are:</p>
<ul>
<li>The trend-cycle (the long-term direction of the data)<br />
</li>
<li>The seasonality (repeating patterns)<br />
</li>
<li>The random (what is left after removing trend and season)</li>
</ul>
<div class="sourceCode" id="cb1112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1112-1"><a href="time-series.html#cb1112-1" aria-hidden="true" tabindex="-1"></a><span class="do">## decompose the counts dataset </span></span>
<span id="cb1112-2"><a href="time-series.html#cb1112-2" aria-hidden="true" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1112-3"><a href="time-series.html#cb1112-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># using an additive classical decomposition model</span></span>
<span id="cb1112-4"><a href="time-series.html#cb1112-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">model</span>(<span class="fu">classical_decomposition</span>(case_int, <span class="at">type =</span> <span class="st">&quot;additive&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1112-5"><a href="time-series.html#cb1112-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extract the important information from the model</span></span>
<span id="cb1112-6"><a href="time-series.html#cb1112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">components</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1112-7"><a href="time-series.html#cb1112-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## generate a plot </span></span>
<span id="cb1112-8"><a href="time-series.html#cb1112-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/decomposition-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="autocorrelation" class="section level3 unnumbered">
<h3>Autocorrelation</h3>
<p>Autocorrelation tells you about the relation between the counts of each week
and the weeks before it (called lags).</p>
<p>Using the <code>ACF()</code> function, we can produce a plot which shows us a number of lines
for the relation at different lags. Where the lag is 0 (x = 0), this line would
always be 1 as it shows the relation between an observation and itself (not shown here).
The first line shown here (x = 1) shows the relation between each observation
and the observation before it (lag of 1), the second shows the relation between
each observation and the observation before last (lag of 2) and so on until lag of
52 which shows the relation between each observation and the observation from 1
year (52 weeks before).</p>
<p>Using the <code>PACF()</code> function (for partial autocorrelation) shows the same type of relation
but adjusted for all other weeks between. This is less informative for determining
periodicity.</p>
<div class="sourceCode" id="cb1113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1113-1"><a href="time-series.html#cb1113-1" aria-hidden="true" tabindex="-1"></a><span class="do">## using the counts dataset</span></span>
<span id="cb1113-2"><a href="time-series.html#cb1113-2" aria-hidden="true" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1113-3"><a href="time-series.html#cb1113-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate autocorrelation using a full years worth of lags</span></span>
<span id="cb1113-4"><a href="time-series.html#cb1113-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(case_int, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1113-5"><a href="time-series.html#cb1113-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## show a plot</span></span>
<span id="cb1113-6"><a href="time-series.html#cb1113-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/autocorrelation-1.png" width="672" /></p>
<div class="sourceCode" id="cb1114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1114-1"><a href="time-series.html#cb1114-1" aria-hidden="true" tabindex="-1"></a><span class="do">## using the counts data set </span></span>
<span id="cb1114-2"><a href="time-series.html#cb1114-2" aria-hidden="true" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1114-3"><a href="time-series.html#cb1114-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate the partial autocorrelation using a full years worth of lags</span></span>
<span id="cb1114-4"><a href="time-series.html#cb1114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">PACF</span>(case_int, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1114-5"><a href="time-series.html#cb1114-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## show a plot</span></span>
<span id="cb1114-6"><a href="time-series.html#cb1114-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/autocorrelation-2.png" width="672" /></p>
<p>You can formally test the null hypothesis of independence in a time series (i.e. 
that it is not autocorrelated) using the Ljung-Box test (in the <strong>stats</strong> package).
A significant p-value suggests that there is autocorrelation in the data.</p>
<div class="sourceCode" id="cb1115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1115-1"><a href="time-series.html#cb1115-1" aria-hidden="true" tabindex="-1"></a><span class="do">## test for independance </span></span>
<span id="cb1115-2"><a href="time-series.html#cb1115-2" aria-hidden="true" tabindex="-1"></a><span class="fu">Box.test</span>(counts<span class="sc">$</span>case_int, <span class="at">type =</span> <span class="st">&quot;Ljung-Box&quot;</span>)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  counts$case_int
## X-squared = 462.65, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="fitting-regressions" class="section level2" number="23.5">
<h2><span class="header-section-number">23.5</span> Fitting regressions</h2>
<p>It is possible to fit a large number of different regressions to a time series,
however, here we will demonstrate how to fit a negative binomial regression - as
this is often the most appropriate for counts data in infectious diseases.</p>
<!-- ======================================================= -->
<div id="fourier-terms" class="section level3 unnumbered">
<h3>Fourier terms</h3>
<p>Fourier terms are the equivalent of sin and cosin curves. The difference is that
these are fit based on finding the most appropriate combination of curves to explain
your data.</p>
<p>If only fitting one fourier term, this would be the equivalent of fitting a sin
and a cosin for your most frequently occurring lag seen in your periodogram (in our
case 52 weeks). We use the <code>fourier()</code> function from the <strong>forecast</strong> package.</p>
<p>In the below code we assign using the <code>$</code>, as <code>fourier()</code> returns two columns (one
for sin one for cosin) and so these are added to the dataset as a list, called
“fourier” - but this list can then be used as a normal variable in regression.</p>
<div class="sourceCode" id="cb1117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1117-1"><a href="time-series.html#cb1117-1" aria-hidden="true" tabindex="-1"></a><span class="do">## add in fourier terms using the epiweek and case_int variabless</span></span>
<span id="cb1117-2"><a href="time-series.html#cb1117-2" aria-hidden="true" tabindex="-1"></a>counts<span class="sc">$</span>fourier <span class="ot">&lt;-</span> <span class="fu">select</span>(counts, epiweek, case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1117-3"><a href="time-series.html#cb1117-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fourier</span>(<span class="at">K =</span> <span class="dv">1</span>)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="negative-binomial" class="section level3 unnumbered">
<h3>Negative binomial</h3>
<p>It is possible to fit regressions using base <strong>stats</strong> or <strong>MASS</strong>
functions (e.g. <code>lm()</code>, <code>glm()</code> and <code>glm.nb()</code>). However we will be using those from
the <strong>trending</strong> package, as this allows for calculating appropriate confidence
and prediction intervals (which are otherwise not available).
The syntax is the same, and you specify an outcome variable then a tilde (~)
and then add your various exposure variables of interest separated by a plus (+).</p>
<p>The other difference is that we first define the model and then <code>fit()</code> it to the
data. This is useful because it allows for comparing multiple different models
with the same syntax.</p>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> If you wanted to use rates, rather than
counts you could include the population variable as a logarithmic offset term, by adding
<code>offset(log(population)</code>. You would then need to set population to be 1, before
using <code>predict()</code> in order to produce a rate. </span></p>
<p><span style="color: darkgreen;"><strong><em>TIP:</em></strong> For fitting more complex models such
as ARIMA or prophet, see the <a href="https://fable.tidyverts.org/index.html"><strong>fable</strong></a> package.</span></p>
<div class="sourceCode" id="cb1118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1118-1"><a href="time-series.html#cb1118-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1118-2"><a href="time-series.html#cb1118-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1118-3"><a href="time-series.html#cb1118-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1118-4"><a href="time-series.html#cb1118-4" aria-hidden="true" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1118-5"><a href="time-series.html#cb1118-5" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1118-6"><a href="time-series.html#cb1118-6" aria-hidden="true" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1118-7"><a href="time-series.html#cb1118-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use the fourier terms to account for seasonality</span></span>
<span id="cb1118-8"><a href="time-series.html#cb1118-8" aria-hidden="true" tabindex="-1"></a>    fourier)</span>
<span id="cb1118-9"><a href="time-series.html#cb1118-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1118-10"><a href="time-series.html#cb1118-10" aria-hidden="true" tabindex="-1"></a><span class="do">## fit your model using the counts dataset</span></span>
<span id="cb1118-11"><a href="time-series.html#cb1118-11" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, counts)</span>
<span id="cb1118-12"><a href="time-series.html#cb1118-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1118-13"><a href="time-series.html#cb1118-13" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate confidence intervals and prediction intervals </span></span>
<span id="cb1118-14"><a href="time-series.html#cb1118-14" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1118-15"><a href="time-series.html#cb1118-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1118-16"><a href="time-series.html#cb1118-16" aria-hidden="true" tabindex="-1"></a><span class="do">## plot your regression </span></span>
<span id="cb1118-17"><a href="time-series.html#cb1118-17" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> observed, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1118-18"><a href="time-series.html#cb1118-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1118-19"><a href="time-series.html#cb1118-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate),</span>
<span id="cb1118-20"><a href="time-series.html#cb1118-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;Red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1118-21"><a href="time-series.html#cb1118-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1118-22"><a href="time-series.html#cb1118-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1118-23"><a href="time-series.html#cb1118-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1118-24"><a href="time-series.html#cb1118-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1118-25"><a href="time-series.html#cb1118-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a line for your observed case counts</span></span>
<span id="cb1118-26"><a href="time-series.html#cb1118-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1118-27"><a href="time-series.html#cb1118-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1118-28"><a href="time-series.html#cb1118-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1118-29"><a href="time-series.html#cb1118-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/nb_reg-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="residuals" class="section level3 unnumbered">
<h3>Residuals</h3>
<p>To see how well our model fits the observed data we need to look at the residuals.
The residuals are the difference between the observed counts and the counts
estimated from the model. We could calculate this simply by using <code>case_int - estimate</code>,
but the <code>residuals()</code> function extracts this directly from the regression for us.</p>
<p>What we see from the below, is that we are not explaining all of the variation
that we could with the model. It might be that we should fit more fourier terms,
and address the amplitude. However for this example we will leave it as is.
The plots show that our model does worse in the peaks and troughs (when counts are
at their highest and lowest) and that it might be more likely to underestimate
the observed counts.</p>
<div class="sourceCode" id="cb1119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1119-1"><a href="time-series.html#cb1119-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate the residuals </span></span>
<span id="cb1119-2"><a href="time-series.html#cb1119-2" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> observed <span class="sc">%&gt;%</span> </span>
<span id="cb1119-3"><a href="time-series.html#cb1119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">resid =</span> <span class="fu">residuals</span>(fitted_model<span class="sc">$</span>fitted_model, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>))</span>
<span id="cb1119-4"><a href="time-series.html#cb1119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1119-5"><a href="time-series.html#cb1119-5" aria-hidden="true" tabindex="-1"></a><span class="do">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span></span>
<span id="cb1119-6"><a href="time-series.html#cb1119-6" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span></span>
<span id="cb1119-7"><a href="time-series.html#cb1119-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1119-8"><a href="time-series.html#cb1119-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb1119-9"><a href="time-series.html#cb1119-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb1119-10"><a href="time-series.html#cb1119-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;epiweek&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-854-1.png" width="672" /></p>
<div class="sourceCode" id="cb1120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1120-1"><a href="time-series.html#cb1120-1" aria-hidden="true" tabindex="-1"></a><span class="do">## is there autocorelation in the residuals (is there a pattern to the error?)  </span></span>
<span id="cb1120-2"><a href="time-series.html#cb1120-2" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span> </span>
<span id="cb1120-3"><a href="time-series.html#cb1120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1120-4"><a href="time-series.html#cb1120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(resid, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1120-5"><a href="time-series.html#cb1120-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-854-2.png" width="672" /></p>
<div class="sourceCode" id="cb1121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1121-1"><a href="time-series.html#cb1121-1" aria-hidden="true" tabindex="-1"></a><span class="do">## are residuals normally distributed (are under or over estimating?)  </span></span>
<span id="cb1121-2"><a href="time-series.html#cb1121-2" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span></span>
<span id="cb1121-3"><a href="time-series.html#cb1121-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> resid)) <span class="sc">+</span></span>
<span id="cb1121-4"><a href="time-series.html#cb1121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb1121-5"><a href="time-series.html#cb1121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rug</span>() <span class="sc">+</span></span>
<span id="cb1121-6"><a href="time-series.html#cb1121-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;count&quot;</span>) </span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-854-3.png" width="672" /></p>
<div class="sourceCode" id="cb1122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1122-1"><a href="time-series.html#cb1122-1" aria-hidden="true" tabindex="-1"></a><span class="do">## compare observed counts to their residuals </span></span>
<span id="cb1122-2"><a href="time-series.html#cb1122-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## should also be no pattern </span></span>
<span id="cb1122-3"><a href="time-series.html#cb1122-3" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span></span>
<span id="cb1122-4"><a href="time-series.html#cb1122-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1122-5"><a href="time-series.html#cb1122-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1122-6"><a href="time-series.html#cb1122-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Fitted&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-854-4.png" width="672" /></p>
<div class="sourceCode" id="cb1123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1123-1"><a href="time-series.html#cb1123-1" aria-hidden="true" tabindex="-1"></a><span class="do">## formally test autocorrelation of the residuals</span></span>
<span id="cb1123-2"><a href="time-series.html#cb1123-2" aria-hidden="true" tabindex="-1"></a><span class="do">## H0 is that residuals are from a white-noise series (i.e. random)</span></span>
<span id="cb1123-3"><a href="time-series.html#cb1123-3" aria-hidden="true" tabindex="-1"></a><span class="do">## test for independence </span></span>
<span id="cb1123-4"><a href="time-series.html#cb1123-4" aria-hidden="true" tabindex="-1"></a><span class="do">## if p value significant then non-random</span></span>
<span id="cb1123-5"><a href="time-series.html#cb1123-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Box.test</span>(observed<span class="sc">$</span>resid, <span class="at">type =</span> <span class="st">&quot;Ljung-Box&quot;</span>)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  observed$resid
## X-squared = 346.64, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="relation-of-two-time-series" class="section level2" number="23.6">
<h2><span class="header-section-number">23.6</span> Relation of two time series</h2>
<p>Here we look at using weather data (specifically the temperature) to explain
campylobacter case counts.</p>
<!-- ======================================================= -->
<div id="merging-datasets" class="section level3 unnumbered">
<h3>Merging datasets</h3>
<p>We can join our datasets using the week variable. For more on merging see the
handbook section on <a href="https://epirhandbook.com/joining-data.html">joining</a>.</p>
<div class="sourceCode" id="cb1125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1125-1"><a href="time-series.html#cb1125-1" aria-hidden="true" tabindex="-1"></a><span class="do">## left join so that we only have the rows already existing in counts</span></span>
<span id="cb1125-2"><a href="time-series.html#cb1125-2" aria-hidden="true" tabindex="-1"></a><span class="do">## drop the date variable from temp_data (otherwise is duplicated)</span></span>
<span id="cb1125-3"><a href="time-series.html#cb1125-3" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">left_join</span>(counts, </span>
<span id="cb1125-4"><a href="time-series.html#cb1125-4" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">select</span>(temp_data, <span class="sc">-</span>date),</span>
<span id="cb1125-5"><a href="time-series.html#cb1125-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">by =</span> <span class="st">&quot;epiweek&quot;</span>)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="descriptive-analysis-1" class="section level3 unnumbered">
<h3>Descriptive analysis</h3>
<p>First plot your data to see if there is any obvious relation.
The plot below shows that there is a clear relation in the seasonality of the two
variables, and that temperature might peak a few weeks before the case number.
For more on pivoting data, see the handbook section on <a href="https://epirhandbook.com/pivoting-data.html">pivoting data</a>.</p>
<div class="sourceCode" id="cb1126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1126-1"><a href="time-series.html#cb1126-1" aria-hidden="true" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1126-2"><a href="time-series.html#cb1126-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## keep the variables we are interested </span></span>
<span id="cb1126-3"><a href="time-series.html#cb1126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(epiweek, case_int, t2m) <span class="sc">%&gt;%</span> </span>
<span id="cb1126-4"><a href="time-series.html#cb1126-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## change your data in to long format</span></span>
<span id="cb1126-5"><a href="time-series.html#cb1126-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb1126-6"><a href="time-series.html#cb1126-6" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use epiweek as your key</span></span>
<span id="cb1126-7"><a href="time-series.html#cb1126-7" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>epiweek,</span>
<span id="cb1126-8"><a href="time-series.html#cb1126-8" aria-hidden="true" tabindex="-1"></a>    <span class="do">## move column names to the new &quot;measure&quot; column</span></span>
<span id="cb1126-9"><a href="time-series.html#cb1126-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_to =</span> <span class="st">&quot;measure&quot;</span>, </span>
<span id="cb1126-10"><a href="time-series.html#cb1126-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## move cell values to the new &quot;values&quot; column</span></span>
<span id="cb1126-11"><a href="time-series.html#cb1126-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1126-12"><a href="time-series.html#cb1126-12" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create a plot with the dataset above</span></span>
<span id="cb1126-13"><a href="time-series.html#cb1126-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## plot epiweek on the x axis and values (counts/celsius) on the y </span></span>
<span id="cb1126-14"><a href="time-series.html#cb1126-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> value)) <span class="sc">+</span> </span>
<span id="cb1126-15"><a href="time-series.html#cb1126-15" aria-hidden="true" tabindex="-1"></a>    <span class="do">## create a separate plot for temperate and case counts </span></span>
<span id="cb1126-16"><a href="time-series.html#cb1126-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">## let them set their own y-axes</span></span>
<span id="cb1126-17"><a href="time-series.html#cb1126-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_grid</span>(measure <span class="sc">~</span> ., <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>) <span class="sc">+</span></span>
<span id="cb1126-18"><a href="time-series.html#cb1126-18" aria-hidden="true" tabindex="-1"></a>    <span class="do">## plot both as a line</span></span>
<span id="cb1126-19"><a href="time-series.html#cb1126-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/basic_plot_bivar-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="lags-and-cross-correlation" class="section level3 unnumbered">
<h3>Lags and cross-correlation</h3>
<p>To formally test which weeks are most highly related between cases and temperature.
We can use the cross-correlation function (<code>CCF()</code>) from the <strong>feasts</strong> package.
You could also visualise (rather than using <code>arrange</code>) using the <code>autoplot()</code> function.</p>
<div class="sourceCode" id="cb1127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1127-1"><a href="time-series.html#cb1127-1" aria-hidden="true" tabindex="-1"></a>counts <span class="sc">%&gt;%</span> </span>
<span id="cb1127-2"><a href="time-series.html#cb1127-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## calculate cross-correlation between interpolated counts and temperature</span></span>
<span id="cb1127-3"><a href="time-series.html#cb1127-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">CCF</span>(case_int, t2m,</span>
<span id="cb1127-4"><a href="time-series.html#cb1127-4" aria-hidden="true" tabindex="-1"></a>      <span class="do">## set the maximum lag to be 52 weeks</span></span>
<span id="cb1127-5"><a href="time-series.html#cb1127-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">lag_max =</span> <span class="dv">52</span>, </span>
<span id="cb1127-6"><a href="time-series.html#cb1127-6" aria-hidden="true" tabindex="-1"></a>      <span class="do">## return the correlation coefficient </span></span>
<span id="cb1127-7"><a href="time-series.html#cb1127-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">&quot;correlation&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1127-8"><a href="time-series.html#cb1127-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## arange in decending order of the correlation coefficient </span></span>
<span id="cb1127-9"><a href="time-series.html#cb1127-9" aria-hidden="true" tabindex="-1"></a>  <span class="do">## show the most associated lags</span></span>
<span id="cb1127-10"><a href="time-series.html#cb1127-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="sc">-</span>ccf) <span class="sc">%&gt;%</span> </span>
<span id="cb1127-11"><a href="time-series.html#cb1127-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## only show the top ten </span></span>
<span id="cb1127-12"><a href="time-series.html#cb1127-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_head</span>(<span class="at">n =</span> <span class="dv">10</span>)</span></code></pre></div>
<pre><code>## # A tsibble: 10 x 2 [1W]
##      lag   ccf
##    &lt;lag&gt; &lt;dbl&gt;
##  1    4W 0.749
##  2    5W 0.745
##  3    3W 0.735
##  4    6W 0.729
##  5    2W 0.727
##  6    7W 0.704
##  7    1W 0.695
##  8    8W 0.671
##  9    0W 0.649
## 10  -47W 0.638</code></pre>
<p>We see from this that a lag of 4 weeks is most highly correlated,
so we make a lagged temperature variable to include in our regression.</p>
<p><span style="color: red;"><strong><em>DANGER:</em></strong> Note that the first four weeks of our data
in the lagged temperature variable are missing (<code>NA</code>) - as there are not four
weeks prior to get data from. In order to use this dataset with the <strong>trending</strong>
<code>predict()</code> function, we need to use the the <code>simulate_pi = FALSE</code> argument within
<code>predict()</code> further down. If we did want to use the simulate option, then
we have to drop these missings and store as a new data set by adding <code>drop_na(t2m_lag4)</code>
to the code chunk below.</span></p>
<div class="sourceCode" id="cb1129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1129-1"><a href="time-series.html#cb1129-1" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1129-2"><a href="time-series.html#cb1129-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create a new variable for temperature lagged by four weeks</span></span>
<span id="cb1129-3"><a href="time-series.html#cb1129-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">t2m_lag4 =</span> <span class="fu">lag</span>(t2m, <span class="at">n =</span> <span class="dv">4</span>))</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="negative-binomial-with-two-variables" class="section level3 unnumbered">
<h3>Negative binomial with two variables</h3>
<p>We fit a negative binomial regression as done previously. This time we add the
temperature variable lagged by four weeks.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code>predict()</code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb1130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1130-1"><a href="time-series.html#cb1130-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1130-2"><a href="time-series.html#cb1130-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1130-3"><a href="time-series.html#cb1130-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1130-4"><a href="time-series.html#cb1130-4" aria-hidden="true" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1130-5"><a href="time-series.html#cb1130-5" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1130-6"><a href="time-series.html#cb1130-6" aria-hidden="true" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1130-7"><a href="time-series.html#cb1130-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use the fourier terms to account for seasonality</span></span>
<span id="cb1130-8"><a href="time-series.html#cb1130-8" aria-hidden="true" tabindex="-1"></a>    fourier <span class="sc">+</span> </span>
<span id="cb1130-9"><a href="time-series.html#cb1130-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use the temperature lagged by four weeks </span></span>
<span id="cb1130-10"><a href="time-series.html#cb1130-10" aria-hidden="true" tabindex="-1"></a>    t2m_lag4</span>
<span id="cb1130-11"><a href="time-series.html#cb1130-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1130-12"><a href="time-series.html#cb1130-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1130-13"><a href="time-series.html#cb1130-13" aria-hidden="true" tabindex="-1"></a><span class="do">## fit your model using the counts dataset</span></span>
<span id="cb1130-14"><a href="time-series.html#cb1130-14" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, counts)</span>
<span id="cb1130-15"><a href="time-series.html#cb1130-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1130-16"><a href="time-series.html#cb1130-16" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate confidence intervals and prediction intervals </span></span>
<span id="cb1130-17"><a href="time-series.html#cb1130-17" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>To investigate the individual terms, we can pull the original negative binomial
regression out of the <strong>trending</strong> format using <code>get_model()</code> and pass this to the
<strong>broom</strong> package <code>tidy()</code> function to retrieve exponentiated estimates and associated
confidence intervals.</p>
<p>What this shows us is that lagged temperature, after controlling for trend and seasonality,
is similar to the case counts (estimate ~ 1) and significantly associated.
This suggests that it might be a good variable for use in predicting future case
numbers (as climate forecasts are readily available).</p>
<div class="sourceCode" id="cb1131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1131-1"><a href="time-series.html#cb1131-1" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1131-2"><a href="time-series.html#cb1131-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extract original negative binomial regression</span></span>
<span id="cb1131-3"><a href="time-series.html#cb1131-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_model</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1131-4"><a href="time-series.html#cb1131-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get a tidy dataframe of results</span></span>
<span id="cb1131-5"><a href="time-series.html#cb1131-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, </span>
<span id="cb1131-6"><a href="time-series.html#cb1131-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 7
##   term           estimate  std.error statistic  p.value   conf.low  conf.high
##   &lt;chr&gt;             &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
## 1 (Intercept)   5.83      0.108          53.8  0         5.61       6.04     
## 2 epiweek       0.0000846 0.00000774     10.9  8.13e-28  0.0000695  0.0000998
## 3 fourierS1-52 -0.285     0.0214        -13.3  1.84e-40 -0.327     -0.243    
## 4 fourierC1-52 -0.195     0.0200         -9.78 1.35e-22 -0.234     -0.157    
## 5 t2m_lag4      0.00667   0.00269         2.48 1.30e- 2  0.00139    0.0119</code></pre>
<p>A quick visual inspection of the model shows that it might do a better job of
estimating the observed case counts.</p>
<div class="sourceCode" id="cb1133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1133-1"><a href="time-series.html#cb1133-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot your regression </span></span>
<span id="cb1133-2"><a href="time-series.html#cb1133-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> observed, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1133-3"><a href="time-series.html#cb1133-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1133-4"><a href="time-series.html#cb1133-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate),</span>
<span id="cb1133-5"><a href="time-series.html#cb1133-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;Red&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1133-6"><a href="time-series.html#cb1133-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1133-7"><a href="time-series.html#cb1133-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1133-8"><a href="time-series.html#cb1133-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1133-9"><a href="time-series.html#cb1133-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1133-10"><a href="time-series.html#cb1133-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a line for your observed case counts</span></span>
<span id="cb1133-11"><a href="time-series.html#cb1133-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1133-12"><a href="time-series.html#cb1133-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1133-13"><a href="time-series.html#cb1133-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1133-14"><a href="time-series.html#cb1133-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_nb_reg_bivar-1.png" width="672" /></p>
<div id="residuals-1" class="section level4 unnumbered">
<h4>Residuals</h4>
<p>We investigate the residuals again to see how well our model fits the observed data.
The results and interpretation here are similar to those of the previous regression,
so it may be more feasible to stick with the simpler model without temperature.</p>
<div class="sourceCode" id="cb1134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1134-1"><a href="time-series.html#cb1134-1" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate the residuals </span></span>
<span id="cb1134-2"><a href="time-series.html#cb1134-2" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> observed <span class="sc">%&gt;%</span> </span>
<span id="cb1134-3"><a href="time-series.html#cb1134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">resid =</span> case_int <span class="sc">-</span> estimate)</span>
<span id="cb1134-4"><a href="time-series.html#cb1134-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1134-5"><a href="time-series.html#cb1134-5" aria-hidden="true" tabindex="-1"></a><span class="do">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span></span>
<span id="cb1134-6"><a href="time-series.html#cb1134-6" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span></span>
<span id="cb1134-7"><a href="time-series.html#cb1134-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> epiweek, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1134-8"><a href="time-series.html#cb1134-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb1134-9"><a href="time-series.html#cb1134-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span> </span>
<span id="cb1134-10"><a href="time-series.html#cb1134-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;epiweek&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 4 row(s) containing missing values (geom_path).</code></pre>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_point).</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-855-1.png" width="672" /></p>
<div class="sourceCode" id="cb1137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1137-1"><a href="time-series.html#cb1137-1" aria-hidden="true" tabindex="-1"></a><span class="do">## is there autocorelation in the residuals (is there a pattern to the error?)  </span></span>
<span id="cb1137-2"><a href="time-series.html#cb1137-2" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span> </span>
<span id="cb1137-3"><a href="time-series.html#cb1137-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1137-4"><a href="time-series.html#cb1137-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ACF</span>(resid, <span class="at">lag_max =</span> <span class="dv">52</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1137-5"><a href="time-series.html#cb1137-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-855-2.png" width="672" /></p>
<div class="sourceCode" id="cb1138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1138-1"><a href="time-series.html#cb1138-1" aria-hidden="true" tabindex="-1"></a><span class="do">## are residuals normally distributed (are under or over estimating?)  </span></span>
<span id="cb1138-2"><a href="time-series.html#cb1138-2" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span></span>
<span id="cb1138-3"><a href="time-series.html#cb1138-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> resid)) <span class="sc">+</span></span>
<span id="cb1138-4"><a href="time-series.html#cb1138-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">binwidth =</span> <span class="dv">100</span>) <span class="sc">+</span></span>
<span id="cb1138-5"><a href="time-series.html#cb1138-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_rug</span>() <span class="sc">+</span></span>
<span id="cb1138-6"><a href="time-series.html#cb1138-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;count&quot;</span>) </span></code></pre></div>
<pre><code>## Warning: Removed 4 rows containing non-finite values (stat_bin).</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-855-3.png" width="672" /></p>
<div class="sourceCode" id="cb1140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1140-1"><a href="time-series.html#cb1140-1" aria-hidden="true" tabindex="-1"></a><span class="do">## compare observed counts to their residuals </span></span>
<span id="cb1140-2"><a href="time-series.html#cb1140-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## should also be no pattern </span></span>
<span id="cb1140-3"><a href="time-series.html#cb1140-3" aria-hidden="true" tabindex="-1"></a>observed <span class="sc">%&gt;%</span></span>
<span id="cb1140-4"><a href="time-series.html#cb1140-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> estimate, <span class="at">y =</span> resid)) <span class="sc">+</span></span>
<span id="cb1140-5"><a href="time-series.html#cb1140-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb1140-6"><a href="time-series.html#cb1140-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Fitted&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Residuals&quot;</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 4 rows containing missing values (geom_point).</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-855-4.png" width="672" /></p>
<div class="sourceCode" id="cb1142"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1142-1"><a href="time-series.html#cb1142-1" aria-hidden="true" tabindex="-1"></a><span class="do">## formally test autocorrelation of the residuals</span></span>
<span id="cb1142-2"><a href="time-series.html#cb1142-2" aria-hidden="true" tabindex="-1"></a><span class="do">## H0 is that residuals are from a white-noise series (i.e. random)</span></span>
<span id="cb1142-3"><a href="time-series.html#cb1142-3" aria-hidden="true" tabindex="-1"></a><span class="do">## test for independence </span></span>
<span id="cb1142-4"><a href="time-series.html#cb1142-4" aria-hidden="true" tabindex="-1"></a><span class="do">## if p value significant then non-random</span></span>
<span id="cb1142-5"><a href="time-series.html#cb1142-5" aria-hidden="true" tabindex="-1"></a><span class="fu">Box.test</span>(observed<span class="sc">$</span>resid, <span class="at">type =</span> <span class="st">&quot;Ljung-Box&quot;</span>)</span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  observed$resid
## X-squared = 339.52, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="outbreak-detection" class="section level2" number="23.7">
<h2><span class="header-section-number">23.7</span> Outbreak detection</h2>
<p>We will demonstrate two (similar) methods of detecting outbreaks here.
The first builds on the sections above.
We use the <strong>trending</strong> package to fit regressions to previous years, and then
predict what we expect to see in the following year. If observed counts are above
what we expect, then it could suggest there is an outbreak.
The second method is based on similar principles but uses the <strong>surveillance</strong> package,
which has a number of different algorithms for aberration detection.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Normally, you are interested in the current year (where you only know counts up to the present week). So in this example we are pretending to be in week 39 of 2011.</span></p>
<!-- ======================================================= -->
<div id="trending-package" class="section level3 unnumbered">
<h3><strong>trending</strong> package</h3>
<p>For this method we define a baseline (which should usually be about 5 years of data).
We fit a regression to the baseline data, and then use that to predict the estimates
for the next year.</p>
<!-- ======================================================= -->
<div id="cut-off-date" class="section level4 unnumbered">
<h4>Cut-off date</h4>
<p>It is easier to define your dates in one place and then use these throughout the
rest of your code.</p>
<p>Here we define a start date (when our observations started) and a cut-off date
(the end of our baseline period - and when the period we want to predict for starts).
~We also define how many weeks are in our year of interest (the one we are going to
be predicting)~.
We also define how many weeks are between our baseline cut-off and the end date
that we are interested in predicting for.</p>
<p><span style="color: black;"><strong><em>NOTE:</em></strong> In this example we pretend to currently be at the end of September 2011 (“2011 W39”).</span></p>
<div class="sourceCode" id="cb1144"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1144-1"><a href="time-series.html#cb1144-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define start date (when observations began)</span></span>
<span id="cb1144-2"><a href="time-series.html#cb1144-2" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">min</span>(counts<span class="sc">$</span>epiweek)</span>
<span id="cb1144-3"><a href="time-series.html#cb1144-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1144-4"><a href="time-series.html#cb1144-4" aria-hidden="true" tabindex="-1"></a><span class="do">## define a cut-off week (end of baseline, start of prediction period)</span></span>
<span id="cb1144-5"><a href="time-series.html#cb1144-5" aria-hidden="true" tabindex="-1"></a>cut_off <span class="ot">&lt;-</span> <span class="fu">yearweek</span>(<span class="st">&quot;2010-12-31&quot;</span>)</span>
<span id="cb1144-6"><a href="time-series.html#cb1144-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1144-7"><a href="time-series.html#cb1144-7" aria-hidden="true" tabindex="-1"></a><span class="do">## define the last date interested in (i.e. end of prediction)</span></span>
<span id="cb1144-8"><a href="time-series.html#cb1144-8" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">yearweek</span>(<span class="st">&quot;2011-12-31&quot;</span>)</span>
<span id="cb1144-9"><a href="time-series.html#cb1144-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1144-10"><a href="time-series.html#cb1144-10" aria-hidden="true" tabindex="-1"></a><span class="do">## find how many weeks in period (year) of interest</span></span>
<span id="cb1144-11"><a href="time-series.html#cb1144-11" aria-hidden="true" tabindex="-1"></a>num_weeks <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(end_date <span class="sc">-</span> cut_off)</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="add-rows-1" class="section level4 unnumbered">
<h4>Add rows</h4>
<p>To be able to forecast in a tidyverse format, we need to have the right number
of rows in our dataset, i.e. one row for each week up to the <code>end_date</code>defined above.
The code below allows you to add these rows for by a grouping variable - for example
if we had multiple countries in one dataset, we could group by country and then
add rows appropriately for each.
The <code>group_by_key()</code> function from <strong>tsibble</strong> allows us to do this grouping
and then pass the grouped data to <strong>dplyr</strong> functions, <code>group_modify()</code> and
<code>add_row()</code>. Then we specify the sequence of weeks between one after the maximum week
currently available in the data and the end week.</p>
<div class="sourceCode" id="cb1145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1145-1"><a href="time-series.html#cb1145-1" aria-hidden="true" tabindex="-1"></a><span class="do">## add in missing weeks till end of year </span></span>
<span id="cb1145-2"><a href="time-series.html#cb1145-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span></span>
<span id="cb1145-3"><a href="time-series.html#cb1145-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## group by the region</span></span>
<span id="cb1145-4"><a href="time-series.html#cb1145-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by_key</span>() <span class="sc">%&gt;%</span></span>
<span id="cb1145-5"><a href="time-series.html#cb1145-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">## for each group add rows from the highest epiweek to the end of year</span></span>
<span id="cb1145-6"><a href="time-series.html#cb1145-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_modify</span>(<span class="sc">~</span><span class="fu">add_row</span>(.,</span>
<span id="cb1145-7"><a href="time-series.html#cb1145-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">epiweek =</span> <span class="fu">seq</span>(<span class="fu">max</span>(.<span class="sc">$</span>epiweek) <span class="sc">+</span> <span class="dv">1</span>, </span>
<span id="cb1145-8"><a href="time-series.html#cb1145-8" aria-hidden="true" tabindex="-1"></a>                                      end_date,</span>
<span id="cb1145-9"><a href="time-series.html#cb1145-9" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">by =</span> <span class="dv">1</span>)))</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="fourier-terms-1" class="section level4 unnumbered">
<h4>Fourier terms</h4>
<p>We need to redefine our fourier terms - as we want to fit them to the baseline
date only and then predict (extrapolate) those terms for the next year.
To do this we need to combine two output lists from the <code>fourier()</code> function together;
the first one is for the baseline data, and the second one predicts for the
year of interest (by defining the <code>h</code> argument).</p>
<p><em>N.b.</em> to bind rows we have to use <code>rbind()</code> (rather than tidyverse <code>bind_rows</code>) as
the fourier columns are a list (so not named individually).</p>
<div class="sourceCode" id="cb1146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1146-1"><a href="time-series.html#cb1146-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define fourier terms (sincos) </span></span>
<span id="cb1146-2"><a href="time-series.html#cb1146-2" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1146-3"><a href="time-series.html#cb1146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1146-4"><a href="time-series.html#cb1146-4" aria-hidden="true" tabindex="-1"></a>    <span class="do">## combine fourier terms for weeks prior to  and after 2010 cut-off date</span></span>
<span id="cb1146-5"><a href="time-series.html#cb1146-5" aria-hidden="true" tabindex="-1"></a>    <span class="do">## (nb. 2011 fourier terms are predicted)</span></span>
<span id="cb1146-6"><a href="time-series.html#cb1146-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">fourier =</span> <span class="fu">rbind</span>(</span>
<span id="cb1146-7"><a href="time-series.html#cb1146-7" aria-hidden="true" tabindex="-1"></a>      <span class="do">## get fourier terms for previous years</span></span>
<span id="cb1146-8"><a href="time-series.html#cb1146-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fourier</span>(</span>
<span id="cb1146-9"><a href="time-series.html#cb1146-9" aria-hidden="true" tabindex="-1"></a>        <span class="do">## only keep the rows before 2011</span></span>
<span id="cb1146-10"><a href="time-series.html#cb1146-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(counts, </span>
<span id="cb1146-11"><a href="time-series.html#cb1146-11" aria-hidden="true" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cut_off), </span>
<span id="cb1146-12"><a href="time-series.html#cb1146-12" aria-hidden="true" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1146-13"><a href="time-series.html#cb1146-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span></span>
<span id="cb1146-14"><a href="time-series.html#cb1146-14" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb1146-15"><a href="time-series.html#cb1146-15" aria-hidden="true" tabindex="-1"></a>      <span class="do">## predict the fourier terms for 2011 (using baseline data)</span></span>
<span id="cb1146-16"><a href="time-series.html#cb1146-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fourier</span>(</span>
<span id="cb1146-17"><a href="time-series.html#cb1146-17" aria-hidden="true" tabindex="-1"></a>        <span class="do">## only keep the rows before 2011</span></span>
<span id="cb1146-18"><a href="time-series.html#cb1146-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(counts, </span>
<span id="cb1146-19"><a href="time-series.html#cb1146-19" aria-hidden="true" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cut_off),</span>
<span id="cb1146-20"><a href="time-series.html#cb1146-20" aria-hidden="true" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1146-21"><a href="time-series.html#cb1146-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span>, </span>
<span id="cb1146-22"><a href="time-series.html#cb1146-22" aria-hidden="true" tabindex="-1"></a>        <span class="do">## predict 52 weeks ahead</span></span>
<span id="cb1146-23"><a href="time-series.html#cb1146-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">h =</span> num_weeks</span>
<span id="cb1146-24"><a href="time-series.html#cb1146-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1146-25"><a href="time-series.html#cb1146-25" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1146-26"><a href="time-series.html#cb1146-26" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="split-data-and-fit-regression" class="section level4 unnumbered">
<h4>Split data and fit regression</h4>
<p>We now have to split our dataset in to the baseline period and the prediction
period. This is done using the <strong>dplyr</strong> <code>group_split()</code> function after <code>group_by()</code>,
and will create a list with two data frames, one for before your cut-off and one
for after.</p>
<p>We then use the <strong>purrr</strong> package <code>pluck()</code> function to pull the datasets out of the
list (equivalent of using square brackets, e.g. <code>dat[[1]]</code>), and can then fit
our model to the baseline data, and then use the <code>predict()</code> function for our data
of interest after the cut-off.</p>
<p>See the page on [Iteration, loops, and lists] to learn more about <strong>purrr</strong>.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code>predict()</code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb1147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1147-1"><a href="time-series.html#cb1147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># split data for fitting and prediction</span></span>
<span id="cb1147-2"><a href="time-series.html#cb1147-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1147-3"><a href="time-series.html#cb1147-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(epiweek <span class="sc">&lt;=</span> cut_off) <span class="sc">%&gt;%</span></span>
<span id="cb1147-4"><a href="time-series.html#cb1147-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_split</span>()</span>
<span id="cb1147-5"><a href="time-series.html#cb1147-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1147-6"><a href="time-series.html#cb1147-6" aria-hidden="true" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1147-7"><a href="time-series.html#cb1147-7" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1147-8"><a href="time-series.html#cb1147-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1147-9"><a href="time-series.html#cb1147-9" aria-hidden="true" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1147-10"><a href="time-series.html#cb1147-10" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1147-11"><a href="time-series.html#cb1147-11" aria-hidden="true" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1147-12"><a href="time-series.html#cb1147-12" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use the furier terms to account for seasonality</span></span>
<span id="cb1147-13"><a href="time-series.html#cb1147-13" aria-hidden="true" tabindex="-1"></a>    fourier</span>
<span id="cb1147-14"><a href="time-series.html#cb1147-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1147-15"><a href="time-series.html#cb1147-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1147-16"><a href="time-series.html#cb1147-16" aria-hidden="true" tabindex="-1"></a><span class="co"># define which data to use for fitting and which for predicting</span></span>
<span id="cb1147-17"><a href="time-series.html#cb1147-17" aria-hidden="true" tabindex="-1"></a>fitting_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">2</span>)</span>
<span id="cb1147-18"><a href="time-series.html#cb1147-18" aria-hidden="true" tabindex="-1"></a>pred_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1147-19"><a href="time-series.html#cb1147-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(case_int, epiweek, fourier)</span>
<span id="cb1147-20"><a href="time-series.html#cb1147-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1147-21"><a href="time-series.html#cb1147-21" aria-hidden="true" tabindex="-1"></a><span class="co"># fit model </span></span>
<span id="cb1147-22"><a href="time-series.html#cb1147-22" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, fitting_data)</span>
<span id="cb1147-23"><a href="time-series.html#cb1147-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1147-24"><a href="time-series.html#cb1147-24" aria-hidden="true" tabindex="-1"></a><span class="co"># get confint and estimates for fitted data</span></span>
<span id="cb1147-25"><a href="time-series.html#cb1147-25" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1147-26"><a href="time-series.html#cb1147-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(<span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1147-27"><a href="time-series.html#cb1147-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1147-28"><a href="time-series.html#cb1147-28" aria-hidden="true" tabindex="-1"></a><span class="co"># forecast with data want to predict with </span></span>
<span id="cb1147-29"><a href="time-series.html#cb1147-29" aria-hidden="true" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1147-30"><a href="time-series.html#cb1147-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">predict</span>(pred_data, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1147-31"><a href="time-series.html#cb1147-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1147-32"><a href="time-series.html#cb1147-32" aria-hidden="true" tabindex="-1"></a><span class="do">## combine baseline and predicted datasets</span></span>
<span id="cb1147-33"><a href="time-series.html#cb1147-33" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(observed, forecasts)</span></code></pre></div>
<p>As previously, we can visualise our model with <strong>ggplot</strong>. We highlight alerts with
red dots for observed counts above the 95% prediction interval.
This time we also add a vertical line to label when the forecast starts.</p>
<div class="sourceCode" id="cb1148"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1148-1"><a href="time-series.html#cb1148-1" aria-hidden="true" tabindex="-1"></a><span class="do">## plot your regression </span></span>
<span id="cb1148-2"><a href="time-series.html#cb1148-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> observed, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1148-3"><a href="time-series.html#cb1148-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1148-4"><a href="time-series.html#cb1148-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate),</span>
<span id="cb1148-5"><a href="time-series.html#cb1148-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1148-6"><a href="time-series.html#cb1148-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1148-7"><a href="time-series.html#cb1148-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1148-8"><a href="time-series.html#cb1148-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1148-9"><a href="time-series.html#cb1148-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1148-10"><a href="time-series.html#cb1148-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a line for your observed case counts</span></span>
<span id="cb1148-11"><a href="time-series.html#cb1148-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1148-12"><a href="time-series.html#cb1148-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">col =</span> <span class="st">&quot;black&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1148-13"><a href="time-series.html#cb1148-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## plot in points for the observed counts above expected</span></span>
<span id="cb1148-14"><a href="time-series.html#cb1148-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb1148-15"><a href="time-series.html#cb1148-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">filter</span>(observed, case_int <span class="sc">&gt;</span> upper_pi), </span>
<span id="cb1148-16"><a href="time-series.html#cb1148-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> case_int), </span>
<span id="cb1148-17"><a href="time-series.html#cb1148-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">colour =</span> <span class="st">&quot;red&quot;</span>, </span>
<span id="cb1148-18"><a href="time-series.html#cb1148-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> </span>
<span id="cb1148-19"><a href="time-series.html#cb1148-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add vertical line and label to show where forecasting started</span></span>
<span id="cb1148-20"><a href="time-series.html#cb1148-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb1148-21"><a href="time-series.html#cb1148-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">xintercept =</span> <span class="fu">as.Date</span>(cut_off), </span>
<span id="cb1148-22"><a href="time-series.html#cb1148-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1148-23"><a href="time-series.html#cb1148-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, </span>
<span id="cb1148-24"><a href="time-series.html#cb1148-24" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">&quot;Forecast&quot;</span>, </span>
<span id="cb1148-25"><a href="time-series.html#cb1148-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> cut_off, </span>
<span id="cb1148-26"><a href="time-series.html#cb1148-26" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> <span class="fu">max</span>(observed<span class="sc">$</span>upper_pi) <span class="sc">-</span> <span class="dv">250</span>, </span>
<span id="cb1148-27"><a href="time-series.html#cb1148-27" aria-hidden="true" tabindex="-1"></a>           <span class="at">angle =</span> <span class="dv">90</span>, </span>
<span id="cb1148-28"><a href="time-series.html#cb1148-28" aria-hidden="true" tabindex="-1"></a>           <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb1148-29"><a href="time-series.html#cb1148-29" aria-hidden="true" tabindex="-1"></a>           ) <span class="sc">+</span> </span>
<span id="cb1148-30"><a href="time-series.html#cb1148-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1148-31"><a href="time-series.html#cb1148-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<pre><code>## Warning: Removed 13 row(s) containing missing values (geom_path).</code></pre>
<p><img src="_main_files/figure-html/forecast_plot-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="prediction-validation" class="section level4 unnumbered">
<h4>Prediction validation</h4>
<p>Beyond inspecting residuals, it is important to investigate how good your model is
at predicting cases in the future. This gives you an idea of how reliable your
threshold alerts are.</p>
<p>The traditional way of validating is to see how well you can predict the latest
year before the present one (because you don’t yet know the counts for the “current year”).
For example in our data set we would use the data from 2002 to 2009 to predict 2010,
and then see how accurate those predictions are. Then refit the model to include
2010 data and use that to predict 2011 counts.</p>
<p>As can be seen in the figure below by <em>Hyndman et al</em> in <a href="https://otexts.com/fpp3/">“Forecasting principles
and practice”</a>.</p>
<p><img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png" />
<em>figure reproduced with permission from the authors</em></p>
<p>The downside of this is that you are not using all the data available to you, and
it is not the final model that you are using for prediction.</p>
<p>An alternative is to use a method called cross-validation. In this scenario you
roll over all of the data available to fit multiple models to predict one year ahead.
You use more and more data in each model, as seen in the figure below from the
same [<em>Hyndman et al</em> text]((<a href="https://otexts.com/fpp3/" class="uri">https://otexts.com/fpp3/</a>).
For example, the first model uses 2002 to predict 2003, the second uses 2002 and
2003 to predict 2004, and so on.
<img src="https://otexts.com/fpp2/fpp_files/figure-html/cv1-1.png" />
<em>figure reproduced with permission from the authors</em></p>
<p>In the below we use <strong>purrr</strong> package <code>map()</code> function to loop over each dataset.
We then put estimates in one data set and merge with the original case counts,
to use the <strong>yardstick</strong> package to compute measures of accuracy.
We compute four measures including: Root mean squared error (RMSE), Mean absolute error
(MAE), Mean absolute scaled error (MASE), Mean absolute percent error (MAPE).</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code>predict()</code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb1150"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1150-1"><a href="time-series.html#cb1150-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Cross validation: predicting week(s) ahead based on sliding window</span></span>
<span id="cb1150-2"><a href="time-series.html#cb1150-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-3"><a href="time-series.html#cb1150-3" aria-hidden="true" tabindex="-1"></a><span class="do">## expand your data by rolling over in 52 week windows (before + after) </span></span>
<span id="cb1150-4"><a href="time-series.html#cb1150-4" aria-hidden="true" tabindex="-1"></a><span class="do">## to predict 52 week ahead</span></span>
<span id="cb1150-5"><a href="time-series.html#cb1150-5" aria-hidden="true" tabindex="-1"></a><span class="do">## (creates longer and longer chains of observations - keeps older data)</span></span>
<span id="cb1150-6"><a href="time-series.html#cb1150-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-7"><a href="time-series.html#cb1150-7" aria-hidden="true" tabindex="-1"></a><span class="do">## define window want to roll over</span></span>
<span id="cb1150-8"><a href="time-series.html#cb1150-8" aria-hidden="true" tabindex="-1"></a>roll_window <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb1150-9"><a href="time-series.html#cb1150-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-10"><a href="time-series.html#cb1150-10" aria-hidden="true" tabindex="-1"></a><span class="do">## define weeks ahead want to predict </span></span>
<span id="cb1150-11"><a href="time-series.html#cb1150-11" aria-hidden="true" tabindex="-1"></a>weeks_ahead <span class="ot">&lt;-</span> <span class="dv">52</span></span>
<span id="cb1150-12"><a href="time-series.html#cb1150-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-13"><a href="time-series.html#cb1150-13" aria-hidden="true" tabindex="-1"></a><span class="do">## create a data set of repeating, increasingly long data</span></span>
<span id="cb1150-14"><a href="time-series.html#cb1150-14" aria-hidden="true" tabindex="-1"></a><span class="do">## label each data set with a unique id</span></span>
<span id="cb1150-15"><a href="time-series.html#cb1150-15" aria-hidden="true" tabindex="-1"></a><span class="do">## only use cases before year of interest (i.e. 2011)</span></span>
<span id="cb1150-16"><a href="time-series.html#cb1150-16" aria-hidden="true" tabindex="-1"></a>case_roll <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1150-17"><a href="time-series.html#cb1150-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(epiweek <span class="sc">&lt;</span> cut_off) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-18"><a href="time-series.html#cb1150-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## only keep the week and case counts variables</span></span>
<span id="cb1150-19"><a href="time-series.html#cb1150-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(epiweek, case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-20"><a href="time-series.html#cb1150-20" aria-hidden="true" tabindex="-1"></a>    <span class="do">## drop the last x observations </span></span>
<span id="cb1150-21"><a href="time-series.html#cb1150-21" aria-hidden="true" tabindex="-1"></a>    <span class="do">## depending on how many weeks ahead forecasting </span></span>
<span id="cb1150-22"><a href="time-series.html#cb1150-22" aria-hidden="true" tabindex="-1"></a>    <span class="do">## (otherwise will be an actual forecast to &quot;unknown&quot;)</span></span>
<span id="cb1150-23"><a href="time-series.html#cb1150-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">n</span>() <span class="sc">-</span> weeks_ahead)) <span class="sc">%&gt;%</span></span>
<span id="cb1150-24"><a href="time-series.html#cb1150-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-25"><a href="time-series.html#cb1150-25" aria-hidden="true" tabindex="-1"></a>    <span class="do">## roll over each week in x after windows to create grouping ID </span></span>
<span id="cb1150-26"><a href="time-series.html#cb1150-26" aria-hidden="true" tabindex="-1"></a>    <span class="do">## depending on what rolling window specify</span></span>
<span id="cb1150-27"><a href="time-series.html#cb1150-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stretch_tsibble</span>(<span class="at">.init =</span> roll_window, <span class="at">.step =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-28"><a href="time-series.html#cb1150-28" aria-hidden="true" tabindex="-1"></a>  <span class="do">## drop the first couple - as have no &quot;before&quot; cases</span></span>
<span id="cb1150-29"><a href="time-series.html#cb1150-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.id <span class="sc">&gt;</span> roll_window)</span>
<span id="cb1150-30"><a href="time-series.html#cb1150-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-31"><a href="time-series.html#cb1150-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-32"><a href="time-series.html#cb1150-32" aria-hidden="true" tabindex="-1"></a><span class="do">## for each of the unique data sets run the code below</span></span>
<span id="cb1150-33"><a href="time-series.html#cb1150-33" aria-hidden="true" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="fu">unique</span>(case_roll<span class="sc">$</span>.id), </span>
<span id="cb1150-34"><a href="time-series.html#cb1150-34" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">function</span>(i) {</span>
<span id="cb1150-35"><a href="time-series.html#cb1150-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-36"><a href="time-series.html#cb1150-36" aria-hidden="true" tabindex="-1"></a>  <span class="do">## only keep the current fold being fit </span></span>
<span id="cb1150-37"><a href="time-series.html#cb1150-37" aria-hidden="true" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> <span class="fu">filter</span>(case_roll, .id <span class="sc">==</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-38"><a href="time-series.html#cb1150-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>()</span>
<span id="cb1150-39"><a href="time-series.html#cb1150-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-40"><a href="time-series.html#cb1150-40" aria-hidden="true" tabindex="-1"></a>  <span class="do">## create an empty data set for forecasting on </span></span>
<span id="cb1150-41"><a href="time-series.html#cb1150-41" aria-hidden="true" tabindex="-1"></a>  forecast_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb1150-42"><a href="time-series.html#cb1150-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">epiweek =</span> <span class="fu">seq</span>(<span class="fu">max</span>(mini_data<span class="sc">$</span>epiweek) <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb1150-43"><a href="time-series.html#cb1150-43" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">max</span>(mini_data<span class="sc">$</span>epiweek) <span class="sc">+</span> weeks_ahead,</span>
<span id="cb1150-44"><a href="time-series.html#cb1150-44" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="dv">1</span>),</span>
<span id="cb1150-45"><a href="time-series.html#cb1150-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">case_int =</span> <span class="fu">rep.int</span>(<span class="cn">NA</span>, weeks_ahead),</span>
<span id="cb1150-46"><a href="time-series.html#cb1150-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">.id =</span> <span class="fu">rep.int</span>(i, weeks_ahead)</span>
<span id="cb1150-47"><a href="time-series.html#cb1150-47" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1150-48"><a href="time-series.html#cb1150-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-49"><a href="time-series.html#cb1150-49" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add the forecast data to the original </span></span>
<span id="cb1150-50"><a href="time-series.html#cb1150-50" aria-hidden="true" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(mini_data, forecast_data)</span>
<span id="cb1150-51"><a href="time-series.html#cb1150-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-52"><a href="time-series.html#cb1150-52" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define the cut off based on latest non missing count data </span></span>
<span id="cb1150-53"><a href="time-series.html#cb1150-53" aria-hidden="true" tabindex="-1"></a>  cv_cut_off <span class="ot">&lt;-</span> mini_data <span class="sc">%&gt;%</span> </span>
<span id="cb1150-54"><a href="time-series.html#cb1150-54" aria-hidden="true" tabindex="-1"></a>    <span class="do">## only keep non-missing rows</span></span>
<span id="cb1150-55"><a href="time-series.html#cb1150-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>(case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-56"><a href="time-series.html#cb1150-56" aria-hidden="true" tabindex="-1"></a>    <span class="do">## get the latest week</span></span>
<span id="cb1150-57"><a href="time-series.html#cb1150-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="fu">max</span>(epiweek)) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-58"><a href="time-series.html#cb1150-58" aria-hidden="true" tabindex="-1"></a>    <span class="do">## extract so is not in a dataframe</span></span>
<span id="cb1150-59"><a href="time-series.html#cb1150-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>()</span>
<span id="cb1150-60"><a href="time-series.html#cb1150-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-61"><a href="time-series.html#cb1150-61" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make mini_data back in to a tsibble</span></span>
<span id="cb1150-62"><a href="time-series.html#cb1150-62" aria-hidden="true" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> <span class="fu">tsibble</span>(mini_data, <span class="at">index =</span> epiweek)</span>
<span id="cb1150-63"><a href="time-series.html#cb1150-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-64"><a href="time-series.html#cb1150-64" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define fourier terms (sincos) </span></span>
<span id="cb1150-65"><a href="time-series.html#cb1150-65" aria-hidden="true" tabindex="-1"></a>  mini_data <span class="ot">&lt;-</span> mini_data <span class="sc">%&gt;%</span> </span>
<span id="cb1150-66"><a href="time-series.html#cb1150-66" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb1150-67"><a href="time-series.html#cb1150-67" aria-hidden="true" tabindex="-1"></a>    <span class="do">## combine fourier terms for weeks prior to  and after cut-off date</span></span>
<span id="cb1150-68"><a href="time-series.html#cb1150-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">fourier =</span> <span class="fu">rbind</span>(</span>
<span id="cb1150-69"><a href="time-series.html#cb1150-69" aria-hidden="true" tabindex="-1"></a>      <span class="do">## get fourier terms for previous years</span></span>
<span id="cb1150-70"><a href="time-series.html#cb1150-70" aria-hidden="true" tabindex="-1"></a>      forecast<span class="sc">::</span><span class="fu">fourier</span>(</span>
<span id="cb1150-71"><a href="time-series.html#cb1150-71" aria-hidden="true" tabindex="-1"></a>        <span class="do">## only keep the rows before cut-off</span></span>
<span id="cb1150-72"><a href="time-series.html#cb1150-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(mini_data, </span>
<span id="cb1150-73"><a href="time-series.html#cb1150-73" aria-hidden="true" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cv_cut_off), </span>
<span id="cb1150-74"><a href="time-series.html#cb1150-74" aria-hidden="true" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1150-75"><a href="time-series.html#cb1150-75" aria-hidden="true" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span></span>
<span id="cb1150-76"><a href="time-series.html#cb1150-76" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb1150-77"><a href="time-series.html#cb1150-77" aria-hidden="true" tabindex="-1"></a>      <span class="do">## predict the fourier terms for following year (using baseline data)</span></span>
<span id="cb1150-78"><a href="time-series.html#cb1150-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fourier</span>(</span>
<span id="cb1150-79"><a href="time-series.html#cb1150-79" aria-hidden="true" tabindex="-1"></a>        <span class="do">## only keep the rows before cut-off</span></span>
<span id="cb1150-80"><a href="time-series.html#cb1150-80" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(mini_data, </span>
<span id="cb1150-81"><a href="time-series.html#cb1150-81" aria-hidden="true" tabindex="-1"></a>               epiweek <span class="sc">&lt;=</span> cv_cut_off),</span>
<span id="cb1150-82"><a href="time-series.html#cb1150-82" aria-hidden="true" tabindex="-1"></a>        <span class="do">## include one set of sin cos terms </span></span>
<span id="cb1150-83"><a href="time-series.html#cb1150-83" aria-hidden="true" tabindex="-1"></a>        <span class="at">K =</span> <span class="dv">1</span>, </span>
<span id="cb1150-84"><a href="time-series.html#cb1150-84" aria-hidden="true" tabindex="-1"></a>        <span class="do">## predict 52 weeks ahead</span></span>
<span id="cb1150-85"><a href="time-series.html#cb1150-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">h =</span> weeks_ahead</span>
<span id="cb1150-86"><a href="time-series.html#cb1150-86" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1150-87"><a href="time-series.html#cb1150-87" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb1150-88"><a href="time-series.html#cb1150-88" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1150-89"><a href="time-series.html#cb1150-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-90"><a href="time-series.html#cb1150-90" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-91"><a href="time-series.html#cb1150-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># split data for fitting and prediction</span></span>
<span id="cb1150-92"><a href="time-series.html#cb1150-92" aria-hidden="true" tabindex="-1"></a>  dat <span class="ot">&lt;-</span> mini_data <span class="sc">%&gt;%</span> </span>
<span id="cb1150-93"><a href="time-series.html#cb1150-93" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(epiweek <span class="sc">&lt;=</span> cv_cut_off) <span class="sc">%&gt;%</span></span>
<span id="cb1150-94"><a href="time-series.html#cb1150-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_split</span>()</span>
<span id="cb1150-95"><a href="time-series.html#cb1150-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-96"><a href="time-series.html#cb1150-96" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1150-97"><a href="time-series.html#cb1150-97" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1150-98"><a href="time-series.html#cb1150-98" aria-hidden="true" tabindex="-1"></a>    <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1150-99"><a href="time-series.html#cb1150-99" aria-hidden="true" tabindex="-1"></a>    case_int <span class="sc">~</span></span>
<span id="cb1150-100"><a href="time-series.html#cb1150-100" aria-hidden="true" tabindex="-1"></a>      <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1150-101"><a href="time-series.html#cb1150-101" aria-hidden="true" tabindex="-1"></a>      epiweek <span class="sc">+</span></span>
<span id="cb1150-102"><a href="time-series.html#cb1150-102" aria-hidden="true" tabindex="-1"></a>      <span class="do">## use the furier terms to account for seasonality</span></span>
<span id="cb1150-103"><a href="time-series.html#cb1150-103" aria-hidden="true" tabindex="-1"></a>      fourier</span>
<span id="cb1150-104"><a href="time-series.html#cb1150-104" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1150-105"><a href="time-series.html#cb1150-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-106"><a href="time-series.html#cb1150-106" aria-hidden="true" tabindex="-1"></a>  <span class="co"># define which data to use for fitting and which for predicting</span></span>
<span id="cb1150-107"><a href="time-series.html#cb1150-107" aria-hidden="true" tabindex="-1"></a>  fitting_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">2</span>)</span>
<span id="cb1150-108"><a href="time-series.html#cb1150-108" aria-hidden="true" tabindex="-1"></a>  pred_data <span class="ot">&lt;-</span> <span class="fu">pluck</span>(dat, <span class="dv">1</span>)</span>
<span id="cb1150-109"><a href="time-series.html#cb1150-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-110"><a href="time-series.html#cb1150-110" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit model </span></span>
<span id="cb1150-111"><a href="time-series.html#cb1150-111" aria-hidden="true" tabindex="-1"></a>  fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, fitting_data)</span>
<span id="cb1150-112"><a href="time-series.html#cb1150-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1150-113"><a href="time-series.html#cb1150-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># forecast with data want to predict with </span></span>
<span id="cb1150-114"><a href="time-series.html#cb1150-114" aria-hidden="true" tabindex="-1"></a>  forecasts <span class="ot">&lt;-</span> fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1150-115"><a href="time-series.html#cb1150-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">predict</span>(pred_data, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-116"><a href="time-series.html#cb1150-116" aria-hidden="true" tabindex="-1"></a>    <span class="do">## only keep the week and the forecast estimate</span></span>
<span id="cb1150-117"><a href="time-series.html#cb1150-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(epiweek, estimate)</span>
<span id="cb1150-118"><a href="time-series.html#cb1150-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1150-119"><a href="time-series.html#cb1150-119" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1150-120"><a href="time-series.html#cb1150-120" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1150-121"><a href="time-series.html#cb1150-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-122"><a href="time-series.html#cb1150-122" aria-hidden="true" tabindex="-1"></a><span class="do">## make the list in to a data frame with all the forecasts</span></span>
<span id="cb1150-123"><a href="time-series.html#cb1150-123" aria-hidden="true" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(forecasts)</span>
<span id="cb1150-124"><a href="time-series.html#cb1150-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-125"><a href="time-series.html#cb1150-125" aria-hidden="true" tabindex="-1"></a><span class="do">## join the forecasts with the observed</span></span>
<span id="cb1150-126"><a href="time-series.html#cb1150-126" aria-hidden="true" tabindex="-1"></a>forecasts <span class="ot">&lt;-</span> <span class="fu">left_join</span>(forecasts, </span>
<span id="cb1150-127"><a href="time-series.html#cb1150-127" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">select</span>(counts, epiweek, case_int),</span>
<span id="cb1150-128"><a href="time-series.html#cb1150-128" aria-hidden="true" tabindex="-1"></a>                       <span class="at">by =</span> <span class="st">&quot;epiweek&quot;</span>)</span>
<span id="cb1150-129"><a href="time-series.html#cb1150-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-130"><a href="time-series.html#cb1150-130" aria-hidden="true" tabindex="-1"></a><span class="do">## using {yardstick} compute metrics</span></span>
<span id="cb1150-131"><a href="time-series.html#cb1150-131" aria-hidden="true" tabindex="-1"></a>  <span class="do">## RMSE: Root mean squared error</span></span>
<span id="cb1150-132"><a href="time-series.html#cb1150-132" aria-hidden="true" tabindex="-1"></a>  <span class="do">## MAE:  Mean absolute error  </span></span>
<span id="cb1150-133"><a href="time-series.html#cb1150-133" aria-hidden="true" tabindex="-1"></a>  <span class="do">## MASE: Mean absolute scaled error</span></span>
<span id="cb1150-134"><a href="time-series.html#cb1150-134" aria-hidden="true" tabindex="-1"></a>  <span class="do">## MAPE: Mean absolute percent error</span></span>
<span id="cb1150-135"><a href="time-series.html#cb1150-135" aria-hidden="true" tabindex="-1"></a>model_metrics <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb1150-136"><a href="time-series.html#cb1150-136" aria-hidden="true" tabindex="-1"></a>  <span class="do">## in your forcasted dataset compare the observed to the predicted</span></span>
<span id="cb1150-137"><a href="time-series.html#cb1150-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rmse</span>(forecasts, case_int, estimate), </span>
<span id="cb1150-138"><a href="time-series.html#cb1150-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mae</span>( forecasts, case_int, estimate),</span>
<span id="cb1150-139"><a href="time-series.html#cb1150-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mase</span>(forecasts, case_int, estimate),</span>
<span id="cb1150-140"><a href="time-series.html#cb1150-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mape</span>(forecasts, case_int, estimate),</span>
<span id="cb1150-141"><a href="time-series.html#cb1150-141" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-142"><a href="time-series.html#cb1150-142" aria-hidden="true" tabindex="-1"></a>  <span class="do">## only keep the metric type and its output</span></span>
<span id="cb1150-143"><a href="time-series.html#cb1150-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">Metric  =</span> .metric, </span>
<span id="cb1150-144"><a href="time-series.html#cb1150-144" aria-hidden="true" tabindex="-1"></a>         <span class="at">Measure =</span> .estimate) <span class="sc">%&gt;%</span> </span>
<span id="cb1150-145"><a href="time-series.html#cb1150-145" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make in to wide format so can bind rows after</span></span>
<span id="cb1150-146"><a href="time-series.html#cb1150-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Metric, <span class="at">values_from =</span> Measure)</span>
<span id="cb1150-147"><a href="time-series.html#cb1150-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1150-148"><a href="time-series.html#cb1150-148" aria-hidden="true" tabindex="-1"></a><span class="do">## return model metrics </span></span>
<span id="cb1150-149"><a href="time-series.html#cb1150-149" aria-hidden="true" tabindex="-1"></a>model_metrics</span></code></pre></div>
<pre><code>## # A tibble: 1 x 4
##    rmse   mae  mase  mape
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  252.  199.  1.96  17.3</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="surveillance-package" class="section level3 unnumbered">
<h3><strong>surveillance</strong> package</h3>
<p>In this section we use the <strong>surveillance</strong> package to create alert thresholds
based on outbreak detection algorithms. There are several different methods
available in the package, however we will focus on two options here.
For details, see these papers on the <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/monitoringCounts.pdf">application</a>
and <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">theory</a>
of the alogirthms used.</p>
<p>The first option uses the improved Farrington method. This fits a negative
binomial glm (including trend) and down-weights past outbreaks (outliers) to
create a threshold level.</p>
<p>The second option use the glrnb method. This also fits a negative binomial glm
but includes trend and fourier terms (so is favoured here). The regression is used
to calculate the “control mean” (~fitted values) - it then uses a computed
generalized likelihood ratio statistic to assess if there is shift in the mean
for each week. Note that the threshold for each week takes in to account previous
weeks so if there is a sustained shift an alarm will be triggered.
(Also note that after each alarm the algorithm is reset)</p>
<p>In order to work with the <strong>surveillance</strong> package, we first need to define a
“surveillance time series” object (using the <code>sts()</code> function) to fit within the
framework.</p>
<div class="sourceCode" id="cb1152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1152-1"><a href="time-series.html#cb1152-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define surveillance time series object</span></span>
<span id="cb1152-2"><a href="time-series.html#cb1152-2" aria-hidden="true" tabindex="-1"></a><span class="do">## nb. you can include a denominator with the population object (see ?sts)</span></span>
<span id="cb1152-3"><a href="time-series.html#cb1152-3" aria-hidden="true" tabindex="-1"></a>counts_sts <span class="ot">&lt;-</span> <span class="fu">sts</span>(<span class="at">observed =</span> counts<span class="sc">$</span>case_int[<span class="sc">!</span><span class="fu">is.na</span>(counts<span class="sc">$</span>case_int)],</span>
<span id="cb1152-4"><a href="time-series.html#cb1152-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">start =</span> <span class="fu">c</span>(</span>
<span id="cb1152-5"><a href="time-series.html#cb1152-5" aria-hidden="true" tabindex="-1"></a>                    <span class="do">## subset to only keep the year from start_date </span></span>
<span id="cb1152-6"><a href="time-series.html#cb1152-6" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(start_date, <span class="dv">1</span>, <span class="dv">4</span>)), </span>
<span id="cb1152-7"><a href="time-series.html#cb1152-7" aria-hidden="true" tabindex="-1"></a>                    <span class="do">## subset to only keep the week from start_date</span></span>
<span id="cb1152-8"><a href="time-series.html#cb1152-8" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">as.numeric</span>(<span class="fu">str_sub</span>(start_date, <span class="dv">7</span>, <span class="dv">8</span>))), </span>
<span id="cb1152-9"><a href="time-series.html#cb1152-9" aria-hidden="true" tabindex="-1"></a>                  <span class="do">## define the type of data (in this case weekly)</span></span>
<span id="cb1152-10"><a href="time-series.html#cb1152-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">freq =</span> <span class="dv">52</span>)</span>
<span id="cb1152-11"><a href="time-series.html#cb1152-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1152-12"><a href="time-series.html#cb1152-12" aria-hidden="true" tabindex="-1"></a><span class="do">## define the week range that you want to include (ie. prediction period)</span></span>
<span id="cb1152-13"><a href="time-series.html#cb1152-13" aria-hidden="true" tabindex="-1"></a><span class="do">## nb. the sts object only counts observations without assigning a week or </span></span>
<span id="cb1152-14"><a href="time-series.html#cb1152-14" aria-hidden="true" tabindex="-1"></a><span class="do">## year identifier to them - so we use our data to define the appropriate observations</span></span>
<span id="cb1152-15"><a href="time-series.html#cb1152-15" aria-hidden="true" tabindex="-1"></a>weekrange <span class="ot">&lt;-</span> cut_off <span class="sc">-</span> start_date</span></code></pre></div>
<!-- ======================================================= -->
<div id="farrington-method" class="section level4 unnumbered">
<h4>Farrington method</h4>
<p>We then define each of our parameters for the Farrington method in a <code>list</code>.
Then we run the algorithm using <code>farringtonFlexible()</code> and then we can extract the
threshold for an alert using <code>farringtonmethod@upperbound</code>to include this in our
dataset. It is also possible to extract a TRUE/FALSE for each week if it triggered
an alert (was above the threshold) using <code>farringtonmethod@alarm</code>.</p>
<div class="sourceCode" id="cb1153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1153-1"><a href="time-series.html#cb1153-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define control</span></span>
<span id="cb1153-2"><a href="time-series.html#cb1153-2" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1153-3"><a href="time-series.html#cb1153-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define what time period that want threshold for (i.e. 2011)</span></span>
<span id="cb1153-4"><a href="time-series.html#cb1153-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">range =</span> <span class="fu">which</span>(counts_sts<span class="sc">@</span>epoch <span class="sc">&gt;</span> weekrange),</span>
<span id="cb1153-5"><a href="time-series.html#cb1153-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">b =</span> <span class="dv">9</span>, <span class="do">## how many years backwards for baseline</span></span>
<span id="cb1153-6"><a href="time-series.html#cb1153-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">w =</span> <span class="dv">2</span>, <span class="do">## rolling window size in weeks</span></span>
<span id="cb1153-7"><a href="time-series.html#cb1153-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">weightsThreshold =</span> <span class="fl">2.58</span>, <span class="do">## reweighting past outbreaks (improved noufaily method - original suggests 1)</span></span>
<span id="cb1153-8"><a href="time-series.html#cb1153-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## pastWeeksNotIncluded = 3, ## use all weeks available (noufaily suggests drop 26)</span></span>
<span id="cb1153-9"><a href="time-series.html#cb1153-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1153-10"><a href="time-series.html#cb1153-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">pThresholdTrend =</span> <span class="dv">1</span>, <span class="do">## 0.05 normally, however 1 is advised in the improved method (i.e. always keep)</span></span>
<span id="cb1153-11"><a href="time-series.html#cb1153-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">thresholdMethod =</span> <span class="st">&quot;nbPlugin&quot;</span>,</span>
<span id="cb1153-12"><a href="time-series.html#cb1153-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">populationOffset =</span> <span class="cn">TRUE</span></span>
<span id="cb1153-13"><a href="time-series.html#cb1153-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1153-14"><a href="time-series.html#cb1153-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1153-15"><a href="time-series.html#cb1153-15" aria-hidden="true" tabindex="-1"></a><span class="do">## apply farrington flexible method</span></span>
<span id="cb1153-16"><a href="time-series.html#cb1153-16" aria-hidden="true" tabindex="-1"></a>farringtonmethod <span class="ot">&lt;-</span> <span class="fu">farringtonFlexible</span>(counts_sts, ctrl)</span>
<span id="cb1153-17"><a href="time-series.html#cb1153-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1153-18"><a href="time-series.html#cb1153-18" aria-hidden="true" tabindex="-1"></a><span class="do">## create a new variable in the original dataset called threshold</span></span>
<span id="cb1153-19"><a href="time-series.html#cb1153-19" aria-hidden="true" tabindex="-1"></a><span class="do">## containing the upper bound from farrington </span></span>
<span id="cb1153-20"><a href="time-series.html#cb1153-20" aria-hidden="true" tabindex="-1"></a><span class="do">## nb. this is only for the weeks in 2011 (so need to subset rows)</span></span>
<span id="cb1153-21"><a href="time-series.html#cb1153-21" aria-hidden="true" tabindex="-1"></a>counts[<span class="fu">which</span>(counts<span class="sc">$</span>epiweek <span class="sc">&gt;=</span> cut_off <span class="sc">&amp;</span> </span>
<span id="cb1153-22"><a href="time-series.html#cb1153-22" aria-hidden="true" tabindex="-1"></a>               <span class="sc">!</span><span class="fu">is.na</span>(counts<span class="sc">$</span>case_int)),</span>
<span id="cb1153-23"><a href="time-series.html#cb1153-23" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;threshold&quot;</span>] <span class="ot">&lt;-</span> farringtonmethod<span class="sc">@</span>upperbound</span></code></pre></div>
<p>We can then visualise the results in ggplot as done previously.</p>
<div class="sourceCode" id="cb1154"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1154-1"><a href="time-series.html#cb1154-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1154-2"><a href="time-series.html#cb1154-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in observed case counts as a line</span></span>
<span id="cb1154-3"><a href="time-series.html#cb1154-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int, <span class="at">colour =</span> <span class="st">&quot;Observed&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1154-4"><a href="time-series.html#cb1154-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in upper bound of aberration algorithm</span></span>
<span id="cb1154-5"><a href="time-series.html#cb1154-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> threshold, <span class="at">colour =</span> <span class="st">&quot;Alert threshold&quot;</span>), </span>
<span id="cb1154-6"><a href="time-series.html#cb1154-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, </span>
<span id="cb1154-7"><a href="time-series.html#cb1154-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb1154-8"><a href="time-series.html#cb1154-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define colours</span></span>
<span id="cb1154-9"><a href="time-series.html#cb1154-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb1154-10"><a href="time-series.html#cb1154-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;Alert threshold&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1154-11"><a href="time-series.html#cb1154-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1154-12"><a href="time-series.html#cb1154-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb1154-13"><a href="time-series.html#cb1154-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## remove title of legend </span></span>
<span id="cb1154-14"><a href="time-series.html#cb1154-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_farrington-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="glrnb-method" class="section level4 unnumbered">
<h4>GLRNB method</h4>
<p>Similarly for the GLRNB method we define each of our parameters for the in a <code>list</code>,
then fit the algorithm and extract the upper bounds.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> This method uses “brute force” (similar to bootstrapping) for calculating thresholds, so can take a long time!</span></p>
<p>See the <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">GLRNB vignette</a>
for details.</p>
<div class="sourceCode" id="cb1155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1155-1"><a href="time-series.html#cb1155-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define control options</span></span>
<span id="cb1155-2"><a href="time-series.html#cb1155-2" aria-hidden="true" tabindex="-1"></a>ctrl <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1155-3"><a href="time-series.html#cb1155-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define what time period that want threshold for (i.e. 2011)</span></span>
<span id="cb1155-4"><a href="time-series.html#cb1155-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">range =</span> <span class="fu">which</span>(counts_sts<span class="sc">@</span>epoch <span class="sc">&gt;</span> weekrange),</span>
<span id="cb1155-5"><a href="time-series.html#cb1155-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">mu0 =</span> <span class="fu">list</span>(<span class="at">S =</span> <span class="dv">1</span>,    <span class="do">## number of fourier terms (harmonics) to include</span></span>
<span id="cb1155-6"><a href="time-series.html#cb1155-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trend =</span> <span class="cn">TRUE</span>,   <span class="do">## whether to include trend or not</span></span>
<span id="cb1155-7"><a href="time-series.html#cb1155-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">refit =</span> <span class="cn">FALSE</span>), <span class="do">## whether to refit model after each alarm</span></span>
<span id="cb1155-8"><a href="time-series.html#cb1155-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## cARL = threshold for GLR statistic (arbitrary)</span></span>
<span id="cb1155-9"><a href="time-series.html#cb1155-9" aria-hidden="true" tabindex="-1"></a>     <span class="do">## 3 ~ middle ground for minimising false positives</span></span>
<span id="cb1155-10"><a href="time-series.html#cb1155-10" aria-hidden="true" tabindex="-1"></a>     <span class="do">## 1 fits to the 99%PI of glm.nb - with changes after peaks (threshold lowered for alert)</span></span>
<span id="cb1155-11"><a href="time-series.html#cb1155-11" aria-hidden="true" tabindex="-1"></a>   <span class="at">c.ARL =</span> <span class="dv">2</span>,</span>
<span id="cb1155-12"><a href="time-series.html#cb1155-12" aria-hidden="true" tabindex="-1"></a>   <span class="co"># theta = log(1.5), ## equates to a 50% increase in cases in an outbreak</span></span>
<span id="cb1155-13"><a href="time-series.html#cb1155-13" aria-hidden="true" tabindex="-1"></a>   <span class="at">ret =</span> <span class="st">&quot;cases&quot;</span>     <span class="do">## return threshold upperbound as case counts</span></span>
<span id="cb1155-14"><a href="time-series.html#cb1155-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1155-15"><a href="time-series.html#cb1155-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1155-16"><a href="time-series.html#cb1155-16" aria-hidden="true" tabindex="-1"></a><span class="do">## apply the glrnb method</span></span>
<span id="cb1155-17"><a href="time-series.html#cb1155-17" aria-hidden="true" tabindex="-1"></a>glrnbmethod <span class="ot">&lt;-</span> <span class="fu">glrnb</span>(counts_sts, <span class="at">control =</span> ctrl, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1155-18"><a href="time-series.html#cb1155-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1155-19"><a href="time-series.html#cb1155-19" aria-hidden="true" tabindex="-1"></a><span class="do">## create a new variable in the original dataset called threshold</span></span>
<span id="cb1155-20"><a href="time-series.html#cb1155-20" aria-hidden="true" tabindex="-1"></a><span class="do">## containing the upper bound from glrnb </span></span>
<span id="cb1155-21"><a href="time-series.html#cb1155-21" aria-hidden="true" tabindex="-1"></a><span class="do">## nb. this is only for the weeks in 2011 (so need to subset rows)</span></span>
<span id="cb1155-22"><a href="time-series.html#cb1155-22" aria-hidden="true" tabindex="-1"></a>counts[<span class="fu">which</span>(counts<span class="sc">$</span>epiweek <span class="sc">&gt;=</span> cut_off <span class="sc">&amp;</span> </span>
<span id="cb1155-23"><a href="time-series.html#cb1155-23" aria-hidden="true" tabindex="-1"></a>               <span class="sc">!</span><span class="fu">is.na</span>(counts<span class="sc">$</span>case_int)),</span>
<span id="cb1155-24"><a href="time-series.html#cb1155-24" aria-hidden="true" tabindex="-1"></a>              <span class="st">&quot;threshold_glrnb&quot;</span>] <span class="ot">&lt;-</span> glrnbmethod<span class="sc">@</span>upperbound</span></code></pre></div>
<p>Visualise the outputs as previously.</p>
<div class="sourceCode" id="cb1156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1156-1"><a href="time-series.html#cb1156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(counts, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1156-2"><a href="time-series.html#cb1156-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in observed case counts as a line</span></span>
<span id="cb1156-3"><a href="time-series.html#cb1156-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int, <span class="at">colour =</span> <span class="st">&quot;Observed&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1156-4"><a href="time-series.html#cb1156-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in upper bound of aberration algorithm</span></span>
<span id="cb1156-5"><a href="time-series.html#cb1156-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> threshold_glrnb, <span class="at">colour =</span> <span class="st">&quot;Alert threshold&quot;</span>), </span>
<span id="cb1156-6"><a href="time-series.html#cb1156-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, </span>
<span id="cb1156-7"><a href="time-series.html#cb1156-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb1156-8"><a href="time-series.html#cb1156-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define colours</span></span>
<span id="cb1156-9"><a href="time-series.html#cb1156-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb1156-10"><a href="time-series.html#cb1156-10" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;Alert threshold&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1156-11"><a href="time-series.html#cb1156-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1156-12"><a href="time-series.html#cb1156-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb1156-13"><a href="time-series.html#cb1156-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## remove title of legend </span></span>
<span id="cb1156-14"><a href="time-series.html#cb1156-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="_main_files/figure-html/plot_glrnb-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="interrupted-timeseries" class="section level2" number="23.8">
<h2><span class="header-section-number">23.8</span> Interrupted timeseries</h2>
<p>Interrupted timeseries (also called segmented regression or intervention analysis),
is often used in assessing the impact of vaccines on the incidence of disease.
But it can be used for assessing impact of a wide range of interventions or introductions.
For example changes in hospital procedures or the introduction of a new disease
strain to a population.
In this example we will pretend that a new strain of Campylobacter was introduced
to Germany at the end of 2008, and see if that affects the number of cases.
We will use negative binomial regression again. The regression this time will be
split in to two parts, one before the intervention (or introduction of new strain here)
and one after (the pre and post-periods). This allows us to calculate an incidence rate ratio comparing the
two time periods. Explaining the equation might make this clearer (if not then just
ignore!).</p>
<p>The negative binomial regression can be defined as follows:</p>
<p><span class="math display">\[\log(Y_t)= β_0 + β_1 \times t+ β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+ + log(pop_t) + e_t\]</span></p>
<p>Where:
<span class="math inline">\(Y_t\)</span>is the number of cases observed at time <span class="math inline">\(t\)</span><br />
<span class="math inline">\(pop_t\)</span> is the population size in 100,000s at time <span class="math inline">\(t\)</span> (not used here)<br />
<span class="math inline">\(t_0\)</span> is the last year of the of the pre-period (including transition time if any)<br />
<span class="math inline">\(δ(x\)</span> is the indicator function (it is 0 if x≤0 and 1 if x&gt;0)<br />
<span class="math inline">\((x)^+\)</span> is the cut off operator (it is x if x&gt;0 and 0 otherwise)<br />
<span class="math inline">\(e_t\)</span> denotes the residual
Additional terms trend and season can be added as needed.</p>
<p><span class="math inline">\(β_2 \times δ(t-t_0) + β_3\times(t-t_0 )^+\)</span> is the generalised linear
part of the post-period and is zero in the pre-period.
This means that the <span class="math inline">\(β_2\)</span> and <span class="math inline">\(β_3\)</span> estimates are the effects of the intervention.</p>
<p>We need to re-calculate the fourier terms without forecasting here, as we will use
all the data available to us (i.e. retrospectively). Additionally we need to calculate
the extra terms needed for the regression.</p>
<div class="sourceCode" id="cb1157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1157-1"><a href="time-series.html#cb1157-1" aria-hidden="true" tabindex="-1"></a><span class="do">## add in fourier terms using the epiweek and case_int variabless</span></span>
<span id="cb1157-2"><a href="time-series.html#cb1157-2" aria-hidden="true" tabindex="-1"></a>counts<span class="sc">$</span>fourier <span class="ot">&lt;-</span> <span class="fu">select</span>(counts, epiweek, case_int) <span class="sc">%&gt;%</span> </span>
<span id="cb1157-3"><a href="time-series.html#cb1157-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tsibble</span>(<span class="at">index =</span> epiweek) <span class="sc">%&gt;%</span> </span>
<span id="cb1157-4"><a href="time-series.html#cb1157-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fourier</span>(<span class="at">K =</span> <span class="dv">1</span>)</span>
<span id="cb1157-5"><a href="time-series.html#cb1157-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1157-6"><a href="time-series.html#cb1157-6" aria-hidden="true" tabindex="-1"></a><span class="do">## define intervention week </span></span>
<span id="cb1157-7"><a href="time-series.html#cb1157-7" aria-hidden="true" tabindex="-1"></a>intervention_week <span class="ot">&lt;-</span> <span class="fu">yearweek</span>(<span class="st">&quot;2008-12-31&quot;</span>)</span>
<span id="cb1157-8"><a href="time-series.html#cb1157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1157-9"><a href="time-series.html#cb1157-9" aria-hidden="true" tabindex="-1"></a><span class="do">## define variables for regression </span></span>
<span id="cb1157-10"><a href="time-series.html#cb1157-10" aria-hidden="true" tabindex="-1"></a>counts <span class="ot">&lt;-</span> counts <span class="sc">%&gt;%</span> </span>
<span id="cb1157-11"><a href="time-series.html#cb1157-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1157-12"><a href="time-series.html#cb1157-12" aria-hidden="true" tabindex="-1"></a>    <span class="do">## corresponds to t in the formula</span></span>
<span id="cb1157-13"><a href="time-series.html#cb1157-13" aria-hidden="true" tabindex="-1"></a>      <span class="do">## count of weeks (could probably also just use straight epiweeks var)</span></span>
<span id="cb1157-14"><a href="time-series.html#cb1157-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># linear = row_number(epiweek), </span></span>
<span id="cb1157-15"><a href="time-series.html#cb1157-15" aria-hidden="true" tabindex="-1"></a>    <span class="do">## corresponds to delta(t-t0) in the formula</span></span>
<span id="cb1157-16"><a href="time-series.html#cb1157-16" aria-hidden="true" tabindex="-1"></a>      <span class="do">## pre or post intervention period</span></span>
<span id="cb1157-17"><a href="time-series.html#cb1157-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">intervention =</span> <span class="fu">as.numeric</span>(epiweek <span class="sc">&gt;=</span> intervention_week), </span>
<span id="cb1157-18"><a href="time-series.html#cb1157-18" aria-hidden="true" tabindex="-1"></a>    <span class="do">## corresponds to (t-t0)^+ in the formula</span></span>
<span id="cb1157-19"><a href="time-series.html#cb1157-19" aria-hidden="true" tabindex="-1"></a>      <span class="do">## count of weeks post intervention</span></span>
<span id="cb1157-20"><a href="time-series.html#cb1157-20" aria-hidden="true" tabindex="-1"></a>      <span class="do">## (choose the larger number between 0 and whatever comes from calculation)</span></span>
<span id="cb1157-21"><a href="time-series.html#cb1157-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_post =</span> <span class="fu">pmax</span>(<span class="dv">0</span>, epiweek <span class="sc">-</span> intervention_week <span class="sc">+</span> <span class="dv">1</span>))</span></code></pre></div>
<p>We then use these terms to fit a negative binomial regression, and produce a
table with percentage change. What this example shows is that there was no
significant change.</p>
<p><span style="color: orange;"><strong><em>CAUTION:</em></strong> Note the use of <code>simulate_pi = FALSE</code>
within the <code>predict()</code> argument. This is because the default behaviour of <strong>trending</strong>
is to use the <strong>ciTools</strong> package to estimate a prediction interval. This does not
work if there are <code>NA</code> counts, and also produces more granular intervals.
See <code>?trending::predict.trending_model_fit</code> for details. </span></p>
<div class="sourceCode" id="cb1158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1158-1"><a href="time-series.html#cb1158-1" aria-hidden="true" tabindex="-1"></a><span class="do">## define the model you want to fit (negative binomial) </span></span>
<span id="cb1158-2"><a href="time-series.html#cb1158-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">glm_nb_model</span>(</span>
<span id="cb1158-3"><a href="time-series.html#cb1158-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## set number of cases as outcome of interest</span></span>
<span id="cb1158-4"><a href="time-series.html#cb1158-4" aria-hidden="true" tabindex="-1"></a>  case_int <span class="sc">~</span></span>
<span id="cb1158-5"><a href="time-series.html#cb1158-5" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use epiweek to account for the trend</span></span>
<span id="cb1158-6"><a href="time-series.html#cb1158-6" aria-hidden="true" tabindex="-1"></a>    epiweek <span class="sc">+</span></span>
<span id="cb1158-7"><a href="time-series.html#cb1158-7" aria-hidden="true" tabindex="-1"></a>    <span class="do">## use the furier terms to account for seasonality</span></span>
<span id="cb1158-8"><a href="time-series.html#cb1158-8" aria-hidden="true" tabindex="-1"></a>    fourier <span class="sc">+</span> </span>
<span id="cb1158-9"><a href="time-series.html#cb1158-9" aria-hidden="true" tabindex="-1"></a>    <span class="do">## add in whether in the pre- or post-period </span></span>
<span id="cb1158-10"><a href="time-series.html#cb1158-10" aria-hidden="true" tabindex="-1"></a>    intervention <span class="sc">+</span> </span>
<span id="cb1158-11"><a href="time-series.html#cb1158-11" aria-hidden="true" tabindex="-1"></a>    <span class="do">## add in the time post intervention </span></span>
<span id="cb1158-12"><a href="time-series.html#cb1158-12" aria-hidden="true" tabindex="-1"></a>    time_post</span>
<span id="cb1158-13"><a href="time-series.html#cb1158-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1158-14"><a href="time-series.html#cb1158-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1158-15"><a href="time-series.html#cb1158-15" aria-hidden="true" tabindex="-1"></a><span class="do">## fit your model using the counts dataset</span></span>
<span id="cb1158-16"><a href="time-series.html#cb1158-16" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="ot">&lt;-</span> trending<span class="sc">::</span><span class="fu">fit</span>(model, counts)</span>
<span id="cb1158-17"><a href="time-series.html#cb1158-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1158-18"><a href="time-series.html#cb1158-18" aria-hidden="true" tabindex="-1"></a><span class="do">## calculate confidence intervals and prediction intervals </span></span>
<span id="cb1158-19"><a href="time-series.html#cb1158-19" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">predict</span>(fitted_model, <span class="at">simulate_pi =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1158-20"><a href="time-series.html#cb1158-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1158-21"><a href="time-series.html#cb1158-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1158-22"><a href="time-series.html#cb1158-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1158-23"><a href="time-series.html#cb1158-23" aria-hidden="true" tabindex="-1"></a><span class="do">## show estimates and percentage change in a table</span></span>
<span id="cb1158-24"><a href="time-series.html#cb1158-24" aria-hidden="true" tabindex="-1"></a>fitted_model <span class="sc">%&gt;%</span> </span>
<span id="cb1158-25"><a href="time-series.html#cb1158-25" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extract original negative binomial regression</span></span>
<span id="cb1158-26"><a href="time-series.html#cb1158-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_model</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1158-27"><a href="time-series.html#cb1158-27" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get a tidy dataframe of results</span></span>
<span id="cb1158-28"><a href="time-series.html#cb1158-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>(<span class="at">exponentiate =</span> <span class="cn">TRUE</span>, </span>
<span id="cb1158-29"><a href="time-series.html#cb1158-29" aria-hidden="true" tabindex="-1"></a>       <span class="at">conf.int =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1158-30"><a href="time-series.html#cb1158-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## only keep the intervention value </span></span>
<span id="cb1158-31"><a href="time-series.html#cb1158-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;intervention&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1158-32"><a href="time-series.html#cb1158-32" aria-hidden="true" tabindex="-1"></a>  <span class="do">## change the IRR to percentage change for estimate and CIs </span></span>
<span id="cb1158-33"><a href="time-series.html#cb1158-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb1158-34"><a href="time-series.html#cb1158-34" aria-hidden="true" tabindex="-1"></a>    <span class="do">## for each of the columns of interest - create a new column</span></span>
<span id="cb1158-35"><a href="time-series.html#cb1158-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(</span>
<span id="cb1158-36"><a href="time-series.html#cb1158-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">all_of</span>(<span class="fu">c</span>(<span class="st">&quot;estimate&quot;</span>, <span class="st">&quot;conf.low&quot;</span>, <span class="st">&quot;conf.high&quot;</span>)), </span>
<span id="cb1158-37"><a href="time-series.html#cb1158-37" aria-hidden="true" tabindex="-1"></a>      <span class="do">## apply the formula to calculate percentage change</span></span>
<span id="cb1158-38"><a href="time-series.html#cb1158-38" aria-hidden="true" tabindex="-1"></a>            <span class="at">.f =</span> <span class="cf">function</span>(i) <span class="dv">100</span> <span class="sc">*</span> (i <span class="sc">-</span> <span class="dv">1</span>), </span>
<span id="cb1158-39"><a href="time-series.html#cb1158-39" aria-hidden="true" tabindex="-1"></a>      <span class="do">## add a suffix to new column names with &quot;_perc&quot;</span></span>
<span id="cb1158-40"><a href="time-series.html#cb1158-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">.names =</span> <span class="st">&quot;{.col}_perc&quot;</span>)</span>
<span id="cb1158-41"><a href="time-series.html#cb1158-41" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb1158-42"><a href="time-series.html#cb1158-42" aria-hidden="true" tabindex="-1"></a>  <span class="do">## only keep (and rename) certain columns </span></span>
<span id="cb1158-43"><a href="time-series.html#cb1158-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="st">&quot;IRR&quot;</span> <span class="ot">=</span> estimate, </span>
<span id="cb1158-44"><a href="time-series.html#cb1158-44" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;95%CI low&quot;</span> <span class="ot">=</span> conf.low, </span>
<span id="cb1158-45"><a href="time-series.html#cb1158-45" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;95%CI high&quot;</span> <span class="ot">=</span> conf.high,</span>
<span id="cb1158-46"><a href="time-series.html#cb1158-46" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;Percentage change&quot;</span> <span class="ot">=</span> estimate_perc, </span>
<span id="cb1158-47"><a href="time-series.html#cb1158-47" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;95%CI low (perc)&quot;</span> <span class="ot">=</span> conf.low_perc, </span>
<span id="cb1158-48"><a href="time-series.html#cb1158-48" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;95%CI high (perc)&quot;</span> <span class="ot">=</span> conf.high_perc,</span>
<span id="cb1158-49"><a href="time-series.html#cb1158-49" aria-hidden="true" tabindex="-1"></a>         <span class="st">&quot;p-value&quot;</span> <span class="ot">=</span> p.value)</span></code></pre></div>
<pre><code>## # A tibble: 1 x 7
##       IRR `95%CI low` `95%CI high` `Percentage change` `95%CI low (perc)` `95%CI high (perc)` `p-value`
##     &lt;dbl&gt;       &lt;dbl&gt;        &lt;dbl&gt;               &lt;dbl&gt;              &lt;dbl&gt;               &lt;dbl&gt;     &lt;dbl&gt;
## 1 -0.0661      -0.135      0.00305               -107.              -113.               -99.7    0.0645</code></pre>
<p>As previously we can visualise the outputs of the regression.</p>
<div class="sourceCode" id="cb1160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1160-1"><a href="time-series.html#cb1160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(observed, <span class="fu">aes</span>(<span class="at">x =</span> epiweek)) <span class="sc">+</span> </span>
<span id="cb1160-2"><a href="time-series.html#cb1160-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in observed case counts as a line</span></span>
<span id="cb1160-3"><a href="time-series.html#cb1160-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> case_int, <span class="at">colour =</span> <span class="st">&quot;Observed&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1160-4"><a href="time-series.html#cb1160-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a line for the model estimate</span></span>
<span id="cb1160-5"><a href="time-series.html#cb1160-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> estimate, <span class="at">col =</span> <span class="st">&quot;Estimate&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1160-6"><a href="time-series.html#cb1160-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add in a band for the prediction intervals </span></span>
<span id="cb1160-7"><a href="time-series.html#cb1160-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_pi, </span>
<span id="cb1160-8"><a href="time-series.html#cb1160-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ymax =</span> upper_pi), </span>
<span id="cb1160-9"><a href="time-series.html#cb1160-9" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span> </span>
<span id="cb1160-10"><a href="time-series.html#cb1160-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add vertical line and label to show where forecasting started</span></span>
<span id="cb1160-11"><a href="time-series.html#cb1160-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb1160-12"><a href="time-series.html#cb1160-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">xintercept =</span> <span class="fu">as.Date</span>(intervention_week), </span>
<span id="cb1160-13"><a href="time-series.html#cb1160-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1160-14"><a href="time-series.html#cb1160-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">annotate</span>(<span class="at">geom =</span> <span class="st">&quot;text&quot;</span>, </span>
<span id="cb1160-15"><a href="time-series.html#cb1160-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">label =</span> <span class="st">&quot;Intervention&quot;</span>, </span>
<span id="cb1160-16"><a href="time-series.html#cb1160-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> intervention_week, </span>
<span id="cb1160-17"><a href="time-series.html#cb1160-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">y =</span> <span class="fu">max</span>(observed<span class="sc">$</span>upper_pi), </span>
<span id="cb1160-18"><a href="time-series.html#cb1160-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">angle =</span> <span class="dv">90</span>, </span>
<span id="cb1160-19"><a href="time-series.html#cb1160-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">vjust =</span> <span class="dv">1</span></span>
<span id="cb1160-20"><a href="time-series.html#cb1160-20" aria-hidden="true" tabindex="-1"></a>           ) <span class="sc">+</span> </span>
<span id="cb1160-21"><a href="time-series.html#cb1160-21" aria-hidden="true" tabindex="-1"></a>  <span class="do">## define colours</span></span>
<span id="cb1160-22"><a href="time-series.html#cb1160-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Observed&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>, </span>
<span id="cb1160-23"><a href="time-series.html#cb1160-23" aria-hidden="true" tabindex="-1"></a>                                 <span class="st">&quot;Estimate&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb1160-24"><a href="time-series.html#cb1160-24" aria-hidden="true" tabindex="-1"></a>  <span class="do">## make a traditional plot (with black axes and white background)</span></span>
<span id="cb1160-25"><a href="time-series.html#cb1160-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<pre><code>## Warning: Removed 13 row(s) containing missing values (geom_path).</code></pre>
<p><img src="_main_files/figure-html/plot_interrupted-1.png" width="672" /></p>
<!-- ======================================================= -->
</div>
<div id="resources-15" class="section level2" number="23.9">
<h2><span class="header-section-number">23.9</span> Resources</h2>
<p><a href="https://otexts.com/fpp3/">forecasting: principles and practice textbook</a><br />
<a href="https://github.com/EPIET/TimeSeriesAnalysis">EPIET timeseries analysis case studies</a><br />
<a href="https://online.stat.psu.edu/stat510/lesson/1">Penn State course</a>
<a href="https://www.jstatsoft.org/article/view/v070i10">Surveillance package manuscript</a></p>

</div>
</div>
  </main>

  <div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page">
      <h2>On this page</h2>
      <div id="book-on-this-page"></div>

      <div class="book-extra">
        <ul class="list-unstyled">
          <li><a id="book-source" href="#">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="#">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
      </div>
    </nav>
  </div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5">
  <div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Sổ tay dịch tễ học với R</strong>" was written by the handbook team. It was last built on 2021-06-15.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
